!function($,$Prototype,$$Prototype){"use strict";function hashKey(obj){var key,objType=typeof obj;return"object"==objType&&null!==obj?"function"==typeof(key=obj.$$hashKey)?key=obj.$$hashKey():void 0===key&&(key=obj.$$hashKey=nextUid()):key=obj,objType+":"+key}function HashQueueMap(){}function size(obj,ownPropsOnly){var key,size=0;if(angular.isArray(obj)||angular.isString(obj))return obj.length;if(angular.isObject(obj))for(key in obj)(!ownPropsOnly||obj.hasOwnProperty(key))&&size++;return size}function nextUid(){for(var digit,index=uid.length;index;){if(index--,digit=uid[index].charCodeAt(0),57==digit)return uid[index]="A",uid.join("");if(90!=digit)return uid[index]=String.fromCharCode(digit+1),uid.join("");uid[index]="0"}return uid.unshift("0"),uid.join("")}var mod=angular.module("app",["ngLocale","ngRoute","ngAnimate","app.chat","app.fuel","app.gamelist","app.loading","app.profile","app.about-pro","app.old-profile","app.admpanel","app.game","app.support","app.userpanel","local-conf","lib.dialogs","lib.ui.autoresize","lib.ui.jq","lib.ui.popover","lib.socket","lib.bo","lib.ui.edit-preview"]).directive("appStopClickPropagation",function(){return function($scope,element,attrs){element.click(function(e){if("~"==attrs.appStopClickPropagation.charAt(0)){var m=attrs.appStopClickPropagation.match(/^~(.*)$/);(!m[1]||$scope.$eval(m[1]))&&e.stopImmediatePropagation()}else(""==attrs.appStopClickPropagation||$scope.$eval(attrs.appStopClickPropagation))&&e.stopPropagation()})}}).directive("appStopPropagation",function(){return function($scope,element,attrs){element.bind(attrs.appStopPropagation,function(e){e.stopPropagation()})}}).directive("appClickAnimated",function($parse){return{scope:!0,link:function($scope,element,attrs){element.bind("click",function(event){element.addClass("striped"),element.attr("disabled","disabled"),$scope.$apply(function(){var resultPromise=$parse(attrs.appClickAnimated)($scope,{$event:event});resultPromise["finally"](function(){element.removeClass("striped"),element.removeAttr("disabled")})})})}}}).directive("appScatterEvenly",function(){return{transclude:!0,compile:function(tElm,tAttrs,transclude){var args=tAttrs.appScatterEvenly.split(/,/),scatterCnt=parseInt(args[0]),scatterExp=args[1];return function($scope,elm){for(var i=0;scatterCnt>i;i++)!function(i){var newScope=$scope.$new();$scope.$watch(scatterExp,function(data){newScope.$scatteredData=[];for(var colSize=Math.ceil(data.length/scatterCnt),j=colSize*i;colSize*(i+1)>j&&j<data.length;j++)newScope.$scatteredData.push(data[j])}),transclude(newScope,function(clone){elm.append(clone)})}(i)}}}}).directive("appSyncHeight",function($timeout){return function($scope,elm,attrs){$scope.$watch(attrs.appSyncHeight,function(){$timeout(function(){elm.css({height:elm.children().height()+40+"px"})},0)})}}).directive("appVisible",function(){return function($scope,elm,attrs){$scope.$watch(attrs.appVisible,function(value){elm.css({visibility:value?"visible":"hidden"})})}}).directive("appFloatFixed",function($window){return{controller:function(){this.isFloated=!1},link:function($scope,elm,attrs,ctrl){function update(){var offset=initOffset,top=0;$(".userpanel").hasClass("pinned")&&(top=$(".userpanel").height(),offset-=top),$($window).scrollTop()>offset?(elm.css({position:"fixed",top:top+"px"}),elm.addClass("fixed"),placeholder&&placeholder.show(),ctrl.isFloated||(ctrl.isFloated=!0,$scope.$apply())):(elm.css({position:initPosition,top:initTop}),elm.removeClass("fixed"),placeholder&&placeholder.hide(),ctrl.isFloated&&(ctrl.isFloated=!1,$scope.$apply()))}var placeholder,initOffset=elm.offset().top,initPosition=elm.css("position"),initTop=elm.css("top");elm.css("width",elm.css("width")),"absolute"!=elm.css("position")&&(placeholder=$("<div/>"),placeholder.css({width:elm.css("width"),height:elm.css("height"),marginBottom:elm.css("margin-bottom"),marginTop:elm.css("margin-top"),display:"none"}),elm.after(placeholder)),$window.addEventListener("scroll",update),update()}}}).directive("appFloatFixedTriggerShow",function($animate){return{require:"^appFloatFixed",link:function($scope,elm,attrs,ctrl){$scope.$watch(function(){return ctrl.isFloated},function(newVal){$animate[newVal?"removeClass":"addClass"](elm,"ng-hide")})}}}).directive("appHeightTriggerRoot",function(){return{restrict:"EA",controller:function(){}}}).directive("appHeightTrigger",function(){return{require:"^appHeightTriggerRoot",link:function($scope,elm,attrs,ctrl){$scope.$watch(attrs.appHeightTrigger,function(){ctrl.height=elm.height()}),elm.on("appHeightTrigger.update",function(){$scope.$apply(function(){ctrl.height=elm.height()})})}}}).directive("appHeightTriggerShow",function(){return{require:"^appHeightTriggerRoot",link:function($scope,elm,attrs,ctrl){$scope.$watch(function(){return ctrl.height>parseInt(attrs.appHeightTriggerShow)},function(val){elm.toggle(val)})}}}).directive("img",function(){return{restrict:"E",link:function($scope,elm){elm.load(function(){elm.trigger("appHeightTrigger.update")})}}}).directive("appBindHtmlCompiled",function($compile,$parse,$sce){return{link:function($scope,elm,attrs){function getStringValue(){return(parsed($scope)||"").toString()}var parsed=$parse(attrs.appBindHtmlCompiled);$scope.$watch(getStringValue,function(){var content=$compile(angular.element("<!-- appBindHtmlCompiled -->"+($sce.getTrustedHtml(parsed($scope))||"")))($scope);elm.html(""),elm.append(content)})}}}).directive("appUserAvatar",function(LocalConf){return{restrict:"E",templateUrl:"/views/partials/user-avatar.html?bust=1413116880766",scope:{user:"=",size:"@"},link:function($scope){$scope.LocalConf=LocalConf}}}).directive("appAutoScrollWatch",function(){return{priority:1e5,link:function($scope,elm,attrs){var boundToBottom=0;$scope.$watch(attrs.appAutoScrollWatch,function(){null!==boundToBottom&&setTimeout(function(){elm[0].scrollTop=elm[0].scrollHeight-elm.height()-boundToBottom,boundToBottom&&(boundToBottom=0)},0)}),elm.scroll(function(){(0===boundToBottom||null===boundToBottom)&&(boundToBottom=elm[0].scrollTop==elm[0].scrollHeight-elm.height()?0:null)}),$scope.$on("save scroll",function(){boundToBottom=elm[0].scrollHeight-elm.height()-elm[0].scrollTop})}}}).directive("appAutoScrollToLast",function(){return{link:function(){setTimeout(function(){},10)}}}).directive("appEnterSubmit",function(){return{link:function($scope,elm){elm.keydown(function(event){13==event.keyCode&&event.ctrlKey&&($(elm.get(0).form).submit(),event.preventDefault())})}}}).directive("appSubmit",function($parse){return{controller:function(){this.loadingCnt=!1},link:function($scope,elm,attrs,ctrl){elm.submit(function(event){event.preventDefault(),$scope.$apply(function(){var promise=$parse(attrs.appSubmit)($scope,{$event:event});promise&&promise.then&&(ctrl.loadingCnt=!0,promise["finally"](function(){ctrl.loadingCnt=!1}))})})}}}).directive("appSubmitAnimated",function(){return{require:"^appSubmit",link:function($scope,elm,attrs,ctrl){$scope.$watch(function(){return ctrl.loadingCnt},function(val){elm.toggleClass("striped",val),val?elm.attr("disabled","disabled"):elm.removeAttr("disabled")})}}}).directive("appAutofocus",function(){return{link:function($scope,elm,attrs){$scope.$eval(attrs.appAutofocus)&&setTimeout(function(){elm.focus()},10)}}}).directive("appPreventDefault",function(){return{link:function($scope,elm,attrs){elm.bind(attrs.appPreventDefault,function(event){event.preventDefault()})}}}).directive("appBbWidgets",function($timeout){return{link:function($scope,elm){$timeout(function(){initBBWidgets(elm[0],function(){elm.trigger("appHeightTrigger.update")})},0)}}}).directive("appPlayerCar",function(){return{restrict:"EA",templateUrl:"/views/partials/ui/player-car.html?bust=1413116880766",scope:{carDataExp:"&appPlayerCar"},link:function($scope){$scope.$watch($scope.carDataExp,function(newVal){$scope.carData=newVal},!0)}}}).directive("appColorpicker",function($timeout,$parse){return{link:function($scope,elm,attrs){$timeout(function(){var opts=$scope.$eval(attrs.appColorpicker),model=$parse(opts.model);opts.onChanged=function(newVal){$scope.$apply(function(){model.assign($scope,newVal)})},opts.startHex=model($scope);var cp=new Refresh.Web.ColorPicker(elm.attr("id"),opts);$scope.$on("$destroy",function(){cp.destroy()})},10)}}}).directive("appModelThrottled",function(){return{require:"ngModel",link:function($scope,elm,attr,ctrl){function update(){var value=elm.val();ctrl.$viewValue!==value&&$scope.$apply(function(){ctrl.$setViewValue(value)})}var throttledUpdate=_.throttle(update,1e3);elm.unbind("input").unbind("keydown").unbind("change"),elm.bind("keydown",function(e){13==e.keyCode?update():throttledUpdate(),$scope.$broadcast("appModelThrottled:update")}),elm.bind("input",function(){throttledUpdate(),$scope.$broadcast("appModelThrottled:update")}),elm.bind("blur",update)}}}).directive("appBenchmarkRepeat",function(){var time;return{priority:0,link:function($scope,elm){$scope.$first&&(time=new Date),$scope.$last&&(console.log(elm[0],"benchmark repeat: "+((new Date).getTime()-time.getTime())+"ms"),time=new Date)}}}).directive("appAutoTextSelect",function(){return{link:function($scope,elm){elm.click(function(){elm.select()})}}}).filter("readableDate",function($locale){return function(value){var now=new Date,time=new Date(value),today=new Date(now.getFullYear(),now.getMonth(),now.getDate(),0,0,0);if(time.getTime()>now.getTime()-6e4)return"Только что";if(time.getTime()>now.getTime()-36e5){var minutesAgo=Math.round((now.getTime()-time.getTime())/1e3/60);return $locale.plural(minutesAgo,"{} минуту","{} минуты","{} минут")+" назад"}if(time.getTime()>=today.getTime())return"Сегодня в "+sprintf("%02d:%02d",time.getHours(),time.getMinutes());if(time.getTime()>new Date(now.getFullYear(),now.getMonth(),now.getDate()-1,0,0,0).getTime())return"Вчера в "+sprintf("%02d:%02d",time.getHours(),time.getMinutes());if(time.getTime()>new Date(now.getFullYear(),now.getMonth(),now.getDate()-4,0,0,0).getTime()){var days=Math.round((today.getTime()-new Date(time.getFullYear(),time.getMonth(),time.getDate(),0,0,0))/24/3600/1e3);return days+" дня назад"}return time.format("dd.mm.yyyy")}}).filter("html",function(){return function(value){return value.replace(/\n/g,"<br>")}}).filter("marked",function($filter){return function(value,type){return type=type||"full",type=angular.uppercase(type.substring(0,1))+type.substring(1),$filter("marked"+type)(value)}}).filter("markedFull",function($sce,Smilies){var options=_.extend({},marked.defaults,{breaks:!0,sanitize:!0,code:!1}),lexer=new marked.Lexer(options),parser=new marked.Parser(options);return function(value){return value=parser.parse(lexer.lex(value)),value=Smilies.parse(value),$sce.trustAsHtml(value)}}).filter("markedLimited",function($sce,Smilies){var options=_.extend({},marked.defaults,{breaks:!0,sanitize:!0,images:!1,headings:!1,code:!1}),lexer=new marked.Lexer(options),parser=new marked.Parser(options);return function(value){return value=parser.parse(lexer.lex(value)),value=Smilies.parse(value),$sce.trustAsHtml(value)}}).filter("markedNoBlockquotes",function($sce,Smilies){var options=_.extend({},marked.defaults,{breaks:!0,sanitize:!0,images:!1,headings:!1,blockquotes:!1,code:!1}),lexer=new marked.Lexer(options),parser=new marked.Parser(options);return function(value){return value=parser.parse(lexer.lex(value)).replace(/<p>(.*?)<\/p>/g," $1 ").replace(/<br>/g," "),value=Smilies.parse(value),$sce.trustAsHtml(value)}}).filter("bust",function(){return function(val){return val+"?bust=1413116880766"}}).filter("timeFromSeconds",function(){return function(val){var sec=val%60,min=Math.floor(val/60);return 10>sec&&(sec="0"+sec),10>min&&(min="0"+min),min+":"+sec}}).filter("empty",function(){return function(val){if(_.isObject(val)){if(_.isArray(val))return 0==val.length;for(var i in val)return!1;return!0}return null===val||void 0===val}}).filter("trust",function($sce){return function(val){return $sce.trustAsHtml(val)}}).filter("dateFormat",function(){return function(date,format,utc){return date&&date instanceof Date?date.format(format,utc):void 0}}).factory("GametypeColors",function(){var GametypeColors={};return GametypeColors.colors={normal:"#333",sprint:"#833f3a",marathon:"#d43e68",noerror:"rgb(70, 146, 170)",abra:"rgb(61, 72, 86)",digits:"#777",referats:"rgb(105, 135, 37)",chars:"#b55900",voc:"#524ca7"},GametypeColors.getColor=function(gametype){return/^voc-/.test(gametype)?this.colors.voc:this.colors[gametype]},GametypeColors}).directive("appGametypeColor",function(GametypeColors){return{link:function($scope,elm,attrs){$scope.$watch(attrs.appGametypeColor,function(newVal){elm.css({color:GametypeColors.getColor(newVal)})})}}}).config(function($routeSegmentProvider){$routeSegmentProvider.options.autoLoadTemplates=!0});mod.run(function(Me,$rootScope,LocalConf,Socket,LocalStorage,Fuel,PageData,Dialogs,$q,$window){$rootScope.Me=Me,$rootScope._=_,$rootScope.LocalConf=LocalConf,"index"==PageData.rootAppModule&&Me&&!LocalStorage.get("alerts.fuel-vote")&&(LocalStorage.put("alerts.fuel-vote",1),Fuel.getUserVotes().then(function(votes){return votes.amount<=0?$q.reject():Dialogs.ask("Опрос","Вы недавно участвовали в Дозаправке, и у вас осталось <b>"+votes.amount+pluralForm(votes.amount," неиспользованный голос"," неиспользованных голоса"," неиспользованных голосов")+"</b>. Пожалуйста, примите участие в опросе, чтобы мы могли знать, какое направление развития проекта для вас более важно.")}).then(function(){$window.location.href="/fuel/#/vote"}))}),angular.module("app.about-pro",["app.fuel"]).controller("about-pro:BuyPro",function($scope,FuelDlgPayLauncher){$scope.onClick=function(){FuelDlgPayLauncher("premium")}}),angular.module("app.admpanel",["app.admpanel.mailings","app.admpanel.other"]).controller("admpanel:Main",function($scope,$routeSegment){$scope.$routeSegment=$routeSegment}),angular.module("app.admpanel.mailings",[]).config(function($routeSegmentProvider,PageData){"admpanel"==PageData.rootAppModule&&$routeSegmentProvider.when("/mailings","mailingsList").when("/mailings/new","mailing.index").when("/mailings/:id","mailing.index").when("/mailings/:id/send","mailing.send").segment("mailingsList",{templateUrl:"/views/partials/admpanel/mailingsList.html?bust=1413116880766",controller:"mailings:List",resolve:{data:function(MailingsListLoader){return MailingsListLoader.load()}}}).segment("mailing",{templateUrl:"/views/partials/admpanel/mailing.html?bust=1413116880766",controller:"mailings:Item as Item",resolve:{data:function(MailingLoader){return MailingLoader.load()}},dependencies:["id"]}).within().segment("index",{templateUrl:"/views/partials/admpanel/mailing-index.html?bust=1413116880766",controller:"mailings:Item.Index"}).segment("send",{templateUrl:"/views/partials/admpanel/mailing-send.html?bust=1413116880766",controller:"mailings:Item.Send"})}).factory("Mailing",function(Api){var Mailing={};return Mailing.getList=function(){return Api.get("mailings").then(function(response){return _.map(response,function(i){return i.id=i._id,Mailing.factory(i)})})},Mailing.get=function(id){return Api.get("mailings/get",{id:id}).then(function(response){return response.id=response._id,Mailing.factory(response)})},Mailing.factory=function(data){var instance=angular.extend({},data);return instance.body=instance.body||{},instance.save=function(){return Api.post("mailings/update?id="+this.id,instance)},instance.create=function(){return Api.post("mailings/insert",instance).then(function(response){instance.id=response._id})},instance.remove=function(){return Api.post("mailings/remove?id="+this.id)},instance.importUsers=function(){return Api.post("mailings/import-users?id="+this.id)},instance.start=function(){return Api.post("mailings/set-status?id="+this.id+"&status=active")},instance.stop=function(){return Api.post("mailings/set-status?id="+this.id+"&status=paused")},instance.sendTest=function(email){return Api.post("mailings/send-test?id="+this.id+"&email="+email)},instance},Mailing}).factory("MailingsListLoader",function(Mailing,Loader){return Loader.factory(function(){return{mailings:Mailing.getList()}})}).factory("MailingLoader",function(Mailing,Loader,$routeParams){return Loader.factory(function(){return $routeParams.id?{mailing:Mailing.get($routeParams.id)}:{mailing:Mailing.factory({})}})}).controller("mailings:List",function($scope,data,Mailing,$location){$scope.data=data,$scope.onMailingClick=function(mailing){$location.path("/mailings/"+mailing.id)},$scope.onCreate=function(){$location.path("/mailings/new")}}).controller("mailings:Item",function($scope,data,$routeSegment){$scope.data=data,$scope.$routeSegment=$routeSegment}).controller("mailings:Item.Index",function($scope,$location,$sce){$scope.onSave=function(){return $scope.data.mailing.id?$scope.data.mailing.save():$scope.data.mailing.create().then(function(){$location.path("/mailings/"+$scope.data.mailing.id)})},$scope.onRemove=function(){return $scope.data.mailing.id?$scope.data.mailing.remove().then(function(){$location.path("/mailings")}):void 0},$scope.$watch("data.mailing.body.markdown",function(val){val&&($scope.data.mailing.body.html=marked(val),$scope.data.body_html=$sce.trustAsHtml($scope.data.mailing.body.html))})}).controller("mailings:Item.Send",function($scope,MailingLoader){$scope.onImportUsers=function(){return $scope.data.mailing.importUsers().then(function(){MailingLoader.load()})},$scope.onStart=function(){return $scope.data.mailing.start().then(function(){MailingLoader.load()})},$scope.onStop=function(){return $scope.data.mailing.stop().then(function(){MailingLoader.load()})},$scope.onSendTest=function(){return $scope.data.mailing.sendTest($scope.data.testEmail)}}),angular.module("app.admpanel.other",[]).config(function($routeSegmentProvider,PageData){"admpanel"==PageData.rootAppModule&&$routeSegmentProvider.when("/other","other").segment("other",{templateUrl:"/views/partials/admpanel/other.html?bust=1413116880766"})}),angular.module("app.chat",["page","lib.socket","lib.directives","lib.local-storage"]).factory("ChatOptions",function(LocalStorage){return LocalStorage.createSyncedObj("chat.options",{left:200,right:200,panelMode:"users"})}).run(function(PageData,ChatOptions,$rootScope,Smilies){function xml2array(node){try{if(3==node.firstChild.nodeType)return node.textContent||node.text}catch(e){return{}}for(var result={},i=0;i<node.childNodes.length;i++)result[node.childNodes[i].tagName]=xml2array(node.childNodes[i]);return result}function getElementByAttribute(node,tagName,attr,value){for(var elems=node.getElementsByTagName(tagName),i=0;i<elems.length;i++)if(elems[i].getAttribute(attr)==value)return elems[i];return null}function setChatHeight(height){if(chat){for(var elems=$$Prototype("#chat-wrapper .messages-content"),i=0;i<elems.length;i++)elems[i].setStyle({height:height-66+"px"});elems=$$Prototype("#chat-wrapper .userlist-content, #chat-wrapper .smile-tab");for(var i=0;i<elems.length;i++)elems[i].setStyle({height:height-34+"px"});setPrefCookie(chat.params.game_id?"chat-game-height":"chat-general-height",height-6)}}function setChatWidth(left,right){$rootScope.$apply(function(){ChatOptions.left=left,ChatOptions.right=right})}function openSmileTab(){$$Prototype("#chat-wrapper .userlist-content").each(function(el){el.toggle()}),$$Prototype("#chat-wrapper .smile-tab").each(function(el){el.toggle()}),$$Prototype("#chat-wrapper .smile-btn").each(function(el){el.toggleClassName("active")})}function insertSmile(smile){var input=$Prototype("chat-"+chat.active_room).select("input.text").last();input.value+=":"+smile+":",input.focus()}function changeChatFilter(){chat&&(chat.filter=chat.filter?0:1,chat.filter?deletePrefCookie("no_chat_filter"):setPrefCookie("no_chat_filter",1),$$Prototype("#chat-wrapper .filter-btn").each(function(el){el.toggleClassName("active")}))}var chat=null,options=_.extend({},marked.defaults,{sanitize:!0,images:!1,headings:!1,paragraph:!1,lists:!1,hr:!1}),markedLexer=new marked.Lexer(options),markedParser=new marked.Parser(options),moderators=[21,123190,24119,7450,82885,150888,251006,263138,111001,5132,30297];window.recalcFixedChat=function(){if(chat&&!MSIE6&&"chat-inline-placeholder"!=$Prototype("chat-wrapper").parentNode.id){$Prototype(document.body).getHeight();var viewHeight=document.viewport.getHeight(),scroll=document.viewport.getScrollOffsets().top,offset=$Prototype("chat-wrapper").viewportOffset().top;Prototype.Browser.Opera&&(offset-=scroll),"undefined"!=typeof __buggyFixedPosition?($Prototype("chat-container").style.position="absolute",$Prototype("chat-container").style.top=scroll+viewHeight-$Prototype("chat-container").getHeight()+"px"):$Prototype("chat-container").style.bottom="0px";var height=getPrefCookie(chat.params.game_id?"chat-game-height":"chat-general-height");$Prototype("chat-place-eater").setStyle({marginTop:height-60+"px"}),$("#chat-place-eater").toggleClass("chat-hidden",$("#chat-wrapper").hasClass("chat-hidden")),$("#chat-container").css({height:parseInt(height)+6+"px",left:ChatOptions.left+"px",right:ChatOptions.right+"px"})}},window.toggleChatVisible=function(){chat&&"chat-inline-placeholder"!=$Prototype("chat-wrapper").parentNode.id&&($Prototype("chat-wrapper").toggleClassName("chat-hidden"),$("#chat-place-eater").toggleClass("chat-hidden"),chat.params.game_id?setPrefCookie("chat-game-hide",$Prototype("chat-wrapper").hasClassName("chat-hidden")):setPrefCookie("chat-general-hide",$Prototype("chat-wrapper").hasClassName("chat-hidden")),recalcFixedChat(),$Prototype("chat-wrapper").hasClassName("chat-hidden")&&(chat.resize&&(chat.resize.destroy(),delete chat.resize),"general"==chat.active_room&&chat.leaveRoom("general"),$$Prototype("#chat-title .mostright").last().title="Развернуть"),$Prototype("chat-wrapper").hasClassName("chat-hidden")||("general"==chat.active_room?chat.enterRoom("general"):($$Prototype("#chat-title .game.c span").last().removeClassName("new"),chat.blink_new_ingame&&(clearInterval(chat.blink_new_ingame),chat.blink_new_ingame=null)),$$Prototype("#chat-title .mostright").last().title="Cвернуть",chat.createResize()))},window.toggleChatFixed=function(){chat&&($Prototype("chat-wrapper").hasClassName("chat-hidden")||("chat-inline-placeholder"==$Prototype("chat-wrapper").parentNode.id?($Prototype("chat-fixed-placeholder").appendChild($Prototype("chat-inline-placeholder").removeChild($Prototype("chat-wrapper"))),$Prototype("chat-inline-placeholder").hide(),$Prototype("chat-place-eater").show(),setPrefCookie("inline_chat",!1),chat.createResize()):($Prototype("chat-inline-placeholder").show(),$Prototype("chat-inline-placeholder").appendChild($Prototype("chat-fixed-placeholder").removeChild($Prototype("chat-wrapper"))),$Prototype("chat-place-eater").hide(),setPrefCookie("inline_chat",!0),chat.resize&&(chat.resize.destroy(),delete chat.resize),setChatHeight(180,!0)),recalcFixedChat()))},window.chatLeaveRoom=function(room){chat&&chat.leaveRoom(room)};var Chat=function(params){this.params=params,this.user_list=new Object,this.user_data=new Object,this.unvoiced=new Object,this.cached_user_ids=new Object,this.cached_user_status=!1,this.cached_user_ids_checked=[],this.resize=null,this.connected=!1,this.blink_new_ingame=null,this.user_list_dirty=new Object,this.real_jids=new Object,this.role=new Object,this.filter=1,getPrefCookie("no_chat_filter")&&(this.filter=0),this.params.user&&(this.params.user.background="#"==this.params.user.background.charAt(0)?colortools.capByBrightness(this.params.user.background):"black"),this.rooms=["general"],this.params.game_id?(this.rooms.push("game"+this.params.game_id),this.active_room="game"+this.params.game_id,this.changeActiveRoom("game"+this.params.game_id)):(this.active_room="general",this.changeActiveRoom("general")),recalcFixedChat(),$$Prototype("#chat-title .mostright").last().observe("click",toggleChatVisible),"undefined"!=typeof this.params.game_id&&$$Prototype("#chat-title .pin").last().observe("click",toggleChatFixed),$$Prototype("#chat-title .dummy .hide-bar").last().observe("click",toggleChatVisible)};Chat.prototype.connect=function(){var _this=this;this.connection=new Strophe.Connection("/xmpp-httpbind/");var jid="anon.jabber.klavogonki.ru/web";this.params.user&&(jid=this.params.user.id+"@jabber.klavogonki.ru/web"),this.connection.connect(jid,this.params.pass,function(status){_this.onConnect(status)}),this.connection.rawInput=function(data){/\<body\s+type=['"]terminate['"]/.test(data)&&(_this.connection.connect(jid,_this.params.pass,function(status){_this.onConnect(status),_this.params.game_id&&"general"==_this.active_room&&_this.enterRoom("general"),_this.changeActiveRoom(_this.active_room)}),_this.connected=!1)}},Chat.prototype.changedPrivileges=function(room){this.params&&this.params.user?"visitor"!=this.role[room]?($$Prototype("#chat-"+room+" .messages input").each(function(el){el.disabled=!1}),$$Prototype("#chat-"+room+" .messages input.text").each(function(el){el.value=""})):($$Prototype("#chat-"+room+" .messages input").each(function(el){el.disabled=!0}),$$Prototype("#chat-"+room+" .messages input.text").each(function(el){el.value="Вы не можете отправлять сообщения в этот чат"})):($$Prototype("#chat-"+room+" .messages input").each(function(el){el.disabled=!0}),$$Prototype("#chat-"+room+" .messages input.text").each(function(el){el.value="Только зарегистрированные пользователи могут отправлять сообщения в чат"}))},Chat.prototype.onConnect=function(status){if(status==Strophe.Status.DISCONNECTED||status==Strophe.Status.CONNFAIL){var info_txt="Связь с сервером потеряна.";this.params.game_id||(info_txt+=" Пожалуйста, перезагрузите страницу."),this.connected=!1,$$Prototype("#chat-general .messages input").each(function(el){el.disabled=!0}),$$Prototype("#chat-general .messages input.text").each(function(el){el.value=info_txt}),this.params.game_id&&($$Prototype("#chat-game"+this.params.game_id+" .messages input").each(function(el){el.disabled=!0}),$$Prototype("#chat-game"+this.params.game_id+" .messages input.text").each(function(el){el.value=info_txt}))}else if(status==Strophe.Status.CONNECTED){this.connected||this.changedPrivileges("general"),this.connected=!0;var _this=this;this.connection.addHandler(function(msg){return _this.onMessage(msg)},null,"message",null,null,null),this.connection.addHandler(function(msg){return _this.onPresence(msg)},null,"presence",null,null,null);for(var i=0;i<this.rooms.length;i++)$Prototype("chat-"+this.rooms[i]).select("input.send").last().observe("click",function(_this,i){return function(){_this.sendMsg(_this.rooms[i])}}(_this,i));if(this.params.game_id?this.enterRoom("game"+this.params.game_id):$Prototype("chat-wrapper").hasClassName("chat-hidden")||this.enterRoom("general"),this.params.game_id&&($$Prototype("#chat-title .general.c").last().observe("click",function(){_this.enterRoom("general"),_this.changeActiveRoom("general")}),$$Prototype("#chat-title .game.c").last().observe("click",function(){_this.leaveRoom("general"),_this.changeActiveRoom("game"+_this.params.game_id)})),this.userlist_update_interval=setInterval(function(){for(var i in _this.rooms){var room=_this.rooms[i];_this.user_list_dirty[room]&&(_this.updateUserList(room),_this.user_list_dirty[room]=!1)}},2e3),this.params.user)for(var els=$$Prototype("#chat-wrapper .send"),i=0;i<els.length;i++)els[i].disabled=!1}},Chat.prototype.changeActiveRoom=function(room){if(this.connected||room==this.active_room){if(this.active_room&&$Prototype("chat-"+this.active_room).hide(),this.active_room=room,$Prototype("chat-"+this.active_room).show(),"general"==room){$$Prototype("#chat-general .messages > div > div").last().update(""),$$Prototype("#chat-general .userlist-content").last().update("");for(var elems=$$Prototype("#chat-title .game"),i=0;i<elems.length;i++)elems[i].removeClassName("active");for(var elems=$$Prototype("#chat-title .general"),i=0;i<elems.length;i++)elems[i].addClassName("active")}else{for(var elems=$$Prototype("#chat-title .general"),i=0;i<elems.length;i++)elems[i].removeClassName("active");for(var elems=$$Prototype("#chat-title .game"),i=0;i<elems.length;i++)elems[i].addClassName("active");this.blink_new_ingame&&(clearInterval(this.blink_new_ingame),this.blink_new_ingame=null),$$Prototype("#chat-title .game.c span").last().removeClassName("new")}this.params.game_id&&setPrefCookie("chat_active_room","general"==room?"general":"game"),this.resize&&(this.resize.destroy(),delete this.resize),this.createResize()}},Chat.prototype.createResize=function(){$Prototype("chat-wrapper").hasClassName("chat-hidden")||"chat-inline-placeholder"!=$Prototype("chat-wrapper").parentNode.id&&(this.resize=new Resizeable($$Prototype("#chat-container").last(),{maxHeight:400,minHeight:100,minWidth:370,top:5,right:5,left:5,bottom:-100,resize:function(el){setChatHeight(el.getHeight(),!0),setChatWidth(parseInt(el.getStyle("left")),parseInt(el.getStyle("right"))),recalcFixedChat()},update:function(el){setChatHeight(el.getHeight())}}))},Chat.prototype.getXUserdata=function(){var data=$build("x",{xmlns:"klavogonki:userdata"});data.c("user");for(var k in this.params.user)"string"==typeof this.params.user[k]&&data.c(k).t(this.params.user[k]).up();return this.params.game_id&&data.up().c("game_id").t(this.params.game_id),data},Chat.prototype.enterRoom=function(room){if(this.connected){var pres=$pres({from:this.connection.jid,to:room+"@conference.jabber.klavogonki.ru/"+Strophe.getNodeFromJid(this.connection.jid)}).c("x",{xmlns:"http://jabber.org/protocol/muc"}).up();this.params.user&&pres.cnode(this.getXUserdata().tree()),this.connection.send(pres.tree()),this.user_list[room]=[]}},Chat.prototype.leaveRoom=function(room){this.connected&&(this.connection.send($pres({from:this.connection.jid,to:room+"@conference.jabber.klavogonki.ru/"+Strophe.getNodeFromJid(this.connection.jid),type:"unavailable"}).tree()),$$Prototype("#chat-"+room+" .messages > div > div").last().update(""),$$Prototype("#chat-"+room+" .userlist-content").last().update(""))},Chat.prototype.sendPrivateMsg=function(user_id,msg,display){var user_name=this.cached_user_ids[user_id].login;this.connection.send($msg({from:Strophe.getNodeFromJid(this.connection.jid)+"@jabber.klavogonki.ru/web",to:user_id+"@jabber.klavogonki.ru/web",type:"chat"}).c("body").t(msg).up().cnode(this.getXUserdata().tree()).tree()),display&&(this.addMsgInList({room:this.active_room,text:msg,user_id:this.params.user.id,time:new Date,type:"private",to:user_name,to_id:user_id}),$Prototype("chat-"+this.active_room).select("input.text").last().value="<"+user_name+">")},Chat.prototype.loadCacheUsers=function(){if(this.cached_user_ids={},localStorage&&JSON)try{this.cached_user_ids=JSON.parse(localStorage.chat_cached_user_ids);var time=(new Date).getTime(),period=2592e6;for(var i in this.cached_user_ids)this.cached_user_ids[i].update+period>time&&this.cached_user_ids_checked.push(i)}catch(e){this.cached_user_ids={},this.saveCacheUsers()}},Chat.prototype.saveCacheUsers=function(){localStorage&&JSON&&(localStorage.chat_cached_user_ids=JSON.stringify(this.cached_user_ids))},Chat.prototype.sendMsg=function(room){if(this.connected){var _this=this,msg=$Prototype("chat-"+room).select("input.text").last().value;if(msg=msg.replace(/^ +$/,""),0!=msg.length){var to,type,m=msg.match(/^<(.*?)>(.*)$/);if(msg=msg.replace(/</g,"&lt;"),msg=msg.replace(/>/g,"&gt;"),msg=msg.replace(/&/g,"&amp;"),m){this.cached_user_status||(this.cached_user_status=!0,this.loadCacheUsers()),msg=m[2];var found_user_id=null;for(var i in this.cached_user_ids)if(this.cached_user_ids[i].login==m[1]){found_user_id=i;break}if(found_user_id&&(this.sendPrivateMsg(found_user_id,msg,!0),-1!=this.cached_user_ids_checked.indexOf(found_user_id)))return;new Ajax.Request("/.fetchuser",{parameters:{login:m[1]},onSuccess:function(transport){var json;return JSON?json=JSON.parse(transport.responseText):eval("json="+transport.responseText+";"),json.id?(json.id=json.id.toString(),found_user_id?json.id!=found_user_id&&(delete _this.cached_user_ids[found_user_id],_this.cached_user_ids[json.id]={},_this.cached_user_ids[json.id].login=m[1],_this.cached_user_ids[json.id].update=(new Date).getTime(),_this.saveCacheUsers(),_this.sendPrivateMsg(json.id,msg,!1)):(_this.cached_user_ids[json.id]={},_this.cached_user_ids[json.id].login=m[1],_this.cached_user_ids[json.id].update=(new Date).getTime(),_this.saveCacheUsers(),_this.sendPrivateMsg(json.id,msg,!0)),_this.cached_user_ids_checked.push(json.id),void 0):(popalert("Пользователь с таким именем не найден."),void 0)
}})}else $Prototype("chat-"+room).select("input.text").last().value="",this.connection.send($msg({from:this.connection.jid,to:room+"@conference.jabber.klavogonki.ru",type:"groupchat"}).c("body").t(msg).up().cnode(this.getXUserdata().tree()).tree())}}},Chat.prototype.onMessage=function(msg){try{msg.getAttribute("to");var room,from=msg.getAttribute("from"),elems=msg.getElementsByTagName("body");if(elems.length>0){var user_id,type,body=elems[0];if("groupchat"==msg.getAttribute("type"))type="normal",user_id=Strophe.getResourceFromJid(from),room=Strophe.getNodeFromJid(from);else if(type="private",user_id=Strophe.getNodeFromJid(from),room=this.active_room,!this.real_jids[user_id]||/@anon/.test(this.real_jids[user_id]))return!0;var x=getElementByAttribute(msg,"x","xmlns","klavogonki:userdata");if(x){var data=xml2array(x);data.user&&(data.user=this.filterUserData(data.user),this.user_data[user_id]=data)}if(!this.user_data[user_id])return!0;var x,time=new Date;if(x=getElementByAttribute(msg,"x","xmlns","jabber:x:delay")){var m=x.getAttribute("stamp").match(/(\d{4})(\d{2})(\d{2})T(\d{2}):(\d{2}):(\d{2})/);time=new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]))}this.addMsgInList({room:room,text:Strophe.getText(body),user_id:user_id,time:time,type:type})}}catch(e){this.params.user&&82885==this.params.user.id&&(console.log("onMessage error:"),console.log(msg))}return!0},Chat.prototype.addMsgInList=function(args){if(!(args.user_id.length>7)){var _this=this,user=this.user_data[args.user_id].user,time=args.time.getHours().format()+":"+args.time.getMinutes().format()+":"+args.time.getSeconds().format(),room_html="";"game"==args.type&&(room_html="<span class=room>[заезд]</span>"),"private"==args.type&&(room_html=args.to?'<a class="room private">[шепчет '+args.to+"]</a>":'<a class="room private">[шепчет вам]</a>');var cont_outer=$Prototype("chat-"+args.room).select(".messages > div").last(),cont=$Prototype("chat-"+args.room).select(".messages > div > div").last(),needScroll=cont_outer.scrollTop+cont_outer.getHeight()>=cont_outer.scrollHeight;if(args.text=args.text.substr(0,5e3),args.text=args.text.replace(/</g,"&lt;"),args.text=args.text.replace(/>/g,"&gt;"),args.text=" "+args.text+" ",args.text=args.text.replace(/вики\:([^";&: ]+) /,'<a target=_blank href="http://klavogonki.ru/wiki/$1">$1</a>'),this.filter){var replace_str="$1~CENS~";args.text=args.text.replace(/­/g,""),args.text=" "+args.text+" ",args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*[хx?]+[уy]+[eеийяё]+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[хx?]+[уy]+ю+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*м+у+д+[^рс]+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*[аеeoиоуыьъ]+[eеё]+б+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[eеё]+б+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*п+[иeеё]+[cсз]+д+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*б+л+я+д+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])б+л+я+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*п+и+д+[оеаeo]+[рp]+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[а-яА-Я]*г+[aoао]+в+[eеё]*н+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str),args.text=args.text.replace(/([^а-яА-Я])[cс]+ц*у+[кч]+[eеaoаои]+[а-яА-Я]*(?=[^а-яА-Я])/gi,replace_str)}for(args.text=args.text.trim();/([^ ­]{10,})([^ ­]{10,})/.test(args.text);)args.text=args.text.replace(/([^ ­]{10,})([^ ­]{10,})/,"$1­$2");args.text=markedParser.parse(markedLexer.lex(args.text)),args.text=args.text.replace(/<[^>]+>/g,function(str){return str.replace(/­/g,"")}),args.text=args.text.replace(/<a href="(.*?)">(.*?)<\/a>/g,function(str,match){var m;return(m=match.match(/^http:\/\/klavogonki\.ru\/g\/\?gmid=(\d+)$/))?'[<a class="gamelink-not-resolved gamelink-'+m[1]+'" href="/g/?gmid='+m[1]+'">Заезд #'+m[1]+"</a>]":(/^https?:\/\//.test(match)||(str=str.replace(match,"http://"+match)),str.replace(/<a /,'<a target="_blank" '))}),args.text=args.text.replace(/­/g,"<wbr/>"),args.text=args.text.replace(/~CENS~/g,'<span class="censored">[вырезано]</span>'),args.text=Smilies.parse(args.text),args.text=args.text.replace(/script/g,"sсript");var $el;$el="system"==args.type?$("<p><span class=time>["+time+"]</span><span class=system-message>Пользователь "+user.login+" "+args.text+"</span></p>"):"private"==args.type?$("<p><span class=time>["+time+']</span><span class=username style="color:'+user.background+'">&lt;<span data-user="'+args.user_id+'">'+user.login+"</span>&gt;</span>"+room_html+"<span class=private>"+args.text+"</span></p>"):"324864"==args.user_id?$("<p><span class=time>["+time+"]</span><span class=system-message>&lt;Клавобот&gt; "+room_html+args.text+"</span></p>"):args.text.match(/^\/me/)?$("<p><span class=time>["+time+"]</span><span class=system-message>"+user.login+" "+args.text.replace("/me","")+"</span></p>"):$("<p><span class=time>[<span>"+time+'</span>]</span><span class=username style="color:'+user.background+'">&lt;<span data-user="'+args.user_id+'">'+user.login+"</span>&gt;</span>"+room_html+args.text+"</p>"),"private"==args.type&&$el.find(".room").click(function(){args.to?_this.insertPrivate(args.to_id):_this.insertPrivate(args.user_id)}),$el.find(".username span").click(function(e){var user_id=this.getAttribute("data-user");e.ctrlKey?(window.open("http://klavogonki.ru/profile/"+user_id),window.focus()):e.altKey&&_this.params.user.moderator?_this.kick(user_id):_this.insertPrefix(user_id)}),"general"==args.room&&$el.find(".time span").addClass("clickable").click(function(){window.open("http://klavogonki.ru/chatlogs/"+args.time.getFullYear()+"-"+(args.time.getMonth()+1).format()+"-"+args.time.getDate().format()+".html#"+time,"_blank"),window.focus()}),cont.insert($el.get(0));for(var links=cont.select(".gamelink-not-resolved"),i=0;i<links.length;i++){for(var m=links[i].className.match(/gamelink-(\d+)/),els=$$Prototype(".gamelink-not-resolved.gamelink-"+m[1]),j=0;j<els.length;j++)els[j].removeClassName("gamelink-not-resolved");new Ajax.Request("/ajax/fetchgameinfo",{method:"get",parameters:{game:m[1]},onSuccess:function(transport){var json;eval("json="+transport.responseText+";");var text="";if("practice"!=json.type){"private"==json.type&&(text="Игра с друзьями "),"normal"==json.type&&(text="Открытая игра "),json.competition&&(text="Соревнование ",json.regular_competition&&(text+="(x"+json.regular_competition+") ")),text+=json.gametype_html;for(var els=$$Prototype(".gamelink-"+json.game_id),j=0;j<els.length;j++)els[j].update(text)}}})}needScroll&&(cont_outer.scrollTop=cont_outer.scrollHeight),"general"==args.room||"general"!=this.active_room&&!$Prototype("chat-wrapper").hasClassName("chat-hidden")||null!=this.blink_new_ingame||(this.blink_new_ingame=setInterval(function(){$$Prototype("#chat-title .game.c span").last().toggleClassName("new")},500))}},Chat.prototype.onPresence=function(msg){try{if(!/^[a-z0-9_-]+@conference.jabber.klavogonki.ru\/\d+$/.test(msg.getAttribute("from")))return!0;var user_id=Strophe.getResourceFromJid(msg.getAttribute("from")),room=Strophe.getNodeFromJid(msg.getAttribute("from"));this.real_jids[user_id]="";var x=getElementByAttribute(msg,"x","xmlns","http://jabber.org/protocol/muc#user");if(x){var items=x.getElementsByTagName("item");if(items.length){var jid=items[0].getAttribute("jid");if(jid&&(this.real_jids[user_id]=jid,/@anon/.test(jid)))return!0}}if(void 0==this.user_list[room]&&(this.user_list[room]=[]),"unavailable"==msg.getAttribute("type"))-1!=this.user_list[room].indexOf(user_id)&&this.user_list[room].splice(this.user_list[room].indexOf(user_id),1),this.user_list_dirty[room]=!0;else if("error"==msg.getAttribute("type"));else{if(-1==this.user_list[room].indexOf(user_id)){var x=getElementByAttribute(msg,"x","xmlns","klavogonki:userdata");if(x){var data=xml2array(x);data.user&&(data.user=this.filterUserData(data.user),this.user_data[user_id]=data,this.user_list[room].push(user_id),this.user_list_dirty[room]=!0)}else this.user_data[user_id]={user:{login:Strophe.getNodeFromJid(this.real_jids[user_id]),background:"#000000"}},this.user_list[room].push(user_id),this.user_list_dirty[room]=!0;if(user_id==Strophe.getNodeFromJid(this.connection.jid)){x=getElementByAttribute(msg,"x","xmlns","http://jabber.org/protocol/muc#user");var item=x.childNodes[0];this.role[room]=item.getAttribute("role")}}if(x=getElementByAttribute(msg,"x","xmlns","http://jabber.org/protocol/muc#user")){var item=x.getElementsByTagName("item");"visitor"==item[0].getAttribute("role")&&(this.params.user&&user_id==this.params.user.id&&(this.role[room]="visitor",this.changedPrivileges(room)),this.unvoiced[user_id]=!0,this.updateUserList(room)),"participant"==item[0].getAttribute("role")&&(this.params.user&&user_id==this.params.user.id&&(this.role[room]="participant",this.changedPrivileges(room)),this.unvoiced[user_id]=!1,this.updateUserList(room))}}}catch(e){this.params.user&&82885==this.params.user.id&&(console.log("onPresence error:"),console.log(msg))}return!0},Chat.prototype.updateUserList=function(room){var _this=this;this.user_list[room].sort(function(a,b){if(!_this.user_data[a]||!_this.user_data[a].user||!_this.user_data[a].user.login)return 0;if(!_this.user_data[b]||!_this.user_data[b].user||!_this.user_data[b].user.login)return 0;var a_login=String.prototype.toLowerCase?_this.user_data[a].user.login.toLowerCase():_this.user_data[a].user.login,b_login=String.prototype.toLowerCase?_this.user_data[b].user.login.toLowerCase():_this.user_data[b].user.login;return b_login>a_login?-1:a_login>b_login?1:0});var html="";for(var i in this.user_list[room]){var user_id=this.user_list[room][i];if(!("function"==typeof user_id||user_id.toString().length>7)&&"21"!=user_id&&"324864"!=user_id){var item=this.user_data[user_id],avatar_html="";item.user.avatar&&(avatar_html='style="background: transparent url('+item.user.avatar+') no-repeat 0% 0%"');var game_html="";item.game_id&&"general"==room&&(game_html="в игре");var moderator_tools="";"general"==room&&this.params.user&&-1!=moderators.indexOf(this.params.user.id)&&(moderator_tools=' <div class=moderator-tools><a class=kick-btn data-user="'+user_id+'">&times;</a></div>');var icons='<a class=info title="Профиль" href="/profile/'+Strophe.getNodeFromJid(this.real_jids[user_id])+'/"><img src="/img/information-small.png"></a>';-1!=moderators.indexOf(parseInt(this.real_jids[user_id]))&&(icons+='<img src="/img/moderator_icon-2.gif" title="Модератор">'),html+='<ins class="user'+user_id+" "+(this.unvoiced[user_id]?"revoked":"")+'"><a class=name '+avatar_html+' title="Написать в приват" data-user="'+user_id+'">'+item.user.login+"</a>"+icons+moderator_tools+game_html+"</ins>"}}$Prototype("chat-"+room).select(".userlist-content").last().update(html),$("#chat-"+room+" .moderator-tools .kick-btn").click(function(){_this.kick(this.getAttribute("data-user"))}),$("#chat-"+room+" ins .name").click(function(){_this.insertPrivate(this.getAttribute("data-user"))})},Chat.prototype.insertPrivate=function(user_id){var input=$Prototype("chat-"+this.active_room).select("input.text").last();input.value="<"+this.user_data[user_id].user.login+">",input.focus()},Chat.prototype.insertPrefix=function(user_id){var input=$Prototype("chat-"+this.active_room).select("input.text").last();input.value+=this.user_data[user_id].user.login+", ",input.focus()},Chat.prototype.kick=function(user_id){var item=this.user_data[user_id],_this=this,name=user_id;item&&item.user&&item.user.login&&(name=item.user.login),popconfirm("Заблокировать пользователя "+name+" на <select id=chat_kick_period><option value=1>1 минуту</option><option value=5>5 минут</option><option value=10>10 минут</option><option value=30>30 минут</option><option value=60>1 час</option><option value=180>3 часа</option><option value=360>6 часов</option><option value=720>12 часов</option><option value=1440>сутки</option><option value=4320>3 суток</option></select><br/>Причина: <input type=text id=chat_kick_reason>",function(){new Ajax.Request("/ajax/chat-kick",{parameters:{jid:_this.real_jids[user_id],period:$Prototype("chat_kick_period").value,reason:$Prototype("chat_kick_reason").value},onSuccess:function(){}})})},Chat.prototype.grantModerator=function(user_id){this.connection.send($iq({from:this.connection.jid,id:"admin1",to:"general@conference.jabber.klavogonki.ru",type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#admin"}).c("item",{jid:user_id+"@jabber.klavogonki.ru",affiliation:"admin"}).up().up().tree()),this.connection.send($iq({from:this.connection.jid,id:"mod1",to:"general@conference.jabber.klavogonki.ru",type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#admin"}).c("item",{nick:user_id,role:"moderator"}).up().up().tree())},Chat.prototype.revokeModerator=function(user_id){this.connection.send($iq({from:this.connection.jid,id:"admin2",to:"general@conference.jabber.klavogonki.ru",type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#admin"}).c("item",{jid:user_id+"@jabber.klavogonki.ru",affiliation:"member"}).up().up().tree()),this.connection.send($iq({from:this.connection.jid,id:"mod2",to:"general@conference.jabber.klavogonki.ru",type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#admin"}).c("item",{nick:user_id,role:"participant"}).up().up().tree())},Chat.prototype.grantAllModerators=function(){for(var i=0;i<moderators.length;i++)this.grantModerator(moderators[i])},Chat.prototype.filterUserData=function(user){return"string"!=typeof user.login&&(user.login="___"),"string"!=typeof user.avatar&&(user.avatar=""),"string"!=typeof user.background&&(user.background=""),user.login=user.login.replace(/[^a-zA-Z0-9_\-а-яА-ЯёЁ ]*/g,""),user.login=user.login.substr(0,16),/^http:\/\/img.klavogonki.ru\/avatars\/\d+\.gif\?updated=\d+$/.test(user.avatar)||(user.avatar=""),/^\#[A-Fa-f\d]+$/.test(user.background)||(user.background=""),user},$Prototype("chat-container")&&(chat=new Chat(PageData.chatParams),chat.connect()),window.onscroll=recalcFixedChat,window.onresize=recalcFixedChat,$(".filter-btn").click(changeChatFilter),$(".insert-smile-btn").click(function(){insertSmile(this.getAttribute("data-smile"))}).css("cursor","pointer"),$(".messages form").submit(function(){return chat.sendMsg(this.getAttribute("data-room")),!1})}).controller("Chat",function($scope,ChatOptions){$scope.options=ChatOptions}),angular.module("app.fuel",["lib.api.fuel","lib.loader","route-segment","view-segment","lib.ui.modal","lib.ui.drop"]).config(function($routeProvider,$routeSegmentProvider,PageData){"fuel"==PageData.rootAppModule&&($routeSegmentProvider.options.autoLoadTemplates=!0,$routeSegmentProvider.when("/","fuel-main.fuel").when("/vote","fuel-main.vote").when("/vote/:month","fuel-main.vote").when("/:month","fuel-main.fuel").segment("fuel-main",{templateUrl:"/views/partials/fuel/fuel-main.html?bust=1413116880766",controller:"fuel:Main",dependencies:["month"],resolve:{data:["FuelUsersLoader",function(FuelUsersLoader){return FuelUsersLoader.load()}]}}).within().segment("fuel",{templateUrl:"/views/partials/fuel/fuel.html?bust=1413116880766"}).segment("vote",{templateUrl:"/views/partials/fuel/vote.html?bust=1413116880766",controller:"fuel:Vote as Vote"}),$routeProvider.otherwise({redirectTo:"/"}))}).factory("FuelLoader",function(Loader,Fuel,$routeParams){return Loader.factory(function(){return{fuel:Fuel.get($routeParams.month)}})}).factory("FuelUsersLoader",function(Loader,Fuel,$routeParams){return Loader.factory(function(){return{fuel:Fuel.get($routeParams.month),users:Fuel.getUsers($routeParams.month),votes:Fuel.getUserVotes()}})}).controller("fuel:Main",function($scope,$q,data,Fuel,FuelUsersLoader,FuelDlgPayLauncher,Me,Dialogs,$location,$routeSegment){$scope.data=data,$scope.currentGoal=0;var now=new Date;now.setTime(now.getTime()+144e5),now.setUTCDate(1),$scope.selectedDate=angular.copy(now),$scope.selectedDate.setUTCFullYear(data.fuel.month.substr(0,4)),$scope.selectedDate.setUTCMonth(parseInt(data.fuel.month.substr(4,2))-1),$scope.months=[];var nov2013=angular.copy(now),curMonth=angular.copy(now);for(nov2013.setUTCFullYear(2013),nov2013.setUTCMonth(10),curMonth.setUTCMonth(curMonth.getUTCMonth()+1);curMonth.getTime()>=nov2013.getTime();curMonth.setUTCMonth(curMonth.getUTCMonth()-1))$scope.months.push(angular.copy(curMonth));$scope.startAccumulationDate=new Date("2014-07-01"),Me&&_.each(data.users,function(i){i.user_id==Me.id&&($scope.hasMyThank=!0)}),$scope.onReload=function(){FuelUsersLoader.load()},$scope.onMonthChange=function(month){var month=sprintf("%04d%02d",month.getUTCFullYear(),month.getUTCMonth()+1);$location.path($routeSegment.contains("vote")?"/vote/"+month:"/"+month)},$scope.onNextGoal=function(){$scope.currentGoal++},$scope.onPrevGoal=function(){$scope.currentGoal--},$scope.onSetGoal=function(goal){$scope.currentGoal=goal},$scope.onTankUp=function(){FuelDlgPayLauncher()},$scope.onRemoveMyThank=function(){Dialogs.ask("Дозаправка",'Вы хотите удалить ваше имя из списка "Спасибо"?').then(function(){return Fuel.removeMyThank()}).then(function(){return FuelUsersLoader.load()}).then(function(){$scope.hasMyThank=!1})}}).controller("fuel:Vote",function($scope,Dialogs,Fuel,FuelUsersLoader,Me){var ctrl=this;this.displayMode="month",this.categoryNames={multiplayer:"Коллективная игра",social:"Социальность и&nbsp;общение",game:"Игровая механика",training:"Тренажер и&nbsp;обучение",support:"Техническая поддержка"},this.getVotes=function(category){return"month"==ctrl.displayMode?$scope.data.fuel.votes&&$scope.data.fuel.votes[category]||0:$scope.data.fuel.total.votes[category]||0},this.getMaxVotes=function(){return _.max("month"==ctrl.displayMode?$scope.data.fuel.votes:$scope.data.fuel.total.votes)||0},this.vote=function(category){Me?Dialogs.ask("Голосование","Вы хотите отдать голос за направление &laquo;<b>"+ctrl.categoryNames[category]+"</b>&raquo;?",function(){return Fuel.vote(category)}).then(function(){FuelUsersLoader.load()}):Dialogs.notAuthorized()}}).factory("FuelDlgPayLauncher",function($modal2,Me,Dialogs){return function(benefit){Me?$modal2.open({templateUrl:"/views/partials/fuel/dlg-pay/step1.html?bust=1413116880766",controller:"fuel:DlgPay",resolve:{data:function(FuelLoader){return FuelLoader.load()},benefit:function(){return benefit}}}).result.then(function(result){$modal2.open({templateUrl:"/views/partials/fuel/dlg-pay/step2.html?bust=1413116880766",controller:"fuel:DlgPayMethod",resolve:{order:function(){return result}}})}):Dialogs.notAuthorized()}}).controller("fuel:DlgPay",function($scope,$modalInstance,data,benefit){$scope.premiumPrices={1:80,3:200,6:360},$scope.data={amount:"premium"==benefit?$scope.premiumPrices[1]:"",average:data.fuel.average,benefit:benefit||"",premiumPeriod:1,thank:!0},$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onBenefitSelect=function(benefit){$scope.data.benefit=benefit,"premium"==benefit&&$scope.data.amount<$scope.premiumPrices[1]&&($scope.data.amount=$scope.premiumPrices[1])},$scope.onPremiumPeriodSelect=function(period){$scope.data.premiumPeriod=period,$scope.data.amount=$scope.premiumPrices[period]},$scope.onThankChange=function(){$scope.data.thank=!$scope.data.thank},$scope.isOK=function(){return""!=$scope.data.benefit&&("premium"!=$scope.data.benefit||$scope.data.premiumPeriod>0)&&$scope.data.amount>=10},$scope.$watch("data.amount",function(val){return val<$scope.premiumPrices[1]&&"premium"==$scope.data.benefit?($scope.data.premiumPeriod=0,void 0):(angular.forEach($scope.premiumPrices,function(price,period){val>=price&&($scope.data.premiumPeriod=period)}),void 0)}),$scope.onNext=function(){$modalInstance.close($scope.data)}}).controller("fuel:DlgPayMethod",function($scope,$modalInstance,order,Me,Api){$scope.data={method:null},$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onMethodSelect=function(method){function goToPayment(data){if(-1!=_.indexOf(["qiwi","mobile","cards","terminal"],$scope.data.method)){var methodCodes={cards:1380,mobile:1475,qiwi:16,terminal:64};window.location.href="https://secure.xsolla.com/landings/?theme=115&pid="+methodCodes[$scope.data.method]+"&out="+order.amount+"&project=7735&v1="+data.id+"&hidden=v1,out&sign="+data.xsolla_sign+(Me.email?"&email="+Me.email:"")}else"other"==$scope.data.method?window.location.href="https://secure.xsolla.com/paystation2/?theme=115&out="+order.amount+"&project=7735&v1="+data.id+"&hidden=v1,out&sign="+data.xsolla_sign+(Me.email?"&email="+Me.email:""):"yamoney"==$scope.data.method?window.location.href="https://money.yandex.ru/eshop.xml?scid=2298&ShopId=611805&Sum="+order.amount+"&CustomerNumber="+data.id:"webmoney"==$scope.data.method?$scope.$broadcast("webmoney submit",order.amount,data.id):"paypal"==$scope.data.method&&(window.location.href=data.paypal_approval_url)}$scope.isPending||($scope.data.method=method,$scope.isPending=!0,Api.post("fuel/create-payment",{amount:parseInt(order.amount),paymentMethod:$scope.data.method,benefit:order.benefit,thank:order.thank}).then(function(response){response.ok&&goToPayment(response)}))},$scope.isOK=function(){return $scope.data.method&&!$scope.isPending},$scope.onNext=function(){}}).directive("appFuelGoalsList",function(){return{scope:{current:"="},controller:["$scope",function($scope){var goals=[];this.addGoal=function(goal){goals.push(goal)},$scope.$watch("current",function(current){_.each(goals,function(i){i.onScroll(current)})})}]}}).directive("appFuelGoal",function(){return{restrict:"E",templateUrl:"fuel-goal",replace:!0,transclude:!0,require:"^appFuelGoalsList",scope:{goalValue:"=value"},link:function($scope,elm,attrs,appFuelList){appFuelList.addGoal($scope),$scope.onScroll=function(pos){elm.css("top",-(260*pos)+"px")}}}}).directive("appFuelArrow",function($timeout){return function($scope,elm,attrs){$scope.$watch(attrs.appFuelArrow,function(fuelValue){$timeout(function(){var angle=180*fuelValue/15e4-90,transformCss="rotate("+angle+"deg)";elm.css("-webkit-transform",transformCss),elm.css("-ms-transform",transformCss),elm.css("-moz-transform",transformCss),elm.css("transform",transformCss)},0)})}}).directive("appFuelWebmoneyForm",function(){return function($scope,elm){$scope.$on("webmoney submit",function(event,amount,orderId){elm.find('[name="LMI_PAYMENT_AMOUNT"]').val(amount),elm.find('[name="order_id"]').val(orderId),elm.submit()})}}).directive("appFuelLabel",function(){return{link:function($scope,elm,attrs){var left=247+203*Math.cos(Math.PI-attrs.appFuelLabel*Math.PI/150)-21,top=239-200*Math.sin(Math.PI-attrs.appFuelLabel*Math.PI/150)-21;elm.css({left:left+"px",top:top+"px"})}}}).filter("month",function(){return function(value){if(!(value instanceof Date))return null;var monthNames=["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"];return monthNames[value.getMonth()]}}),angular.module("app.game",["app.profile.journal","app.game.typestats"]).controller("game:ServerClub",function($scope,Dialogs,$modal){$scope.onClick=function(){$modal.open({templateUrl:"/views/partials/dlg-serverclub.html?bust=1413116880766",controller:Dialogs.Ctrl}).result.then(function(){window.open("http://serverclub.ru","_blank")})}}).controller("game:PlayersList",function($scope,Socket,PageData,ProfilePostDlgLauncher,Api,$modal2,Profile){var ctrl=this;ctrl.records=[],ctrl.achieves=[],ctrl.typestats=[],Socket.bindEventToScope($scope,sprintf("game:%d/newRecord",PageData.gameId),function(data){ctrl.records[data.userId]=data.postId}),Socket.bindEventToScope($scope,sprintf("game:%d/newAchieve",PageData.gameId),function(data){ctrl.achieves[data.userId]=data.postId}),Socket.bindEventToScope($scope,sprintf("game:%d/typestats",PageData.gameId),function(data){ctrl.typestats[data.playerId]=data.time}),ctrl.onOpenPost=function(id){ProfilePostDlgLauncher.launch(id)},ctrl.onOpenTsf=function(userId,gameId){return Profile.getSummary(userId).then(function(summary){return summary.user.checkVisitorPermission("stats.allow_download_tsf",summary.is_friend)}).then(function(allowDownloadTsf){return $modal2.open({templateUrl:"/views/partials/game/typestats/dlg-download-tsf.html?bust=1413116880766",controller:function($scope,$modalInstance){$scope.allowDownloadTsf=allowDownloadTsf,$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onDownload=function(){return Api.get("g/get-record-by-user",{userId:userId,gameId:gameId}).then(function(data){window.open("/api/profile/download-record-tsf?userId="+userId+"&id="+data.recordId,"_top"),$modalInstance.close()})}}}).result})}}).controller("game:InvitesList",function($scope,Socket,$http,PageData,$timeout){var ctrl=this;ctrl.list=_.clone(PageData.friendsOnline),ctrl.onSendInvites=function(){var users=[];_.each(ctrl.list,function(i){i.checked&&(users.push(i.id),i.status="loading",i.loading&&$timeout.cancel(i.loading),i.loading=$timeout(function(){i.status=null},2e4))}),$http({method:"GET",url:"/g/"+PageData.gameId+".invite",params:{users:users.join(",")}})},ctrl.onCheckAll=function(){_.each(ctrl.list,function(i){i.checked=!0})}}).controller("game:InvitesList.Item",function($scope,Socket,PageData,$timeout){Socket.bindEventToScope($scope,sprintf("game:%s/invite:%s",PageData.gameId,$scope.friend.id),function(){$scope.friend.status="ok",$scope.friend.loading&&$timeout.cancel($scope.friend.loading)})});var mod=angular.module("app.game.typestats",[]);mod.value("TSConfig",{versionLatest:6}),mod.factory("TSConnect",function($http,Api,$q,$rootScope,Socket,TSConfig,Me){var TSConnect={status:!1},promise=!1,started=!1;return TSConnect.check=function(){return TSConnect.status="connecting1",$http.get("http://localhost:9031/check").then(function(response){TSConnect.status=response.data.version==TSConfig.versionLatest?"connecting2":"obsolete",response.data.disabled&&(TSConnect.status="disabled"),Me.pro||(TSConnect.status="pro")},function(){TSConnect.status=!1})},TSConnect.set=function(gameId,token,text,fn){if(promise)return promise;if("connecting2"!=TSConnect.status)return $q.reject();var content=[gameId,token,Me?Me.login:"",Me?"http://klavogonki.ru/u/#/"+Me.id:""].join("\n");return promise=$http.post("http://localhost:9031/set",content,{headers:{"Content-Type":"text/plain"}}).then(function(response){response.data.ok&&(TSConnect.status="ok",Api.post("g/set-typestats-active",{gameId:gameId,token:token}),Socket.bindEventToScope($rootScope,sprintf("game:%s/typestats:%s",gameId,token),fn))})},TSConnect.start=function(time){return started?void 0:(started=!0,$http.post("http://localhost:9031/start",Math.round(time/1e3),{headers:{"Content-Type":"text/plain"}}))},TSConnect}),mod.controller("game:TSIndicator",function(TSConnect){this.status=function(){return TSConnect.status}}),angular.module("app.gamelist",["lib.directives","lib.socket","page","app.chat","lib.local-storage"]).factory("GamelistOptions",function(LocalStorage){return LocalStorage.createSyncedObj("gamelist.options",{showActiveGames:!1,animDuration:2})}).controller("GamelistCtrl",function($scope,PageData,Socket,GamelistOptions){function insertGame(id,game,players){players=players||[],games[id]={id:id,info:game,players:players};var game=games[id],fields=["createtime","begintime","endtime"];for(var i in fields)if(game.info[fields[i]]){var parsed=game.info[fields[i]].match(/(\d+)-(\d+)-(\d+)T(\d+):(\d+):(\d+)/);game.info[fields[i]]=new Date(Date.UTC(parsed[1],parsed[2]-1,parsed[3],parsed[4],parsed[5],parsed[6]))}updateInGamelists(game)}function updateInGamelists(game){var gamelistName=null,gamelist=null,hasActivePlayers=!1;if(game.players)for(var i=0;i<game.players.length;i++)game.players[i]&&!game.players[i].leave&&(hasActivePlayers=!0);if(game.info.createtime.getTime()>(new Date).getTime()+Socket.timeCorrection-3e5||game.info.params.competition&&game.info.createtime.getTime()>(new Date).getTime()+Socket.timeCorrection-9e5){var allowed=!game.info.custom||1==game.info.params.level_from&&9==game.info.params.level_to||PageData.userLevel&&game.info.params.level_to>=PageData.userLevel&&game.info.params.level_from<=PageData.userLevel;gamelistName=hasActivePlayers||game.info&&game.info.params&&game.info.params.competition?!allowed||game.info.begintime&&game.info.begintime.getTime()<(new Date).getTime()+Socket.timeCorrection+3e3?"active":game.info.params.competition?"fixed":"open":"hidden",gamelist=gamelists[gamelistName],-1==gamelist.indexOf(game)&&gamelist.unshift(game)}for(var i in gamelists)if("function"!=typeof gamelists[i]&&gamelists[i]!=gamelist){var idx=gamelists[i].indexOf(game);-1!=idx&&gamelists[i].splice(idx,1)}return gamelistName}function applyDiffR(diff,obj){for(var k in diff)"function"!=typeof diff[k]&&("object"==typeof diff[k]||"array"==typeof diff[k]?typeof obj[k]!=typeof diff[k]?obj[k]=diff[k]:applyDiffR(diff[k],obj[k]):obj[k]=diff[k])}$scope.isConnected=!1,$scope.isFirstLoadComplete=!1;var games=$scope.games={},gamelists=$scope.gamelists={fixed:[],open:[],active:[],hidden:[]};$scope.options=GamelistOptions,Socket.bindEventToScope($scope,"gamelist/initList",function(data){for(var i=0;i<data.length;i++)insertGame(data[i].id,data[i].info,data[i].players);$scope.isFirstLoadComplete=!0,$Prototype("chat-wrapper").show()}),Socket.bindEventToScope($scope,"gamelist/gameCreated",function(data){insertGame(data.id,data)},{noApply:!0}),Socket.bindEventToScope($scope,"gamelist/gameUpdated",function(data){if(games[data.g]){var game=games[data.g];applyDiffR(data.diff,game.info);var fields=["createtime","begintime","endtime"];for(var i in fields)data.diff[fields[i]]&&(game.info[fields[i]]=new Date,game.info[fields[i]].setTime(1e3*data.diff[fields[i]]));"racing"==data.diff.status&&updateInGamelists(game)}},{noApply:!0}),Socket.bindEventToScope($scope,"gamelist/playerUpdated",function(data){if(games[data.g]){var game=games[data.g];game.players[data.p]?applyDiffR(data.diff,game.players[data.p]):game.players[data.p]=data.diff,updateInGamelists(game)}},{noApply:!0}),$scope.getRemainTime=function(game){if(game.info.begintime){var now=new Date,time=Math.floor((game.info.begintime.getTime()-now.getTime()-Socket.timeCorrection)/1e3);0>time&&(time=0)}else{var time=30;game.info.custom&&(time=game.info.params.timeout)}return{time:time,label:(time/60).format()+":"+(time%60).format()}},$scope.isPlayersReduced=function(players){var max_players_width=4+Math.floor(($Prototype("content").getWidth()-850)/120);4>max_players_width&&(max_players_width=4);var reduced_display=players&&players.length>max_players_width;return reduced_display},recalcFixedChat(),setInterval(function(){for(var id in games)if("function"!=typeof games[id]){var status=updateInGamelists(games[id]);games[id].started=!0,null==status&&games[id].started&&delete games[id]}$scope.$apply()},1e3)}),angular.module("app.loading",["lib.loader"]).directive("appLoading",function(Loader,$window){return{controller:function($scope){$scope.Loader=Loader},link:function($scope,elm){$window.addEventListener("scroll",function(){$(".userpanel").hasClass("pinned")?(elm.addClass("userpanel-pinned"),elm.toggleClass("fixed",$($window).scrollTop()>$("#head").offset().top-45)):(elm.removeClass("userpanel-pinned"),elm.toggleClass("fixed",$($window).scrollTop()>$("#head").offset().top))})}}}),angular.module("app.old-profile",["app.fuel"]).controller("old-profile:BuyScores",function($scope,FuelDlgPayLauncher){$scope.onClick=function(){FuelDlgPayLauncher("scores")}}),angular.module("app.profile",["app.profile.main","app.profile.index","app.profile.achieves","app.profile.car","app.profile.journal","app.profile.friends","app.profile.stats","app.profile.messages","app.profile.prefs"]),angular.module("app.profile.main",["lib.directives","route-segment","view-segment","lib.api.profile","lib.user-cache"]).config(function($routeProvider,$routeSegmentProvider,PageData,Me){"profile"==PageData.rootAppModule&&($routeSegmentProvider.segment("main",{templateUrl:"/views/partials/profile/main.html?bust=1413116880766",controller:"profile:Main as Main",dependencies:["user"],resolveFailed:{templateUrl:"/views/partials/resolve-failed.html?bust=1413116880766"},resolve:{data:function(ProfileMainLoader){return ProfileMainLoader.load()
}}}),Me&&$routeProvider.otherwise({redirectTo:"/"+Me.id+"/"}))}).factory("ProfileMainLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user,{clearCache:!0})}})}).controller("profile:Main",function($scope,$routeSegment,data,$interval,$location,Me,Socket,Profile,UserCache,Dialogs,$parse,$window){var ctrl=this;$scope.$routeSegment=$routeSegment,$scope.data=data,$window.document.title=data.summary.user.login+" - Клавогонки",$interval(null,3e4),ctrl.onPrefs=function(){$location.path("/"+$routeSegment.$routeParams.user+"/prefs/")},ctrl.onFriendRequest=function(){Dialogs.friendRequest(data.summary.user.id)},ctrl.onFriendRemove=function(){Dialogs.friendRemove(data.summary.user.id).then(function(){data.summary.is_friend=!1})},ctrl.onSendMessage=function(){Dialogs.sendUserMessage(data.summary.user.id)},ctrl.onSendScores=function(){Dialogs.sendUserMessage(data.summary.user.id,!0)},ctrl.onIgnore=function(){Dialogs.ignoreUser(data.summary.user)},ctrl.onComplain=function(){Dialogs.complainUser(data.summary.user)},ctrl.onUserModerator=function(){userModerator(data.summary.user.id,data.summary.blocking_period)},ctrl.checkVisitorPermission=function(prefName){return data.summary.user.checkVisitorPermission(prefName,data.summary.is_friend)},Me&&Me.id==$routeSegment.$routeParams.user&&(Socket.bindEventToScope($scope,"newFriendRequest:"+Me.id,function(data){UserCache.thru(data),$scope.data.summary.friend_requests++}),Socket.bindEventToScope($scope,sprintf("counters:%s/unreadMail",Me.id),function(data){$scope.data.summary.unread_messages=data.newAmount})),ctrl.onScrollToTop=function(){$($window).scrollTop(0)}}),angular.module("app.profile.achieves",["app.profile.achieves.main","app.profile.achieves.progress","app.profile.achieves.done"]),angular.module("app.profile.achieves.main",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.within("main").segment("achieves",{templateUrl:"/views/partials/profile/achieves.html?bust=1413116880766",controller:"profile:Main.Achieves as Achieves",dependencies:["user"]})}).factory("ProfileAchievesOptions",function(LocalStorage){return LocalStorage.createSyncedObj("profile.achieves.options",{done:{sort:"difficulty",displayType:"list"},progress:{sort:"progress",displayType:"list"},getSortDoneField:function(){return"date"==this.sortDone?"-post.date":"-difficulty"},getSortProgressField:function(){return"date"==this.sortProgress?"-updated_date":"progress"==this.sortProgress?"-progress":"-difficulty"}})}).factory("ProfileAchievesGrouper",function(){return{group:function(list,achieves){for(var curGroup,oldAchieveName,groups=[],i=0;i<list.length;i++){var achieveName=achieves[list[i].achieve_id].achieve.name;achieveName!=oldAchieveName?(curGroup={titleItem:list[i],restItems:[],collapsed:!0},groups.push(curGroup)):curGroup.restItems.push(list[i]),oldAchieveName=achieveName}return groups},wrap:function(list){return _.map(list,function(i){return{titleItem:i}})}}}).controller("profile:Main.Achieves",function(){}).directive("appProfileAchieve",function($timeout){return{restrict:"E",templateUrl:function(elm,attrs){return attrs.reduced?"/views/partials/profile/achieves/achieve-reduced.html?bust=1413116880766":"/views/partials/profile/achieves/achieve.html?bust=1413116880766"},scope:{achieve:"=",level:"=",levels:"@",onIconClick:"&",onLevelsClick:"&",reduced:"=",date:"=",progress:"=",nextLevelProgress:"=",levelProgress:"="},link:function($scope,elm){var timeout;$scope.onMouseenter=function(){timeout=$timeout(function(){elm.find(".achieve").css("overflow","visible"),timeout=null},500)},$scope.onMouseleave=function(){timeout&&($timeout.cancel(timeout),timeout=null),elm.find(".achieve").css("overflow","hidden")}}}}),angular.module("app.profile.achieves.done",["route-segment","view-segment","lib.api.profile","app.profile.journal"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&($routeSegmentProvider.when("/:user/achievements/","main.achieves.done"),$routeSegmentProvider.when("/:user/achievements/:post","main.achieves.done").within("main").within("achieves").segment("done",{templateUrl:"/views/partials/profile/achieves/done.html?bust=1413116880766",controller:"profile:Main.Achieves.DoneList as DoneList",dependencies:["user"],resolve:{data:function(ProfileAchievesDoneLoader,ProfilePostDlgLauncher,$routeParams){return $routeParams.post&&ProfilePostDlgLauncher.launch($routeParams.post,"/achievements/"),ProfileAchievesDoneLoader.load()}}}))}).factory("ProfileAchievesDoneLoader",function(Loader,Profile,$routeParams,ProfileAchievesOptions,ProfileAchievesGrouper){var ProfileAchievesDoneLoader=Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),achieves:Profile.getAchieves($routeParams.user,"done",ProfileAchievesOptions.done.sort).then(ProfileAchievesDoneLoader.buildGroups)}});return ProfileAchievesDoneLoader.buildGroups=function(data){return data.groups="difficulty"==ProfileAchievesOptions.done.sort?ProfileAchievesGrouper.group(data.list,data.achieves):ProfileAchievesGrouper.wrap(data.list),data},ProfileAchievesDoneLoader}).controller("profile:Main.Achieves.DoneList",function($scope,data,ProfileAchievesOptions,ProfileAchievesDoneLoader,$location,$routeParams,ProfilePostDlgLauncher,Profile){var ctrl=this;ctrl.data=data,$scope.options=ProfileAchievesOptions,$scope.$watch(function(){return ProfileAchievesOptions.done.sort},function(newVal,oldVal){newVal!==oldVal&&ProfileAchievesDoneLoader.load()}),$scope.$watch(function(){return $routeParams.post},function(newVal,oldVal){newVal&&newVal!==oldVal&&ProfilePostDlgLauncher.launch(newVal,"/achievements/")}),ctrl.onLoadMore=function(){return Profile.getAchieves($routeParams.user,"done",ProfileAchievesOptions.done.sort,data.achieves.list.length).then(ProfileAchievesDoneLoader.buildGroups).then(function(response){_.complexMerge(data.achieves,response)})}}).controller("profile:Main.Achieves.DoneList.Item",function($scope,$location,$routeSegment){var ctrl=this;ctrl.onIconClick=function(post){$location.path(sprintf("/%s/achievements/%s",$routeSegment.$routeParams.user,post._id))},ctrl.onLevelsClick=function(achieve){$location.url(sprintf("/%s/journal/?achieve_id=%s",$routeSegment.$routeParams.user,achieve.achieve_id))}}),angular.module("app.profile.achieves.progress",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/achievements/progress/","main.achieves.progress").within("main").within("achieves").segment("progress",{templateUrl:"/views/partials/profile/achieves/progress.html?bust=1413116880766",controller:"profile:Main.Achieves.ProgressList as ProgressList",dependencies:["user"],resolve:{data:function(ProfileAchievesProgressLoader){return ProfileAchievesProgressLoader.load()}}})}).factory("ProfileAchievesProgressLoader",function(Loader,Profile,$routeParams,ProfileAchievesOptions,ProfileAchievesGrouper){var ProfileAchievesProgressLoader=Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),achieves:Profile.getAchieves($routeParams.user,"progress",ProfileAchievesOptions.progress.sort,0).then(ProfileAchievesProgressLoader.buildGroups)}});return ProfileAchievesProgressLoader.buildGroups=function(data){return data.groups="difficulty"==ProfileAchievesOptions.progress.sort?ProfileAchievesGrouper.group(data.list,data.achieves):ProfileAchievesGrouper.wrap(data.list),data},ProfileAchievesProgressLoader}).controller("profile:Main.Achieves.ProgressList",function($scope,data,ProfileAchievesOptions,ProfileAchievesProgressLoader,Profile,$routeSegment){var ctrl=this;ctrl.data=data,$scope.options=ProfileAchievesOptions,$scope.$watch(function(){return ProfileAchievesOptions.progress.sort},function(newVal,oldVal){newVal!==oldVal&&ProfileAchievesProgressLoader.load()}),ctrl.onLoadMore=function(){return Profile.getAchieves($routeSegment.$routeParams.user,"progress",ProfileAchievesOptions.progress.sort,data.achieves.list.length).then(ProfileAchievesProgressLoader.buildGroups).then(function(response){_.complexMerge(data.achieves,response)})},ctrl.removeItem=function(item){_.each(data.achieves.groups,function(group){if(group){if(group.titleItem==item)return data.achieves.groups.splice(_.indexOf(data.achieves.groups,group),1),"difficulty"==ProfileAchievesOptions.progress.sort&&ProfileAchievesProgressLoader.load(),void 0;var idx=_.indexOf(group.restItems,item);-1!=idx&&group.restItems.splice(idx,1)}})}}).controller("profile:Main.Achieves.ProgressList.Item",function($scope,Profile,ProfileAchievesProgressLoader,Dialogs){var ctrl=this;ctrl.onHide=function(){Dialogs.ask("Скрыть","Неоконченное достижение будет удалено из списка, однако его состояние сохранится. Достижение появится снова, когда вы вновь обновите его прогресс.<br><br>Скрыть достижение?").then(function(){return Profile.outdateAchieve($scope.item.achieve_id)}).then(function(){$scope.ProgressList.removeItem($scope.item)})}}),angular.module("app.profile.car",["route-segment","view-segment","app.profile.index","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/car/","main.car").within("main").segment("car",{templateUrl:"/views/partials/profile/car.html?bust=1413116880766",controller:"profile:Main.CarPage as CarPage",dependencies:["user"],resolve:{data:function(ProfileCarsLoader){return ProfileCarsLoader.load()}}})}).factory("ProfileCarsLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),cars:Profile.getCarsList($routeParams.user)}})}).controller("profile:Main.CarPage",function($scope,data,Profile,Dialogs,$modal,ProfileCarsLoader,ProfileMainLoader,ProfileDlgTuningLoader,$modal2){var ctrl=this;ctrl.data=data,ctrl.onSelectCar=function(car){return Profile.selectCar(car).then(function(result){_.extend(data.summary.car,result.car)})},ctrl.onBuyCar=function(car){return Dialogs.ask("Покупка авто","Вы хотите купить <b>"+data.cars.cars[car].name+"</b>?").then(function(){return Profile.buyCar(car)}).then(function(result){data.cars.bought[result.car.car]=result.car})},ctrl.onChangeColor=function(){return $modal2.open({templateUrl:"/views/partials/profile/car/dlg-color.html?bust=1413116880766",controller:"profile:DlgCarColor as DlgCarColor",windowClass:"dlg-profile-car-color-window",resolve:{data:function(){return data}}}).result.then(function(){ProfileCarsLoader.load(),ProfileMainLoader.load()})},ctrl.onChangeAero=function(){return $modal2.open({templateUrl:"/views/partials/profile/car/dlg-aero.html?bust=1413116880766",controller:"profile:DlgCarAero as DlgCarAero",windowClass:"dlg-profile-car-aero-window",resolve:{data:function(){return data}}}).result.then(function(){ProfileCarsLoader.load(),ProfileMainLoader.load()})},ctrl.onChangeTuning=function(){return $modal2.open({templateUrl:"/views/partials/profile/car/dlg-tuning.html?bust=1413116880766",controller:"profile:DlgCarTuning as DlgCarTuning",windowClass:"dlg-profile-car-tuning-window",resolve:{data:function(){return ProfileDlgTuningLoader.load()}}}).result.then(function(){ProfileCarsLoader.load(),ProfileMainLoader.load()})}}).controller("profile:DlgCarColor",function($scope,data,Me,$modalInstance,Profile){var ctrl=this;_.extend(ctrl,data),ctrl.color="777777","#"==Me.color[0]&&(ctrl.color=Me.color.substr(1)),$scope.onOK=function(){return Profile.setColor(ctrl.color).then(function(){$modalInstance.close()})},$scope.onCancel=function(){$modalInstance.dismiss()}}).controller("profile:DlgCarAero",function($scope,data,Me,$modalInstance,Profile){var ctrl=this;_.extend(ctrl,data),$scope.onOK=function(){var imageData=ctrl.exportImageData();return Profile.setCarAero(imageData).then(function(){$modalInstance.close()})},$scope.onCancel=function(){$modalInstance.dismiss()}}).directive("appProfileCarAeroCanvas",function(Profile,$timeout){return{link:function($scope,elm,attrs){function loadImageUrl(url,crossOrigin){var img=new Image;img.onload=function(){elm.get(0).literallycanvas.backgroundImage=img,elm.get(0).literallycanvas.repaint()},crossOrigin&&img.setAttribute("crossOrigin","anonymous"),img.src=url}function updateZoom(zoom){var height=50*zoom,width=100*zoom,left=(500-width)/2,top=(340-height)/2;elm.find(".car .img").css({width:5*width+"px",height:4*height+"px"});var i=0;elm.find(".car .img").each(function(){$(this).css({backgroundPosition:initCarPositions[i]*zoom+"px -"+50*i*zoom+"px"}),i++}),elm.find(".car .imgcont").css({width:width+"px",height:height+"px"}),elm.find(".car").css({left:left+"px",top:top+"px"}),elm.find(".white-top, .white-bottom").css({height:top+"px"}),elm.find(".white-left, .white-right").css({width:left+"px"})}var opts=$scope.$eval(attrs.appProfileCarAeroCanvas);opts.toolClasses=[LC.PencilWidget,LC.EraserWidget,LC.LineWidget],opts.updateZoom=updateZoom;var initCarPositions=[];$timeout(function(){elm.literallycanvas(opts),elm.find(".car .img").each(function(){var m,pos=$(this).css("background-position").split(/ /)[0];(m=pos.match(/([\d-]+)px/))?initCarPositions.push(m[1]):initCarPositions.push(0)}),elm.find("input#file-input").change(function(e){var reader=new FileReader;reader.onload=function(event){loadImageUrl(event.target.result)},reader.readAsDataURL(e.target.files[0])}),Profile.getOldAero().then(function(result){result.old_aero&&loadImageUrl(result.old_aero+"?forEditor",!0)}),updateZoom(1)},10),$scope.DlgCarAero.exportImageData=function(){elm.get(0).literallycanvas.zoom(1);var buffer=$("<canvas>").get(0);buffer.width=100,buffer.height=50;var bufferCtx=buffer.getContext("2d"),srcCanvas=elm.canvasForExport();return bufferCtx.drawImage(srcCanvas,Math.round(-(srcCanvas.width-buffer.width)/2),Math.round(-(srcCanvas.height-buffer.height)/2)),buffer.toDataURL("image/png")}}}}).factory("ProfileDlgTuningLoader",function(Loader,Profile,$routeSegment){return Loader.factory(function(){return{summary:Profile.getSummary($routeSegment.$routeParams.user),tuningInfo:Profile.getTuningInfo()}})}).controller("profile:DlgCarTuning",function($scope,data,$modalInstance,Profile){var ctrl=this;_.extend(ctrl,data),ctrl.selectedTuning=_.clone(data.summary.car.tuning),ctrl.singleTuningArray=function(k,i){var result=[];return result[k]=i,2==k&&42==data.summary.car.car&&(result[0]=1),result},$scope.onCancel=function(){$modalInstance.dismiss()},ctrl.onSelectTuning=function(item,value){ctrl.selectedTuning[item]=value,42==data.summary.car.car&&2==item&&value&&(ctrl.selectedTuning[0]=1)},ctrl.getTotalPrice=function(){var price=0;return _.each(ctrl.selectedTuning,function(i,k){data.tuningInfo.bought[k]&&data.tuningInfo.bought[k][i]||(price+=data.tuningInfo.tuning[k].prices[i]||0)}),price},$scope.onOK=function(){return Profile.setTuning(ctrl.selectedTuning).then(function(){$modalInstance.close()})}}),angular.module("app.profile.friends",["app.profile.friends.main","app.profile.friends.feed","app.profile.friends.list"]),angular.module("app.profile.friends.main",["route-segment","view-segment"]).config(function($routeProvider,$routeSegmentProvider,PageData,Me){"profile"==PageData.rootAppModule&&($routeProvider.when("/:user/friends/",{redirectTo:function(params){return sprintf("/%s/friends/%s/",params.user,Me&&Me.id==params.user?"feed":"list")}}),$routeSegmentProvider.within("main").segment("friends",{templateUrl:"/views/partials/profile/friends.html?bust=1413116880766",controller:"profile:Main.FriendsPage as FriendsPage",dependencies:["user"]}))}).controller("profile:Main.FriendsPage",function($scope,$routeSegment){$scope.$routeSegment=$routeSegment}),angular.module("app.profile.friends.feed",["route-segment","view-segment","lib.api.profile","app.profile.journal"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/friends/feed/","main.friends.feed").within("main").within("friends").segment("feed",{templateUrl:"/views/partials/profile/friends/feed.html?bust=1413116880766",controller:"profile:Main.FriendsFeed as FriendsFeed",dependencies:["user"],resolve:{data:function(ProfileFriendsFeedLoader,ProfileJournalOptions){return ProfileJournalOptions.clearPrivate(),ProfileFriendsFeedLoader.load()}}})}).factory("ProfileFriendsFeedLoader",function(Loader,Profile,$routeParams,ProfileJournalOptions){return Loader.factory(function(beforeDate){return{summary:Profile.getSummary($routeParams.user),journal:Profile.getJournalEx("friends",ProfileJournalOptions,beforeDate).then(Loader.slowDownArray("posts",3,100,100)),friends:Profile.getFriends($routeParams.user)}})}).controller("profile:Main.FriendsFeed",function($scope,data,ProfileJournalOptions,ProfileFriendsFeedLoader,$routeSegment,ProfilePostDlgLoader,$modal2,$routeParams,$location,$q){function reload(newVal,oldVal){if(!angular.equals(newVal,oldVal)){var beforeDate=_.clone(ProfileJournalOptions.getPrivate().beforeDate||null);beforeDate&&beforeDate.setTime(beforeDate.getTime()+864e5-1),ProfileFriendsFeedLoader.load(beforeDate)}}$scope.data=data,$scope.options=ProfileJournalOptions,$scope.$watch("options",reload,!0),$scope.$watch("options.getPrivate().beforeDate",reload),$scope.onOpenPost=function(post){$modal2.open({templateUrl:"/views/partials/profile/journal/modal.html?bust=1413116880766",controller:"profile:PostDlg as PostDlg",resolve:{data:function(){return $q.when({journal:_.extend({},$scope.data.journal,{post:_.clone(post,!0)})})}}})}}),angular.module("app.profile.friends.list",["route-segment","view-segment","lib.loader","lib.api.profile","lib.user-cache"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/friends/list/","main.friends.list").within("main").within("friends").segment("list",{templateUrl:"/views/partials/profile/friends/list.html?bust=1413116880766",controller:"profile:Main.FriendsPage.FriendsList as FriendsList",dependencies:["user"],resolve:{data:function(ProfileFriendsListLoader){return ProfileFriendsListLoader.load()}}})}).factory("ProfileFriendsListLoader",function(Loader,$routeParams,Profile,Me){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),friends:Profile.getFriends($routeParams.user).then(Loader.slowDownArray("users",10,300,5)),friend_requests:Me&&Me.id==$routeParams.user?Profile.getFriendRequests($routeParams.user):null}})}).controller("profile:Main.FriendsPage.FriendsList",function($scope,$routeSegment,data,Profile,Me,Socket,UserCache){var ctrl=this;$scope.data=data,$scope.searchText="",$scope.search=null,ctrl.online=_.extend(ctrl.online||{},data.friends.online),ctrl.onSearch=function(){$scope.searchText?($scope.search={},Profile.searchUsers($scope.searchText).then(function(data){ctrl.online=_.extend(ctrl.online,data.online),$scope.search.result=data})):$scope.search=null},ctrl.onClearSearch=function(){$scope.searchText="",$scope.search=null},ctrl.isFriend=function(user){return _.any($scope.data.friends.users,{id:user.id})},Me&&$routeSegment.$routeParams.user&&Socket.bindEventToScope($scope,"newFriendRequest:"+Me.id,function(data){UserCache.thru(data),$scope.data.friend_requests.in[data.user.id]=data.user})}).controller("profile:Main.FriendsPage.FriendsList.User",function($scope,$location,Profile,Me,Socket,Dialogs){var ctrl=this;ctrl.onGoToProfile=function(){$location.path("/"+$scope.user.id)},ctrl.onRequestReject=function(){return Profile.friendRequestReject($scope.user.id).then(function(result){result.ok&&($scope.data.friend_requests.in[$scope.user.id]=null,delete $scope.data.friend_requests.in[$scope.user.id],$scope.data.summary.friend_requests--)})},ctrl.onRequestAccept=function(){return Profile.friendRequest($scope.user.id).then(function(result){result.added&&($scope.data.friends.users.push($scope.user),$scope.data.friend_requests.in[$scope.user.id]=null,delete $scope.data.friend_requests.in[$scope.user.id],$scope.data.summary.friend_requests--)})},ctrl.onRemoveFriend=function(){Dialogs.ask("Удалить друга","Удалить этого пользователя из списка ваших друзей?").then(function(){Profile.removeFriend($scope.user.id).then(function(result){if(result.ok){var idx=_.indexOf($scope.data.friends,$scope.user);$scope.data.friends.users.splice(idx,1)}})})},ctrl.onRequest=function(){return Profile.friendRequest($scope.user.id).then(function(result){result.ok&&($scope.data.friend_requests.out[$scope.user.id]=$scope.user)})},ctrl.onSendMessage=function(){Dialogs.sendUserMessage($scope.user.id)},ctrl.onSendScores=function(){Dialogs.sendUserMessage($scope.user.id,!0)},ctrl.onIgnore=function(){Dialogs.ignoreUser($scope.user)},ctrl.onComplain=function(){Dialogs.complainUser($scope.user)},Me&&$scope.data.friend_requests&&$scope.data.friend_requests.out[$scope.user.id]&&Socket.bindEventToScope($scope,sprintf("friendRequest:%s->%s",Me.id,$scope.user.id),function(result){"accept"==result&&($scope.user.added=!0,$scope.data.friends.users.push($scope.user)),$scope.data.friend_requests.out[$scope.user.id]=null,delete $scope.data.friend_requests.out[$scope.user.id]})}),angular.module("app.profile.index",["route-segment","view-segment","lib.loader","lib.api.profile","lib.socket","app.profile.journal","lib.ui.modal2"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&($routeSegmentProvider.when("/:user/","main.index"),$routeSegmentProvider.when("/:user/editbio","main.editbio").within("main").segment("index",{templateUrl:"/views/partials/profile/index.html?bust=1413116880766",controller:"profile:Main.IndexPage as IndexPage",dependencies:["user"],resolve:{data:function(ProfileIndexLoader){return ProfileIndexLoader.load()}}}).segment("editbio",{templateUrl:"/views/partials/profile/index/editbio.html?bust=1413116880766",controller:"profile:Main.EditBio as EditBio",dependencies:["user"],resolve:{data:function(ProfileEditBioLoader){return ProfileEditBioLoader.load()}}}))}).factory("ProfileIndexLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),journal:Profile.getJournal($routeParams.user).then(Loader.slowDownArray("posts",3,300,100)),index:Profile.getIndexData($routeParams.user)}})}).controller("profile:Main.IndexPage",function($scope,data,$location,$modal2,Dialogs,ProfileDlgVocsLoader,ProfileDlgSetAchieveLoader,Profile,ProfileIndexLoader,$routeSegment,ProfilePostDlgLauncher){var ctrl=this;$scope.data=data,$scope.onOpenPost=function(post){$location.path("/"+post.user_id+"/journal/"+post._id)},ctrl.onOpenBio=function(){$modal2.open({templateUrl:"/views/partials/profile/index/dlg-bio.html?bust=1413116880766",controller:function($scope,data,$modalInstance){$scope.data=data,$scope.onCancel=function(){$modalInstance.dismiss()}},resolve:{data:function(){return data}}})},ctrl.onOpenVocs=function(){$modal2.open({templateUrl:"/views/partials/profile/index/dlg-vocs.html?bust=1413116880766",controller:"profile:DlgVocs as DlgVocs",resolve:{data:function(){return ProfileDlgVocsLoader.load()}}})},ctrl.onSetAchieve=function(num){$modal2.open({templateUrl:"/views/partials/profile/index/dlg-set-achieve.html?bust=1413116880766",controller:"profile:DlgSetIndexAchieve as DlgSetIndexAchieve",resolve:{data:function(){return ProfileDlgSetAchieveLoader.load()},index_achieves:function(){return data.index.achieves.list}}}).result.then(function(achieve_id){return Profile.setIndexAchieve(num,achieve_id)}).then(function(){return ProfileIndexLoader.load()})},ctrl.onRemoveAchieve=function(num){Profile.setIndexAchieve(num,null).then(function(){return ProfileIndexLoader.load()})},ctrl.onSelectAchieve=function(achieve_id){ProfilePostDlgLauncher.launch(data.index.achieves.user[achieve_id].post._id)},ctrl.hasAchieves=function(){return _.any(data.index.achieves.list,function(i){return null!==i})}}).factory("ProfileDlgVocsLoader",function(Loader,Profile,$routeSegment){return Loader.factory(function(){return{summary:Profile.getSummary($routeSegment.$routeParams.user),vocs:Profile.getVocs($routeSegment.$routeParams.user)}})}).controller("profile:DlgVocs",function($scope,data,$modalInstance){$scope.data=data,$scope.onCancel=function(){$modalInstance.dismiss()}}).factory("ProfileEditBioLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),index:Profile.getIndexData($routeParams.user)}})}).controller("profile:Main.EditBio",function($scope,data,Profile,Me,$location,$q,Dialogs){var ctrl=this;ctrl.isPreview=!1,ctrl.data=data,ctrl.onPreview=function(){ctrl.isPreview=!ctrl.isPreview},ctrl.onBack=function(){$location.path("/"+Me.id+"/")},ctrl.onSend=function(){var defer=$q.defer();return Profile.setBio(data.index.bio.text).then(function(){return ctrl.onBack()},function(){Dialogs.alert("Ошибка","Ошибка при сохранении."),defer.reject()}),defer.promise}}).factory("ProfileDlgSetAchieveLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),achieves:Profile.getAchieves($routeParams.user,"done","difficulty")}})}).controller("profile:DlgSetIndexAchieve",function($scope,data,index_achieves,$modalInstance){var ctrl=this;_.extend(ctrl,data),ctrl.index_achieves=_.filter(index_achieves,function(i){return null!==i}),$scope.onCancel=function(){$modalInstance.dismiss()},ctrl.onSelect=function(item){$modalInstance.close(item.achieve_id)}}),angular.module("app.profile.journal",["route-segment","view-segment","app.profile.index","lib.api.profile","lib.ui.modal2","lib.user-cache","lib.ui.smilies","lib.ui.date","app.profile.achieves"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&($routeSegmentProvider.when("/:user/journal/","main.journal"),$routeSegmentProvider.when("/:user/journal/:post","main.journal").within("main").segment("journal",{templateUrl:"/views/partials/profile/journal.html?bust=1413116880766",controller:"profile:Main.JournalPage as JournalPage",dependencies:["user"],resolve:{data:function(ProfileJournalLoader,ProfileJournalOptions,$modal2,$routeParams,ProfilePostDlgLauncher){return $routeParams.post&&ProfilePostDlgLauncher.launch($routeParams.post),ProfileJournalOptions.clearPrivate(),ProfileJournalLoader.load()}}}))}).factory("ProfileJournalOptions",function(LocalStorage){var privateData={};return LocalStorage.createSyncedObj("profile.journal.options",{sort:"comments",filter:{achieve:!0,record:!0,car:!0,voc:!0,clubs:!0,events:!0,text_owner:!0,text_other:!0},showHidden:!0,discussOnly:!1,ignoreFriends:[],checkPost:function(post){return"text"==post.message.type?post.author.own?this.filter.text_owner:this.filter.text_other:this.filter[post.message.type]},getSort:function(){return privateData.beforeDate||privateData.achieve_id?"posts":this.sort},getSortField:function(){return"posts"==this.getSort()?"-date":"-last_comment_date"},getPrivate:function(){return privateData},clearPrivate:function(){privateData={}}})}).factory("ProfileJournalLoader",function(Loader,Profile,$routeParams,ProfileJournalOptions){return Loader.factory(function(beforeDate){return{summary:Profile.getSummary($routeParams.user),journal:Profile.getJournalEx($routeParams.user,ProfileJournalOptions,beforeDate).then(Loader.slowDownArray("posts",3,100,100))}})}).controller("profile:Main.JournalPage",function($scope,data,ProfileJournalOptions,ProfileJournalLoader,$routeSegment,ProfilePostDlgLauncher,$modal2,$routeParams,$location){function reload(newVal,oldVal){if(!angular.equals(newVal,oldVal)){var beforeDate=_.clone(ProfileJournalOptions.getPrivate().beforeDate||null);beforeDate&&beforeDate.setTime(beforeDate.getTime()+864e5-1),ProfileJournalLoader.load(beforeDate)}}$scope.data=data,$scope.options=ProfileJournalOptions,$scope.$watch("options",reload,!0),$scope.$watch("options.getPrivate().beforeDate",reload),$scope.$watch("options.getPrivate().achieve_id",reload),$scope.onOpenPost=function(post){$location.path("/"+post.user_id+"/journal/"+post._id)},$scope.$watch(function(){return $routeParams.post},function(postId,oldPostId){postId&&postId!==oldPostId&&ProfilePostDlgLauncher.launch(postId)})}).controller("profile:JournalOptions",function($scope,ProfileJournalOptions,$location){$scope.options=ProfileJournalOptions,$scope.onOptionSort=function(sort){$scope.options.sort=sort},$scope.onOptionFilter=function(what){$scope.options.filter[what]=!$scope.options.filter[what]},$scope.onOptionHidden=function(showHidden){$scope.options.showHidden=showHidden},$scope.onOptionDiscuss=function(){$scope.options.discussOnly=!$scope.options.discussOnly},$scope.onRemoveIgnoreFriend=function(friendId){var idx=_.indexOf($scope.options.ignoreFriends,friendId);-1!=idx&&$scope.options.ignoreFriends.splice(idx,1)},$scope.$watch("options.getPrivate().beforeDate",function(val){var today=new Date;today.setHours(0),today.setMinutes(0),today.setSeconds(0),today.setMilliseconds(0),val&&val.getTime()>=today.getTime()&&(ProfileJournalOptions.getPrivate().beforeDate=null)}),$scope.$watch(function(){return $location.search().achieve_id},function(newVal){ProfileJournalOptions.getPrivate().achieve_id=newVal})}).controller("profile:Journal",function($scope,$timeout,Profile,Me,Socket,$routeSegment,$q,ProfileJournalOptions,UserCache){var ctrl=this,emptyNewPost={text:"",checkbox:Me&&Me.id==$routeSegment.$routeParams.user?!1:void 0};ctrl.newPost=_.clone(emptyNewPost),ctrl.onAddPost=function(){return Profile.addJournalPost($routeSegment.$routeParams.user,ctrl.newPost.text,ctrl.newPost.checkbox).then(function(result){return result.ok?($scope.data.journal.posts.splice(0,0,result.post),$scope.data.journal.users[Me.id]=Me,ctrl.newPost=_.clone(emptyNewPost),void 0):$q.reject()})},ctrl.onLoadMore=function(){return Profile.getJournalEx($scope.FriendsPage?"friends":$routeSegment.$routeParams.user,ProfileJournalOptions,_.last($scope.data.journal.posts).date).then(function(data){_.complexMerge($scope.data.journal,data)})},$scope.FriendsPage?_.each($scope.data.friends,function(user){Socket.bindEventToScope($scope,sprintf("userJournal:%s/newPost",user.id),function(data){ProfileJournalOptions.checkPost(data.post)&&(UserCache.thru(data),$scope.data.journal.posts.splice(0,0,data.post),$scope.data.journal.users[data.user.id]=data.user)})}):Socket.bindEventToScope($scope,sprintf("userJournal:%s/newPost",$routeSegment.$routeParams.user),function(data){$scope.JournalPage&&!ProfileJournalOptions.checkPost(data.post)||Me&&"user"==data.post.author.type&&data.post.author.user_id==Me.id||(UserCache.thru(data),$scope.data.journal.posts.splice(0,0,data.post),$scope.data.journal.users[data.user.id]=data.user)})}).controller("profile:Journal.Post",function($scope,Me,Profile,Socket,$routeSegment,$modal2,ProfilePostDlgLoader,ProfileJournalLoader,$timeout,$q,$location,UserCache,Dialogs,ProfileJournalOptions){var ctrl=this;ctrl.newComment={text:""},ctrl.onAddComment=function(){return Profile.addJournalComment($scope.post._id,ctrl.newComment.text).then(function(result){result.ok&&(Socket.connected||($scope.post.comments.push(result.comment),$scope.post.comments_cnt++,$scope.data.journal.users[Me.id]=Me),ctrl.newComment={text:""})})},ctrl.onRemove=function(deleted){return Profile.modifyJournalPost($scope.post._id,{deleted:deleted}).then(function(result){result.ok&&($scope.post.deleted=deleted,$scope.PostDlg&&$scope.PostDlg.onDlgClose())})},ctrl.onChangeHidden=function(hidden){return Profile.modifyJournalPost($scope.post._id,{hidden:hidden}).then(function(result){result.ok&&($scope.post.private=hidden)})},ctrl.onEdit=function(){$timeout(function(){$scope.post.editing={text:$scope.post.message.text}},0)},ctrl.onEditOk=function(){return Profile.modifyJournalPost($scope.post._id,{newText:$scope.post.editing.text}).then(function(result){result.ok&&($scope.post.message.text=$scope.post.editing.text,$scope.post.message.edited_date=new Date,$scope.post.editing=void 0)
})},ctrl.onEditCancel=function(){$scope.post.editing=void 0},ctrl.onIgnoreFriend=function(){ProfileJournalOptions.ignoreFriends.push($scope.post.user_id),ProfileJournalOptions.ignoreFriends=_.uniq(ProfileJournalOptions.ignoreFriends)},$scope.onShowMoreComments=function(){return Profile.getJournalComments($scope.post._id,$scope.post.comments[0].date).then(function(result){$scope.post.comments=_.union(result.comments,$scope.post.comments),_.extend($scope.data.journal.users,result.users)})},$scope.onHideMoreComments=function(){$scope.post.comments=$scope.post.comments.splice(-3)},Socket.bindEventToScope($scope,sprintf("userJournal:%s/post:%s/newComment",$scope.post.user_id,$scope.post._id),function(data){UserCache.thru(data),$scope.post.comments.push(data.comment),$scope.post.comments_cnt++,$scope.post.last_comment_date=new Date,$scope.data.journal.users[data.user.id]=data.user}),Socket.bindEventToScope($scope,sprintf("userJournal:%s/post:%s/modify",$scope.post.user_id,$scope.post._id),function(data){_.extend($scope.post,data.post)})}).controller("profile:Journal.Post.Comment",function($scope,Me,Profile,$timeout,Socket){var ctrl=this;ctrl.onRemove=function(deleted){return Profile.modifyJournalComment($scope.post._id,$scope.comment.date,{deleted:deleted}).then(function(result){result.ok&&($scope.comment.deleted=deleted)})},ctrl.onEdit=function(){$timeout(function(){$scope.comment.editing={text:$scope.comment.text}},0)},ctrl.onEditOk=function(){return Profile.modifyJournalComment($scope.post._id,$scope.comment.date,{newText:$scope.comment.editing.text}).then(function(result){result.ok&&($scope.comment.text=$scope.comment.editing.text,$scope.comment.edited_date=new Date,$scope.comment.editing=void 0)})},ctrl.onEditCancel=function(){$scope.comment.editing=void 0};var bound;$scope.$watch("comment",function(comment){bound&&bound.remove(),bound=Socket.bindEventToScope($scope,sprintf("userJournal:%s/post:%s/comment:%s/modify",$scope.post.user_id,$scope.post._id,comment.date.getTime()),function(data){_.extend(comment,data.comment)})})}).factory("ProfilePostDlgLauncher",function($modal2,ProfilePostDlgLoader,$routeParams,$routeSegment,$location){return{launch:function(postId,backUri){backUri=backUri||"/journal/";var modal=$modal2.open({templateUrl:"/views/partials/profile/journal/modal.html?bust=1413116880766",controller:"profile:PostDlg as PostDlg",resolve:{data:function(){return ProfilePostDlgLoader.load(postId)}}});modal.result.finally(function(){$routeParams.post==postId&&$location.path("/"+$routeSegment.$routeParams.user+backUri)})}}}).factory("ProfilePostDlgLoader",function(Loader,Profile){return Loader.factory(function(postId){return{journal:Profile.getJournalPost(postId)}})}).controller("profile:PostDlg",function($scope,$modalInstance,data,$routeSegment,$routeParams,$timeout,Profile){$scope.$routeSegment=$routeSegment,$scope.data=data,$scope.post=data.journal.post,$modalInstance.post=$scope.post,$scope.allowDownloadTsf=!1,Profile.getSummary($scope.post.user_id).then(function(summary){$scope.allowDownloadTsf=summary.user.checkVisitorPermission("stats.allow_download_tsf",summary.is_friend)}),this.onDlgClose=function(){$modalInstance.close()},$routeParams.post==data.journal.post._id&&$scope.$watch(function(){return $routeParams.post},function(postId){postId!=data.journal.post._id&&$timeout(function(){$modalInstance.dismiss()},0)}),$scope.$watch(function(){return $routeSegment.name},function(name,oldName){"main.journal"!=name&&"main.achieves.done"!=name&&name!=oldName&&$timeout(function(){$modalInstance.dismiss()},0)})}).directive("appProfileJournalRoot",function(){return{controller:function(){this.writeCommentAt=null},link:function(){}}}).directive("appProfileJournalWriteToggle",function(){return{require:"^appProfileJournalRoot",link:function($scope,elm,attrs,appProfileJournalRoot){var postId=$scope.$eval(attrs.appProfileJournalWriteToggle);elm.click(function(){appProfileJournalRoot.writeCommentAt=postId,$scope.$apply()})}}}).directive("appProfileJournalWrite",function($animate,$timeout,Me){return{restrict:"E",require:"^appProfileJournalRoot",templateUrl:"/views/partials/profile/journal/write.html?bust=1413116880766",replace:!0,scope:{writeId:"=",alwaysShow:"=",showPlaceholder:"=",placeholderText:"@",writeModel:"=",submitFn:"=",cancelFn:"=",canCancel:"=",checkboxLabel:"@",autofocus:"=",markedType:"="},link:function($scope,elm,attrs,appProfileJournalRoot){function onSubmit(e){e.preventDefault(),$scope.writeModel.text.length&&(elm.find("button.send").addClass("striped"),$scope.submitFn().then(function(){$scope.alwaysShow||(appProfileJournalRoot.writeCommentAt=null)})["finally"](function(){elm.find("button.send").removeClass("striped"),$scope.isPreview=!1}))}$scope.Me=Me,$scope.hasAvatar=void 0!==attrs.hasAvatar;var oldShow=!1;$scope.$watchCollection(function(){return[appProfileJournalRoot.writeCommentAt,$scope.showPlaceholder,$scope.alwaysShow]},function(val){var show=val[0]==$scope.writeId||val[2];val[1]?($animate[show?"removeClass":"addClass"](elm.find(".post"),"ng-hide"),$animate[show?"addClass":"removeClass"](elm.find(".placeholder"),"ng-hide"),$animate.removeClass(elm,"ng-hide")):$animate[show?"removeClass":"addClass"](elm,"ng-hide"),$scope.autofocus&&show&&!oldShow&&elm.find("textarea").focus(),oldShow=show}),!$scope.alwaysShow,$scope.onCancelClick=function(){$scope.alwaysShow||(appProfileJournalRoot.writeCommentAt=null,$scope.writeModel.text="",$scope.isPreview=!1),$scope.cancelFn&&$scope.cancelFn()},elm.find("textarea").keydown(function(event){(event.ctrlKey||event.shiftKey)&&13==event.keyCode&&(event.preventDefault(),this.value&&onSubmit())}),elm.find("form").submit(onSubmit)}}}).filter("gameTextErrorize",function($sce){return function(val){return $sce.trustAsHtml(val.replace(/~E~(.*?)~~~(.*?)~\/E~/g,'<span class="error-incorrect">$1</span><span class="error-correct">$2</span>'))}}),angular.module("app.profile.messages",["app.profile.messages.main","app.profile.messages.contacts","app.profile.messages.respondent"]),angular.module("app.profile.messages.main",["route-segment","view-segment","lib.api.profile","lib.ui.smilies"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&($routeProvider.when("/:user/messages/",{redirectTo:"/:user/messages/contacts/"}),$routeSegmentProvider.within("main").segment("messages",{templateUrl:"/views/partials/profile/messages.html?bust=1413116880766",controller:"profile:Main.MessagesPage as MessagesPage",dependencies:["user"]}))}).controller("profile:Main.MessagesPage",function(){}),angular.module("app.profile.messages.contacts",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/messages/contacts/","main.messages.contacts").within("main").within("messages").segment("contacts",{templateUrl:"/views/partials/profile/messages/contacts.html?bust=1413116880766",controller:"profile:Main.MessagesPage.Contacts as Contacts",dependencies:["user"],resolve:{data:function(ProfileMessagesContactsLoader){return ProfileMessagesContactsLoader.load()}}})}).factory("ProfileMessagesContactsLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),contacts:Profile.getMessagesContacts()}})}).controller("profile:Main.MessagesPage.Contacts",function($scope,data,Profile,Loader,ProfileMessagesContactsLoader){var ctrl=this;$scope.data=data,ctrl.onLoadMore=function(){return Profile.getMessagesContactsBeforeDate(_.last(data.contacts.messages).date).then(function(moreContactsData){_.complexMerge(data.contacts,moreContactsData)})},ctrl.onSetAllRead=function(){return Profile.setMessageContactRead(0).then(function(){return ProfileMessagesContactsLoader.load()})}}).controller("profile:Main.MessagesPage.Contacts.ContactItem",function($scope,$routeSegment,$location,Socket,$timeout,Profile,Dialogs,Loader,ProfileMessagesContactsLoader){var ctrl=this;$scope.onOpen=function(){$scope.message.unread&&"in"==$scope.message.folder&&$scope.data.summary.unread_messages--,$location.path(sprintf("/%s/messages/%s/",$routeSegment.$routeParams.user,$scope.message.respondent_id))},ctrl.onIgnore=function(){Dialogs.ignoreUser($scope.data.contacts.users[$scope.message.respondent_id])},ctrl.onComplain=function(){Dialogs.complainUser($scope.data.contacts.users[$scope.message.respondent_id])},ctrl.onSetRead=function(){Loader.loading(Profile.setMessageContactRead($scope.message.respondent_id).then(function(){"in"==$scope.message.folder&&($scope.message.unread=0)}))},ctrl.onRemoveHistory=function(){Dialogs.ask("Удалить историю переписки","Вы действительно хотите удалить все сообщения из переписки с этим пользователем?").then(function(){Loader.loading(Profile.removeMessageHistory($scope.message.respondent_id).then(function(){return ProfileMessagesContactsLoader.load()}))})},Socket.bindEventToScope($scope,sprintf("messages:%s/respondent:%s/read",$routeSegment.$routeParams.user,$scope.message.respondent_id),function(data){$scope.message.id==data.message_id&&$timeout(function(){$scope.message.unread=0},300)}),Socket.bindEventToScope($scope,sprintf("messages:%s/newMessage",$routeSegment.$routeParams.user),function(){Profile.getMessagesContacts().then(function(data){$scope.data.contacts=data})})}),angular.module("app.profile.messages.respondent",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/messages/:respondent/","main.messages.respondent").within("main").within("messages").segment("respondent",{templateUrl:"/views/partials/profile/messages/respondent.html?bust=1413116880766",controller:"profile:Main.MessagesPage.Respondent as Respondent",dependencies:["user","respondent"],resolveFailed:{templateUrl:"/views/partials/resolve-failed.html?bust=1413116880766"},resolve:{data:function(ProfileMessagesLoader){return ProfileMessagesLoader.load()}}})}).factory("ProfileMessagesLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),dialog:Profile.getMessagesDialog($routeParams.respondent),respondent_summary:Profile.getSummary($routeParams.respondent)}})}).controller("profile:Main.MessagesPage.Respondent",function($scope,data,Profile,$routeSegment,Socket,$timeout,Dialogs,$interval,Loader,$location){var ctrl=this;if($scope.data=data,!data.dialog)throw new Error("invalid respondent");ctrl.messageText={text:""},ctrl.onSend=function(){return ctrl.messageText.text?Profile.sendMessage($routeSegment.$routeParams.respondent,ctrl.messageText.text).then(function(result){result.ok&&($scope.data.dialog.messages.push(result.message),ctrl.messageText.text="")}):void 0},ctrl.onType=_.throttle(function(){Profile.setMessageTyping($routeSegment.$routeParams.respondent)},3e3,{trailing:!1}),ctrl.onLoadMore=function(){return Profile.getMessagesDialogBeforeDate($routeSegment.$routeParams.respondent,$scope.data.dialog.messages[0].date).then(function(data){$scope.$broadcast("save scroll"),$timeout(function(){$scope.data.dialog.messages=_.union(data.messages,$scope.data.dialog.messages),$scope.data.dialog.more_messages_cnt=data.more_messages_cnt},0)})},ctrl.onFriendRequest=function(){Dialogs.friendRequest($routeSegment.$routeParams.respondent)},ctrl.onFriendRemove=function(){Dialogs.friendRemove($routeSegment.$routeParams.respondent).then(function(){$scope.data.respondent_summary.is_friend=!1})},ctrl.onSendScores=function(){Dialogs.sendUserMessage($routeSegment.$routeParams.respondent,!0)},ctrl.onIgnore=function(){Dialogs.ignoreUser($scope.data.respondent_summary.user)},ctrl.onComplain=function(){Dialogs.complainUser($scope.data.respondent_summary.user)},ctrl.onRemoveHistory=function(){Dialogs.ask("Удалить историю переписки","Вы действительно хотите удалить все сообщения из переписки с этим пользователем?").then(function(){Loader.loading(Profile.removeMessageHistory($routeSegment.$routeParams.respondent).then(function(){$location.path("/"+$routeSegment.$routeParams.user+"/messages/")}))})},Socket.bindEventToScope($scope,sprintf("messages:%s/respondent:%s/newMessage",$routeSegment.$routeParams.user,$routeSegment.$routeParams.respondent),function(data){$scope.data.dialog.messages.push(data.message),ctrl.typing=!1});var typingTimeout=null;Socket.bindEventToScope($scope,sprintf("messages:%s/respondent:%s/typing",$routeSegment.$routeParams.user,$routeSegment.$routeParams.respondent),function(){ctrl.typing=!0,typingTimeout&&$timeout.cancel(typingTimeout),typingTimeout=$timeout(function(){ctrl.typing=!1},3500)}),Socket.bindEventToScope($scope,sprintf("messages:%s/respondent:%s/read",$routeSegment.$routeParams.user,$routeSegment.$routeParams.respondent),function(data){function removeUnread(){var message=_.find($scope.data.dialog.messages,{id:data.message_id});return message?($timeout(function(){message.unread=0},300),!0):!1}if(!removeUnread())var interval=$interval(function(){removeUnread()&&$interval.cancel(interval)},500,10)})}).controller("profile:Main.MessagesPage.Respondent.Message",function($scope,Profile,$timeout){var ctrl=this;ctrl.onRemove=function(deleted){Profile.removeMessage($scope.message.id,deleted).then(function(){$scope.message.deleted=deleted})},"in"==$scope.message.folder&&$scope.message.unread&&(Profile.setMessageRead($scope.message.id),$timeout(function(){$scope.message.unread=0},300))}),function(){function prefDirective(type){var attrName="private"==type?"appProfilePrivatePref":"appProfilePublicPref";return function($compile,Profile,Loader){return{link:function($scope,elm,attrs){var watch=("private"==type?"data.prefs.":"data.summary.user.public_prefs.")+attrs[attrName],newElm=elm.clone();newElm.attr("ng:model",watch),newElm.removeAttr("app:profile-"+type+"-pref");var link=$compile(newElm);link($scope),elm.replaceWith(newElm),$scope.$watch(watch,function(newVal,oldVal){newVal!=oldVal&&Loader.loading("private"==type?Profile.setPrivatePref(attrs[attrName],newVal):Profile.setPublicPref(attrs[attrName],newVal))})}}}}var mod=angular.module("app.profile.prefs",["route-segment","view-segment","app.profile.index","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/prefs/","main.prefs").within("main").segment("prefs",{templateUrl:"/views/partials/profile/prefs.html?bust=1413116880766",controller:"profile:Main.Prefs as Prefs",dependencies:["user"],resolve:{data:function(ProfilePrefsLoader){return ProfilePrefsLoader.load()}}})}).factory("ProfilePrefsLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),prefs:Profile.getPrivatePrefs($routeParams.user),ignore:Profile.getIgnoreList()}})}).controller("profile:Main.Prefs",function($scope,$q,data,$routeSegment,Profile,$timeout,Loader,Dialogs,ProfileMainLoader,$modal2,ProfilePrefsLoader){var loadingPromise,ctrl=this;$scope.data=data,$scope.onSave=function(){return $q.defer().promise},$scope.$watch("data.prefs.show_online",function(val,oldVal){val!=oldVal&&$timeout(function(){loadingPromise.then(function(){return Profile.getSummary($routeSegment.$routeParams.user,{clearCache:!0})})},10)}),ctrl.prefStatsRecord="0"===getPrefCookie("stats_record")?"off":"on",$scope.$watch("Prefs.prefStatsRecord",function(newVal){setPrefCookie("stats_record","on"==newVal?1:0)}),$scope.$watch("data.summary.user.public_prefs.stats.allow_view",function(newVal){$scope.data.summary.user.public_prefs.stats.allow_view_data<newVal&&($scope.data.summary.user.public_prefs.stats.allow_view_data=newVal)}),$scope.$watch("data.summary.user.public_prefs.stats.allow_view_data",function(newVal){$scope.data.summary.user.public_prefs.stats.allow_view_detailed<newVal&&($scope.data.summary.user.public_prefs.stats.allow_view_detailed=newVal)}),$scope.$watch("data.summary.notify_news",function(newVal,oldVal){newVal!=oldVal&&Profile.setNotifyNews(newVal)}),ctrl.getPermissionOptionsUnder=function(parentOption){return"all"==parentOption?[{all:"Всем"},{friends:"Только друзьям"},{none:"Только мне"}]:"friends"==parentOption?[{friends:"Только друзьям"},{none:"Только мне"}]:"none"==parentOption?[{none:"Только мне"}]:void 0},ctrl.onRemoveAvatar=function(){return Dialogs.ask("Удалить аватар","Вы хотите удалить загруженное изображение и сбросить аватар?").then(function(){return Profile.removeAvatar()}).then(function(){return ProfileMainLoader.load()})},ctrl.onChangePassword=function(){return $modal2.open({templateUrl:"/views/partials/profile/prefs/dlg-change-password.html?bust=1413116880766",controller:"profile:DlgPrefsChangePassword as DlgPrefsChangePassword"})},ctrl.onChangeEmail=function(){return $modal2.open({templateUrl:"/views/partials/profile/prefs/dlg-change-email.html?bust=1413116880766",controller:"profile:DlgPrefsChangeEmail as DlgPrefsChangeEmail"}).result.then(function(newEmail){data.summary.emails.new=newEmail})},ctrl.onChangeLogin=function(){return $modal2.open({templateUrl:"/views/partials/profile/prefs/dlg-change-login.html?bust=1413116880766",controller:"profile:DlgPrefsChangeLogin as DlgPrefsChangeLogin"}).result.then(function(newLogin){data.summary.user.login=newLogin})},ctrl.onRemoveIgnore=function(userId){return Profile.ignoreRemove(userId).then(function(){ProfilePrefsLoader.load()})},ctrl.onShowUserbars=function(){return $modal2.open({templateUrl:"/views/partials/profile/prefs/dlg-show-userbars.html?bust=1413116880766",controller:"profile:DlgPrefsShowUserbars as DlgPrefsShowUserbars"})}}).controller("profile:DlgPrefsChangePassword",function($scope,$modalInstance,Profile){var ctrl=this;ctrl.oldPassword="",ctrl.newPassword="",ctrl.newPasswordConfirm="",$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onOK=function(){return Profile.changePassword(ctrl.oldPassword,ctrl.newPassword).then(function(){$modalInstance.close()})},$scope.isOK=function(){return""!=ctrl.oldPassword&&""!=ctrl.newPassword&&ctrl.newPassword==ctrl.newPasswordConfirm}}).controller("profile:DlgPrefsChangeEmail",function($scope,$modalInstance,Profile){var ctrl=this;ctrl.email="",$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onOK=function(){return Profile.changeEmail(ctrl.email).then(function(){$modalInstance.close(ctrl.email)})},$scope.isOK=function(){return""!=ctrl.email}}).controller("profile:DlgPrefsChangeLogin",function($scope,$modalInstance,Profile,Me){var ctrl=this;ctrl.login=Me.login,ctrl.error="",$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onOK=function(){return Profile.changeLogin(ctrl.login).then(function(){$modalInstance.close(ctrl.login)},function(error){ctrl.error=error})},$scope.isOK=function(){return ctrl.login.length>=3}}).controller("profile:DlgPrefsShowUserbars",function($scope,$modalInstance,Profile){function getRand(){return Math.floor(100*Math.random())}$scope.barcode=0,$scope.rand=getRand(),$scope.userbars=[];for(var i=1;7>i;i++)$scope.userbars.push(i);$scope.onClose=function(){$modalInstance.dismiss()},$scope.onClickUserbar=function(index){$scope.barcode=index==$scope.barcode?0:index},$scope.onRefreshUserbars=function(){return Profile.refreshUserbars().then(function(){$scope.rand=getRand()})}});mod.directive("appProfilePrivatePref",prefDirective("private")),mod.directive("appProfilePublicPref",prefDirective("public")),mod.directive("appProfilePrefsUploadAvatar",function(Profile,ProfileMainLoader){return{link:function($scope,elm){elm.find('input[type="file"]').change(function(e){elm.addClass("striped");var reader=new FileReader;reader.onload=function(event){Profile.setAvatar(event.target.result).then(function(){return ProfileMainLoader.load()})["finally"](function(){elm.removeClass("striped")})},reader.readAsDataURL(e.target.files[0])})}}})}(),angular.module("app.profile.stats",["app.profile.stats.main","app.profile.stats.overview","app.profile.stats.details"]),angular.module("app.profile.stats.main",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.within("main").segment("stats",{templateUrl:"/views/partials/profile/stats.html?bust=1413116880766",controller:"profile:Main.StatsPage as StatsPage",dependencies:["user"]})}).controller("profile:Main.StatsPage",function(){}).factory("GoogleVisualizationLoader",function($q,Loader){var deferred=$q.defer();return Loader.factory(function(){return google.load("visualization","1",{packages:["corechart","table"],callback:function(){deferred.resolve(google.visualization)}}),deferred.promise})}).directive("appChartPie",function(GoogleVisualizationLoader){return{scope:{chartDataTable:"=",chartSlices:"=",chartSelection:"=",chartClick:"&"},link:function($scope,elm){GoogleVisualizationLoader.getPromise().then(function(lib){function draw(){chart.draw($scope.chartDataTable,{chartArea:{left:0,top:0,width:"100%",height:"100%"},legend:"none",is3D:!0,slices:$scope.chartSlices,pieSliceText:"value",fontSize:11})}var chart=new lib.PieChart(elm[0]);draw(),$scope.$on("appChart.redraw",draw),lib.events.addListener(chart,"select",function(){$scope.$apply(function(){var selection=chart.getSelection();selection.length&&$scope.chartClick({row:selection[0].row})})}),lib.events.addListener(chart,"onmouseover",function(item){$scope.$apply(function(){$scope.chartSelection=item.row})}),lib.events.addListener(chart,"onmouseout",function(){$scope.$apply(function(){$scope.chartSelection=null})}),$scope.$watch("chartSelection",function(newVal){chart.setSelection([{row:newVal}])})})}}}).directive("appChartTable",function(GoogleVisualizationLoader,$timeout,Dialogs,Profile,$routeSegment){return{scope:{chartDataTable:"=",chartSelection:"=",chartClick:"&",chartOptions:"&"},link:function($scope,elm){GoogleVisualizationLoader.getPromise().then(function(lib){function setup(){$timeout(function(){_.each(elm.find(".google-visualization-table-table tr"),function(tr,i){if(i){var m=$(tr).find("td:first-child").attr("class").match(/row(\d+)/),selection=parseInt(m[1]);$(tr).hover(function(){$scope.$apply(function(){$scope.chartSelection=selection})},function(){$scope.$apply(function(){$scope.chartSelection=null})}),$(tr).find(".del").click(function(){$scope.$apply(function(){var id=$scope.chartDataTable.getValue(selection,2);Dialogs.ask("Удалить результат","Удалить результат #"+id+"?",function(){return Profile.deleteStatsResult(id)}).then(function(){$routeSegment.chain[3].reload()})})}),$(tr).find("a.tsf").each(function(){var id=$scope.chartDataTable.getValue(selection,1);$(this).attr("href","/api/profile/download-record-tsf?userId="+$routeSegment.$routeParams.user+"&id="+id)})}})},0)}for(var chart=new lib.Table(elm[0]),options=_.extend({chartArea:{left:0,top:0,width:"100%",height:"100%"},allowHtml:!0},$scope.chartOptions()),i=0;i<$scope.chartDataTable.getNumberOfRows();i++)$scope.chartDataTable.setProperty(i,0,"className","google-visualization-table-td row"+i);chart.draw($scope.chartDataTable,options),lib.events.addListener(chart,"select",function(){$scope.$apply(function(){$scope.chartClick({row:$scope.chartSelection})})}),$scope.$watch("chartSelection",function(newVal){chart.setSelection([{row:newVal,column:null}])}),setup(),lib.events.addListener(chart,"sort",setup)})}}}).directive("appChartCombo",function(GoogleVisualizationLoader){return{scope:{chartDataTable:"=",chartSelection:"=",chartOptions:"&",chartClick:"&"},link:function($scope,elm){GoogleVisualizationLoader.getPromise().then(function(lib){function draw(){var options=_.extend({chartArea:{left:0,top:0,width:"100%",height:"100%"},focusTarget:"category",vAxis:{textPosition:"in"},hAxis:{textPosition:"in"},legend:"none",isStacked:!0},$scope.chartOptions());chart.draw($scope.chartDataTable,options)}var chart=new lib.ComboChart(elm[0]);draw(),$scope.$on("appChart.redraw",draw),lib.events.addListener(chart,"select",function(){$scope.$apply(function(){$scope.chartClick({row:$scope.chartSelection})})}),lib.events.addListener(chart,"onmouseover",function(item){$scope.$apply(function(){$scope.chartSelection=item.row})}),lib.events.addListener(chart,"onmouseout",function(){$scope.$apply(function(){$scope.chartSelection=null})}),$scope.$watch("chartSelection",function(newVal){chart.setSelection([{row:newVal}])})})}}}).directive("appChartLine",function(GoogleVisualizationLoader){return{scope:{chartDataTable:"=",chartSelection:"=",chartOptions:"&"},link:function($scope,elm){GoogleVisualizationLoader.getPromise().then(function(lib){function draw(){var options=_.extend({chartArea:{left:0,top:0,width:"100%",height:"100%"},focusTarget:"category",vAxis:{textPosition:"in"},hAxis:{textPosition:"in"},legend:"none"},$scope.chartOptions());chart.draw($scope.chartDataTable,options)}var chart=new lib.LineChart(elm[0]);draw(),$scope.$on("appChart.redraw",draw),lib.events.addListener(chart,"onmouseover",function(item){$scope.$apply(function(){$scope.chartSelection=item.row})}),lib.events.addListener(chart,"onmouseout",function(){$scope.$apply(function(){$scope.chartSelection=null})}),$scope.$watch("chartSelection",function(newVal){chart.setSelection([{row:newVal}])})})}}}),angular.module("app.profile.stats.details",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/stats/:gametype/","main.stats.details.charts").within("main").within("stats").segment("details",{templateUrl:"/views/partials/profile/stats/details.html?bust=1413116880766",controller:"profile:Main.StatsPage.Details as Details",dependencies:["user","gametype"],resolveFailed:{templateUrl:"/views/partials/resolve-failed.html?bust=1413116880766"},resolve:{data:function(ProfileStatsDetailedLoader){return ProfileStatsDetailedLoader.load()},GoogleVisualization:function(GoogleVisualizationLoader){return GoogleVisualizationLoader.load()}}}).within().segment("charts",{templateUrl:"/views/partials/profile/stats/details-charts.html?bust=1413116880766",controller:"profile:Main.StatsPage.Details.Charts as Charts",dependencies:["user","gametype"],resolveFailed:{templateUrl:"/views/partials/resolve-failed.html?bust=1413116880766"},resolve:{data:function(ProfileStatsDetailedChartsLoader){return ProfileStatsDetailedChartsLoader.load()},GoogleVisualization:function(GoogleVisualizationLoader){return GoogleVisualizationLoader.load()}}})}).factory("ProfileStatsDetailedLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),details:Profile.getStatsDetails($routeParams.user,$routeParams.gametype)}})}).controller("profile:Main.StatsPage.Details",function($scope,data,GoogleVisualization,GametypeColors,$location,$routeSegment,ProfileStatsDetailedChartsLoader,ProfilePostDlgLauncher,$window,$modal2,ProfileStatsDlgBookPartsLoader){function parseDate(value){var m=value.match(/^(\d{4})-(\d{2})-(\d{2})$/);return m?new Date(m[1],m[2]-1,m[3]):null}var ctrl=this;ctrl.data=data,ctrl.onJournalSelect=function(postId){ProfilePostDlgLauncher.launch(postId)},ctrl.chartParams={fromDate:$location.search().fromDate?parseDate($location.search().fromDate):new Date((data.details.start_date||new Date).getTime()),toDate:$location.search().toDate?parseDate($location.search().toDate):new Date,indicator:$location.search().indicator||"speed"};var interval=ctrl.chartParams.toDate.getTime()-ctrl.chartParams.fromDate.getTime();ctrl.chartParams.grouping=$location.search().grouping||(interval>864e7?"week":"day"),ctrl.setChartPeriod=function(period){if("today"==period)ctrl.chartParams.fromDate=new Date,ctrl.chartParams.toDate=new Date,ctrl.chartParams.grouping="none";else if("all"==period){ctrl.chartParams.fromDate=new Date(ctrl.data.details.start_date.getTime()),ctrl.chartParams.toDate=new Date;var interval=ctrl.chartParams.toDate.getTime()-ctrl.chartParams.fromDate.getTime();ctrl.chartParams.grouping=interval>864e7?"week":"day"}else ctrl.chartParams.toDate=new Date,ctrl.chartParams.fromDate=new Date,ctrl.chartParams.fromDate.setTime(ctrl.chartParams.fromDate.getTime()-1e3*3600*24*period),ctrl.chartParams.grouping=period>100?"week":"day"},ctrl.onGotoVoc=function(vocId){$window.location.href="/vocs/"+vocId},ctrl.getBookRepeat=function(){return _.times(Math.ceil(17*data.details.book_info.done/data.details.book_info.total),function(){return 0})},ctrl.onOpenBookParts=function(){$modal2.open({templateUrl:"/views/partials/profile/stats/dlg-book-parts.html?bust=1413116880766",controller:"profile:DlgBookParts as DlgBookParts",resolve:{data:function(){return ProfileStatsDlgBookPartsLoader.load(data.details.gametype.id)}}})},ctrl.getBestSpeed=function(minTime,maxTime){var best=0;if(data.details.journal&&_.each(data.details.journal,function(item){best<item.message.speed&&item.date.getTime()>=minTime&&item.date.getTime()<=maxTime&&(best=item.message.speed)}),data.details.best_speed_post){var post=data.details.best_speed_post;best<data.details.info.best_speed&&post.date.getTime()>=minTime&&post.date.getTime()<=maxTime&&(best=data.details.info.best_speed)}return best},$scope.$watch("Details.chartParams.fromDate.getTime()",function(){(ctrl.chartParams.fromDate.getTime()>ctrl.chartParams.toDate.getTime()||"none"==ctrl.chartParams.grouping)&&(ctrl.chartParams.toDate=new Date(ctrl.chartParams.fromDate.getTime()))}),$scope.$watch("Details.chartParams.toDate.getTime()",function(){(ctrl.chartParams.fromDate.getTime()>ctrl.chartParams.toDate.getTime()||"none"==ctrl.chartParams.grouping)&&(ctrl.chartParams.fromDate=new Date(ctrl.chartParams.toDate.getTime()))}),$scope.$watch("Details.chartParams.grouping",function(){var interval=ctrl.chartParams.toDate.getTime()-ctrl.chartParams.fromDate.getTime();"none"==ctrl.chartParams.grouping&&interval>=864e5&&(ctrl.chartParams.fromDate=new Date(ctrl.chartParams.toDate.getTime()))}),$scope.$watchCollection("[Details.chartParams.fromDate.getTime(), Details.chartParams.toDate.getTime(), Details.chartParams.grouping, Details.chartParams.indicator]",function(){$location.search({fromDate:ctrl.chartParams.fromDate.format("yyyy-mm-dd","msk"),toDate:ctrl.chartParams.toDate.format("yyyy-mm-dd","msk"),grouping:ctrl.chartParams.grouping,indicator:ctrl.chartParams.indicator}).replace(),$routeSegment.chain[3]&&$routeSegment.chain[3].reload()}),ProfileStatsDetailedChartsLoader.params=ctrl.chartParams}).factory("ProfileStatsDlgBookPartsLoader",function(Loader,Profile,$routeSegment){return Loader.factory(function(vocId){return{parts:Profile.getBookParts($routeSegment.$routeParams.user,vocId)}})}).controller("profile:DlgBookParts",function($scope,$modalInstance,data){var ctrl=this;ctrl.d=data,$scope.onCancel=function(){$modalInstance.dismiss()}}).factory("ProfileStatsDetailedChartsLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{detailsData:Profile.getStatsDetailsData($routeParams.user,$routeParams.gametype,this.params.fromDate,this.params.toDate,this.params.grouping)}})}).controller("profile:Main.StatsPage.Details.Charts",function($scope,data,GoogleVisualization,Profile,$routeParams,ProfileStatsDetailedChartsLoader){var ctrl=this;ctrl.data=data,ctrl.loaderParams=ProfileStatsDetailedChartsLoader.params,ctrl.GoogleVisualization=GoogleVisualization,ctrl.onExportData=function(){Profile.exportStatsDetailsData($routeParams.user,$routeParams.gametype,ctrl.loaderParams.fromDate,ctrl.loaderParams.toDate,ctrl.loaderParams.grouping)}}).controller("profile:Main.StatsPage.Details.Charts.Plain",function($scope,$location,$routeSegment,$filter,Me){var dataTable,rows,ctrl=this;ctrl.selection=null,ctrl.dataTables={},dataTable=new $scope.Charts.GoogleVisualization.DataTable,dataTable.addColumn("string","ID"),dataTable.addColumn("number","Скорость"),dataTable.addColumn({role:"annotation",type:"string"}),dataTable.addColumn("number","Ошибки"),$scope.Details.data.details.info.qual&&(dataTable.addColumn("number","Порог"),dataTable.addColumn({role:"certainty",type:"boolean"})),rows=_.map($scope.Charts.data.detailsData.list,function(i){var best=$scope.Details.getBestSpeed(i.date.getTime()-2e3,i.date.getTime()+2e3),result=["#"+i.id,i.speed,best?""+best:null,i.error_rate];
return $scope.Details.data.details.info.qual&&(result.push(1.2*$scope.Details.data.details.info.qual),result.push(!1)),result}),dataTable.addRows(rows);for(var i=0;i<rows.length;i++)dataTable.setFormattedValue(i,0,$scope.Charts.data.detailsData.list[i].date.format("dd mmm yyyy г., HH:MM:ss","msk","msk"));new $scope.Charts.GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(dataTable,2),ctrl.dataTables.graph=dataTable,dataTable=new $scope.Charts.GoogleVisualization.DataTable,dataTable.addColumn("string",""),dataTable.addColumn("number",""),dataTable.addColumn("number","ID"),dataTable.addColumn("datetime",'Дата<sup title="Все даты указаны по московскому времени">?</sup>'),dataTable.addColumn("number","Скорость"),dataTable.addColumn("number","Время"),dataTable.addColumn("number","Ошибки"),dataTable.addColumn("number","% ошибок"),rows=_.map($scope.Charts.data.detailsData.list,function(i){return["",i.tsf_id,i.id,i.date,i.speed,i.time,i.errors,i.error_rate]}),dataTable.addRows(rows);for(var i=0;i<rows.length;i++)dataTable.setProperty(i,2,"style","color: #999; font-size: 11px;"),dataTable.setFormattedValue(i,3,$scope.Charts.data.detailsData.list[i].date.format("dd mmm yyyy г., HH:MM:ss","msk")),dataTable.setFormattedValue(i,5,$filter("timeFromSeconds")(dataTable.getValue(i,5))),Me&&Me.id==$routeSegment.$routeParams.user&&dataTable.setFormattedValue(i,0,'<i class="del" title="Удалить результат"></i>'),dataTable.getValue(i,1)&&($scope.data.summary.user.checkVisitorPermission("stats.allow_download_tsf",$scope.data.summary.is_friend)?dataTable.setFormattedValue(i,1,'<a class="tsf" title="Скачать клавограмму" target="_blank"></a>'):dataTable.setFormattedValue(i,1,'<i class="tsf"></i>'));new $scope.Charts.GoogleVisualization.NumberFormat({prefix:"#",groupingSymbol:"",fractionDigits:0}).format(dataTable,2),new $scope.Charts.GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(dataTable,7),ctrl.dataTables.table=dataTable}).controller("profile:Main.StatsPage.Details.Charts.Aggregated",function($scope){var dataTable,rows,ctrl=this;if(ctrl.selection=null,ctrl.dataTables={},dataTable=new $scope.Charts.GoogleVisualization.DataTable,dataTable.addColumn("datetime","Дата"),dataTable.addColumn({role:"tooltip",type:"string",p:{html:!0}}),"num_races"==$scope.Charts.loaderParams.indicator){var cnt=0;dataTable.addColumn("number","Пробег"),rows=_.map($scope.Charts.data.detailsData.list,function(i){return cnt+=parseInt(i.cnt),[i.min_date,sprintf('<div class="chart-tooltip"><h4>%s</h4><dl><dt>Пробег:</dt><dd>%s %s</dd></dl></div>',i.min_date.format("dd mmm yyyy г.","msk"),cnt,pluralForm(cnt,"текст","текста","текстов")),cnt]})}else dataTable.addColumn("number","Мин."),dataTable.addColumn("number","Макс."),"speed"==$scope.Charts.loaderParams.indicator&&dataTable.addColumn({role:"annotation",type:"string"}),dataTable.addColumn("number","Ср.А."),dataTable.addColumn("number","Ср.С."),dataTable.addColumn("number","Пробег"),dataTable.addColumn("number","Пробег"),"speed"==$scope.Charts.loaderParams.indicator&&$scope.Details.data.details.info.qual&&(dataTable.addColumn("number","Квалификация"),dataTable.addColumn({role:"certainty",type:"boolean"})),rows=_.map($scope.Charts.data.detailsData.list,function(i){var dateStr="week"==$scope.Charts.loaderParams.grouping?i.min_date.format("dd mmm","msk")+" - "+i.max_date.format("dd mmm yyyy г.","msk"):i.min_date.format("dd mmm yyyy г.","msk");if("speed"==$scope.Charts.loaderParams.indicator){var best=$scope.Details.getBestSpeed(i.min_date.getTime(),(i.max_date||i.min_date).getTime()+864e5),result=[i.min_date,sprintf('<div class="chart-tooltip"><h4>%s</h4><dl><dt>Макс.:</dt><dd>%s зн/мин</dd></dl><dl><dt>Ср.А.:</dt><dd>%d зн/мин</dd></dl><dl><dt>Ср.С.:</dt><dd>%d зн/мин</dd></dl><dl><dt>Мин.:</dt><dd>%s зн/мин</dd></dl><dl><dt>Пробег:</dt><dd>%s %s</dd></dl></div>',dateStr,i.max_speed,i.avg_speed,i.avg_speed_end,i.min_speed,i.cnt,pluralForm(i.cnt,"текст","текста","текстов")),i.min_speed,i.max_speed-i.min_speed,best?""+best:null,i.avg_speed,i.avg_speed_end,parseInt(i.cnt),2*parseInt(i.cnt)];return $scope.Details.data.details.info.qual&&(result.push(1.2*$scope.Details.data.details.info.qual),result.push(!1)),result}return[i.min_date,sprintf('<div class="chart-tooltip"><h4>%s</h4><dl><dt>Макс.:</dt><dd>%.2f%%</dd></dl><dl><dt>Ср.А.:</dt><dd>%.2f%%</dd></dl><dl><dt>Ср.С.:</dt><dd>%.2f%%</dd></dl><dl><dt>Мин.:</dt><dd>%.2f%%</dd></dl><dl><dt>Пробег:</dt><dd>%s</dd></dl></div>',dateStr,i.max_errors,i.avg_errors,i.avg_errors_end,i.min_errors,i.cnt,pluralForm(i.cnt,"текст","текста","текстов")),i.min_errors,i.max_errors-i.min_errors,i.avg_errors,i.avg_errors_end,parseInt(i.cnt),2*parseInt(i.cnt)]});dataTable.addRows(rows),ctrl.dataTables.graph=dataTable,dataTable=new $scope.Charts.GoogleVisualization.DataTable,dataTable.addColumn("date",'Дата<sup title="Все даты указаны по московскому времени">?</sup>'),dataTable.addColumn("number","Мин."),dataTable.addColumn("number",'Ср.А.<sup title="Среднее арифметическое за период">?</sup>'),dataTable.addColumn("number",'Ср.С.<sup title="Среднее скользящее на конец периода">?</sup>'),dataTable.addColumn("number","Макс."),dataTable.addColumn("number","Пробег"),rows=_.map($scope.Charts.data.detailsData.list,function(i){return"speed"==$scope.Charts.loaderParams.indicator?[i.min_date,i.min_speed,i.avg_speed,i.avg_speed_end,i.max_speed,parseInt(i.cnt)]:[i.min_date,i.min_errors,i.avg_errors,i.avg_errors_end,i.max_errors,parseInt(i.cnt)]}),dataTable.addRows(rows);for(var i=0;i<rows.length;i++)dataTable.setFormattedValue(i,0,"week"==$scope.Charts.loaderParams.grouping?$scope.Charts.data.detailsData.list[i].min_date.format("dd mmm","msk")+" - "+$scope.Charts.data.detailsData.list[i].max_date.format("dd mmm yyyy г.","msk"):"day"==$scope.Charts.loaderParams.grouping?$scope.Charts.data.detailsData.list[i].min_date.format("dd mmm yyyy г.","msk"):$scope.Charts.data.detailsData.list[i].min_date.format("dd mmm yyyy г., HH:MM:ss","msk"));ctrl.dataTables.table=dataTable,ctrl.maxDataCnt=_.max($scope.Charts.data.detailsData.list,"cnt"),"speed"==$scope.Charts.loaderParams.indicator?(new $scope.Charts.GoogleVisualization.NumberFormat({fractionDigits:0}).format(dataTable,2),new $scope.Charts.GoogleVisualization.NumberFormat({fractionDigits:0}).format(dataTable,3)):(new $scope.Charts.GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(dataTable,1),new $scope.Charts.GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(dataTable,2),new $scope.Charts.GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(dataTable,3),new $scope.Charts.GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(dataTable,4)),ctrl.onClick=function(row){$scope.Charts.loaderParams.fromDate=new Date($scope.Charts.data.detailsData.list[row].min_date.format("yyyy-mm-dd","msk")),"week"==$scope.Charts.loaderParams.grouping?($scope.Charts.loaderParams.toDate=new Date($scope.Charts.data.detailsData.list[row].max_date.format("yyyy-mm-dd","msk")),$scope.Charts.loaderParams.grouping="day"):"day"==$scope.Charts.loaderParams.grouping&&($scope.Charts.loaderParams.toDate=new Date($scope.Charts.loaderParams.fromDate.format("yyyy-mm-dd","msk")),$scope.Charts.loaderParams.grouping="none")},ctrl.getGraphOptions=function(){var color="speed"==$scope.Charts.loaderParams.indicator?"#3366cc":"#dc3912";return{tooltip:{isHtml:!0},seriesType:"area",vAxes:[{ticks:"speed"==$scope.Charts.loaderParams.indicator?_.times(Math.ceil(_.max($scope.Charts.data.detailsData.list,"max_speed").max_speed/100+1),function(n){return 100*n}):void 0},{textPosition:"none",gridlines:{count:0}}],series:"num_races"==$scope.Charts.loaderParams.indicator?[{color:"#109618"}]:[{color:"white",lineWidth:0},{color:color,lineWidth:0},{type:"line",color:color,lineWidth:.4,enableInteractivity:!1},{type:"line",color:color,lineWidth:1.5},{type:"bars",color:"#109618",targetAxisIndex:1,dataOpacity:.8},{type:"bars",targetAxisIndex:1,dataOpacity:0,enableInteractivity:!1},{type:"line",color:"#e9a511",lineWidth:1,enableInteractivity:!1}]}}}),angular.module("app.profile.stats.overview",["route-segment","view-segment","lib.api.profile"]).config(function($routeProvider,$routeSegmentProvider,PageData){"profile"==PageData.rootAppModule&&$routeSegmentProvider.when("/:user/stats/","main.stats.overview").within("main").within("stats").segment("overview",{templateUrl:"/views/partials/profile/stats/overview.html?bust=1413116880766",controller:"profile:Main.StatsPage.Overview as Overview",dependencies:["user"],resolve:{data:function(ProfileStatsOverviewLoader){return ProfileStatsOverviewLoader.load()},GoogleVisualization:function(GoogleVisualizationLoader){return GoogleVisualizationLoader.load()}}})}).factory("ProfileStatsOverviewLoader",function(Loader,Profile,$routeParams){return Loader.factory(function(){return{summary:Profile.getSummary($routeParams.user),overview:Profile.getStatsOverview($routeParams.user)}})}).controller("profile:Main.StatsPage.Overview",function($scope,data,GoogleVisualization,GametypeColors,$location,$routeSegment,$timeout){var ctrl=this;ctrl.data=data,ctrl.selection=null;var gametypeKeys=_.keys(data.overview.gametypes);ctrl.dataTable=new GoogleVisualization.DataTable,ctrl.dataTable.addColumn("string","Режим"),ctrl.dataTable.addColumn("number","Пробег"),ctrl.dataTable.addColumn("number","Рекорд"),ctrl.dataTable.addColumn("number","Средняя"),ctrl.dataTable.addColumn("number","Ошибки");var rows=_.map(data.overview.gametypes,function(i){return[i.name,i.num_races,i.info.best_speed,i.info.avg_speed,i.info.avg_error]});ctrl.dataTable.addRows(rows),ctrl.pieSlices=_.map(data.overview.gametypes,function(i,key){return{color:GametypeColors.getColor(key),offset:.1}}),_.each(gametypeKeys,function(gametype,i){ctrl.dataTable.setProperty(i,0,"style","color: "+GametypeColors.getColor(gametype))}),new GoogleVisualization.NumberFormat({fractionDigits:0}).format(ctrl.dataTable,2),new GoogleVisualization.NumberFormat({fractionDigits:0}).format(ctrl.dataTable,3),new GoogleVisualization.NumberFormat({suffix:"%",fractionDigits:2}).format(ctrl.dataTable,4),$scope.$watch("Overview.selection",function(newVal,oldVal){null!==newVal&&(ctrl.pieSlices[newVal].color="#ddd"),null!==oldVal&&(ctrl.pieSlices[oldVal].color=GametypeColors.getColor(gametypeKeys[oldVal])),$timeout(function(){$scope.$broadcast("appChart.redraw")},0)}),ctrl.onGametypeSelect=function(row){$location.path("/"+$routeSegment.$routeParams.user+"/stats/"+gametypeKeys[row]+"/")},ctrl.onGametypeHover=function(gametype){var row=_.indexOf(gametypeKeys,gametype);ctrl.selection=-1!=row?row:null}}),angular.module("app.support",["lib.api.support","lib.loader","route-segment","view-segment","lib.ui.modal","lib.ui.drop"]).config(function($routeProvider,$routeSegmentProvider,PageData){"support"==PageData.rootAppModule&&($routeSegmentProvider.options.autoLoadTemplates=!0,$routeSegmentProvider.when("/","index.list").when("/tags/:tag","index.list").when("/:id","view").segment("index",{templateUrl:"/views/partials/support/list.html?bust=1413116880766",controller:"support:Index",resolve:{data:function(SupportIndexLoader,SupportListLoader){return SupportListLoader.load(),SupportIndexLoader.load()}}}).within().segment("list",{controller:"support:Index.List",dependencies:["tag"],resolve:{data:function(SupportListLoader){return SupportListLoader.getPromise()}},untilResolved:{templateUrl:"/views/partials/support/loading.html?bust=1413116880766"}}).up().segment("view",{templateUrl:"/views/partials/support/view.html?bust=1413116880766",controller:"support:View",dependencies:["id"],resolve:{data:function(SupportViewLoader){return SupportViewLoader.load()}}}),$routeProvider.otherwise({redirectTo:"/"}))}).factory("SupportIndexLoader",function(Loader,Support){return Loader.factory(function(){return{tags:Support.getTags()}})}).factory("SupportListLoader",function(Loader,Support,$routeParams){return Loader.factory(function(){return{open:$routeParams.tag?Support.searchOpenProblemsByTag($routeParams.tag):Support.getOpenProblems(),closed:$routeParams.tag?Support.searchClosedProblemsByTag($routeParams.tag):Support.getClosedProblems()}})}).controller("support:Index",function($scope,data,$routeParams,$location,Me,SupportListLoader){$scope.data=data,$scope.$routeParams=$routeParams;var maxTagCount=0;_.each(data.tags,function(i){i.count>maxTagCount&&(maxTagCount=i.count)}),$scope.calcTagFontSize=function(count){var size=25*(count/maxTagCount);return 11>size&&(size=11),size},$scope.$watch(function(){return $location.path()},function(){SupportListLoader.reset()}),$scope.onChangeTag=function(tag){tag?$location.path("/tags/"+tag):$location.path("/")}}).controller("support:Index.List",function($scope,data,Me){$scope.data=data,$scope.Me=Me}).factory("SupportViewLoader",function(Loader,Support,$routeParams){return Loader.factory(function(){return{info:Support.getTicket($routeParams.id),incidents:Support.getIncidentsList($routeParams.id),comments:Support.getComments($routeParams.id)}})}).controller("support:View",function($scope,data,$location,Support,Me,$routeSegment,$sce,$filter){$scope.data=data,$scope.Me=Me,$scope.subscribedCount=data.info.ticket.collaborator_ids.length,$scope.description=$sce.trustAsHtml(data.comments[0].html_body);for(var i=0;i<data.comments.length;i++)0===data.comments[i].body.indexOf("UPD")&&($scope.description=$sce.trustAsHtml(data.comments[i].html_body.replace(/UPD:?<br>/,"")),data.comments.splice(i,1),i--);$scope.onBack=function(){$location.path("/")},_.each(data.incidents,function(i){i.message_type="incident",i.description=$sce.trustAsHtml($filter("html")(i.description))}),_.each(data.comments,function(i){i.message_type="comment",i.html_body=$sce.trustAsHtml(i.html_body)}),$scope.messages=_.union(data.incidents,_.rest(data.comments)),$scope.messages.sort(function(a,b){return a.created_at.getTime()-b.created_at.getTime()}),_.each(data.incidents,function(i){Support.getComments(i.id,{per_page:1}).then(function(comments){i.attachments=comments[0].attachments})}),$scope.onSubscribe=function(){return data.info.subscribed?Support.unsubscribe($routeSegment.$routeParams.id).then(function(response){response.ok&&(data.info.subscribed=!1,$scope.subscribedCount--)}):Support.subscribe($routeSegment.$routeParams.id).then(function(response){response.ok&&(data.info.subscribed=!0,$scope.subscribedCount++)})}}).filter("removeSystemTags",function(){return function(value){return _.remove(value,function(i){return i.name?"ТС"==i.name||"БС"==i.name:"ТС"==i||"БС"==i}),value}}),angular.module("app.userpanel",["lib.ui.drop","app.profile.achieves","lib.api.profile"]).controller("userpanel:UnreadMail",function($scope,Socket,Me){var ctrl=this;ctrl.cnt=parseInt(Me.unread_mail),Socket.bindEventToScope($scope,sprintf("counters:%s/unreadMail",Me.id),function(data){data.newAmount>=ctrl.cnt&&$scope.$broadcast("newUnreadMail"),ctrl.cnt=data.newAmount})}).directive("appUnreadMailIcon",function($animate,$timeout){return function($scope,elm){$scope.$on("newUnreadMail",function(){$timeout(function(){$animate.addClass(elm,"new-mail",function(){elm.removeClass("new-mail")})},10)})}}).directive("appScoresLabel",function(Me,Socket){return{link:function($scope,elm){Socket.bindEventToScope($scope,sprintf("counters:%s/scores",Me.id),function(data){new Effect.NumberChange(elm[0].id,data.newAmount)})}}}).directive("appBonusesLabel",function(Me,Socket){return{link:function($scope,elm){Socket.bindEventToScope($scope,sprintf("counters:%s/bonuses",Me.id),function(data){new Effect.NumberChange(elm[0].id,data.newAmount)})}}}).run(function($modal2,Socket,$rootScope,Me,$q,Profile){Me&&Profile.getPrivatePrefs(Me.id).then(function(prefs){var queue={promise:$q.when({}),add:function(fn){queue.promise["finally"](function(){queue.promise=$q.when(fn())})}};Socket.bindEventToScope($rootScope,"achieve:"+Me.id,function(data){prefs.achieves.notify[data.type]&&queue.add(function(){return $modal2.open({templateUrl:"/views/partials/dlg-achieve.html?bust=1413116880766",controller:"userpanel:DlgAchieve as DlgAchieve",windowClass:"dlg-achieve-window",resolve:{data:function(){return data}}}).result})})})}).controller("userpanel:DlgAchieve",function($scope,data,$modalInstance,Profile){var ctrl=this;_.extend(ctrl,data),$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onOK=function(){return Profile.publishAchieve(data.user_achieve).then(function(){$modalInstance.close()})}}).controller("userpanel:GameInvite",function($scope,Socket,Me,$http,LocalStorage,PageData){var gameStatusEvent,ctrl=this;$scope.GameInvite=ctrl,ctrl.invite=null,LocalStorage.syncExp("game.invite",$scope,"GameInvite.invite"),ctrl.invite&&ctrl.invite.timestamp<(new Date).getTime()/1e3-300&&(ctrl.invite=null),Me&&Socket.bindEventToScope($scope,sprintf("gameInvite:%s",Me.id),function(data){ctrl.invite=data,ctrl.invite.active=!0,ctrl.invite.game_id==PageData.gameId&&ctrl.onAccept()}),ctrl.onCancel=function(){ctrl.invite&&$http.get("/g/"+ctrl.invite.game_id+".inviteReceive"),ctrl.invite.active=!1},ctrl.onAccept=function(){ctrl.invite&&(ctrl.invite.active=!1,$http.get("/g/"+ctrl.invite.game_id+".inviteReceive"),ctrl.invite.game_id!=PageData.gameId&&setTimeout(function(){window.location="/g/?gmid="+ctrl.invite.game_id},10))},$scope.$watch("GameInvite.invite.game_id",function(newVal){gameStatusEvent&&gameStatusEvent.remove(),newVal&&(gameStatusEvent=Socket.bindEventToScope($scope,sprintf("game:%s/status",newVal),function(data){"racing"==data.status&&(ctrl.invite=null)}))})}),angular.module("lib.api.api",["lib.utils"]).provider("Api",function(){var options=this.options={apiUrl:"/api/"};this.$get=function($injector,Datificator,Dedollarizer,$q){function errorHandler(response){return $q.reject(response)}var Api={options:options};return Api.post=function(name,params){var $http=$injector.get("$http");return $http.post(options.apiUrl+name,params,{withCredentials:!0}).then(function(response){return response.data.err?$q.reject(response.data.err):(Api.format(response.data),response.data)},errorHandler)},Api.get=function(name,params){var $http=$injector.get("$http");return $http({method:"GET",url:options.apiUrl+name,params:params,withCredentials:!0}).then(function(response){return response.data.err?$q.reject(response.data.err):(Api.format(response.data),response.data)},errorHandler)},Api.format=function(obj){Datificator.recurse(obj),Dedollarizer.recurse(obj)},Api}}),angular.module("lib.api.fuel",["lib.api.api"]).factory("Fuel",function(Api){var Fuel={};return Fuel.get=function(month){return Api.get("fuel?month="+month)},Fuel.getUsers=function(month){return Api.get("fuel/users-list?month="+month)},Fuel.removeMyThank=function(){return Api.post("fuel/remove-my-thank")},Fuel.getUserVotes=function(){return Api.get("fuel/get-user-votes")},Fuel.vote=function(category){return Api.post("fuel/vote",{category:category})},Fuel}),angular.module("lib.api.profile",["lib.api.api","lib.user-cache"]).factory("Profile",function(Api,Me,$q,UserCache,Dialogs){var Profile={};Profile.factory=function(){var instance={};return instance};var summary={};return Profile.getSummary=function(id,options){return options=options||{},summary[id]||(summary[id]={promise:null,data:{}}),!summary[id].data.id||options.clearCache?(summary[id].promise=Api.get("profile/get-summary?id="+id).then(UserCache.thru).then(function(response){return summary[id].data=_.extend(summary[id].data,response),summary[id].promise=null,summary[id].data}),summary[id].promise):summary[id].promise?summary[id].promise:$q.when(summary[id].data)},Profile.getJournal=function(id){return Api.get("profile/get-journal?id="+id).then(UserCache.thru)},Profile.getJournalEx=function(id,options,beforeDate){if(!options)return Profile.getJournal(id);options.filter.text=!1;var filter=[];for(var i in options.filter)options.filter[i]&&filter.push(i);var query=["id="+id,"limit=15","sort="+options.getSort(),"filter="+filter.join(","),"showHidden="+(options.showHidden?1:0),"ignoreFriends="+options.ignoreFriends.join(","),"discussOnly="+(options.discussOnly?1:0)];return beforeDate&&query.push("beforeDate="+beforeDate.getTime()),options.getPrivate().achieve_id&&query.push("achieve_id="+options.getPrivate().achieve_id),Api.get("profile/get-journal?"+query.join("&")).then(UserCache.thru)},Profile.getJournalPost=function(postId){return Api.get("profile/get-journal-post?postId="+postId).then(UserCache.thru)},Profile.addJournalComment=function(postId,text){return Api.post("profile/add-journal-comment",{id:postId,text:text}).then(UserCache.thru).catch(function(error){return"permission blocked"==error&&Dialogs.alert("Ой!","Этот пользователь запретил оставлять комментарии в своем бортжурнале."),$q.reject(error)})},Profile.getJournalComments=function(postId,fromDate){return Api.get("profile/get-journal-comments?id="+postId+"&from="+fromDate.getTime()).then(UserCache.thru)},Profile.addJournalPost=function(userId,text,hidden){return Api.post("profile/add-journal-post",{userId:parseInt(userId),text:text,hidden:hidden}).then(UserCache.thru).catch(function(error){return"permission blocked"==error&&Dialogs.alert("Ой!","Этот пользователь запретил создавать записи в своем бортжурнале."),$q.reject(error)})},Profile.modifyJournalPost=function(postId,modify){return Api.post("profile/modify-journal-post",{postId:postId,modify:modify}).then(UserCache.thru)},Profile.modifyJournalComment=function(postId,commentDate,modify){return Api.post("profile/modify-journal-comment",{postId:postId,commentDate:commentDate.getTime(),modify:modify}).then(UserCache.thru)},Profile.getFriends=function(userId){return Api.get("profile/get-friends?userId="+userId).then(UserCache.thru)},Profile.searchUsers=function(query){return Api.get("profile/search-users?query="+query).then(function(response){return UserCache.thruArray(response.all),UserCache.thruArray(response.friends),response})},Profile.getFriendRequests=function(id){return Api.get("profile/get-friend-requests?id="+id).then(function(response){return UserCache.thruArray(response.in),UserCache.thruArray(response.out),response})},Profile.friendRequest=function(friendId){return Api.post("profile/friend-request?friendId="+friendId).then(UserCache.thru).catch(function(error){return"permission blocked"==error&&Dialogs.alert("Ой!","Этот пользователь запретил приглашать его в друзья."),$q.reject(error)})},Profile.friendRequestReject=function(friendId){return Api.post("profile/friend-request-reject?friendId="+friendId).then(UserCache.thru)},Profile.removeFriend=function(friendId){return Api.post("profile/remove-friend?friendId="+friendId).then(UserCache.thru)},Profile.getPrivatePrefs=function(userId){return Api.get("profile/get-private-prefs?id="+userId)},Profile.setPrivatePref=function(name,value){return Api.post("profile/set-private-pref",{name:name,value:value})},Profile.setPublicPref=function(name,value){return Api.post("profile/set-public-pref",{name:name,value:value})},Profile.refreshUserbars=function(){return Api.get("profile/refresh-userbars")},Profile.getMessagesContacts=function(){return Api.get("profile/get-messages-contacts").then(UserCache.thru)},Profile.getMessagesContactsBeforeDate=function(beforeDate){return Api.get("profile/get-messages-contacts",{beforeDate:beforeDate.getTime()}).then(UserCache.thru)},Profile.getMessagesDialog=function(respondentId){return Api.get("profile/get-messages-dialog?respondentId="+respondentId).then(UserCache.thru)},Profile.getMessagesDialogBeforeDate=function(respondentId,beforeDate){return Api.get("profile/get-messages-dialog?respondentId="+respondentId+"&beforeDate="+beforeDate.getTime()).then(UserCache.thru)},Profile.sendMessage=function(respondentId,text){return Api.post("profile/send-message",{respondentId:respondentId,text:text}).catch(function(error){return"permission blocked"==error&&Dialogs.alert("Ой!","Этот пользователь запретил отправлять ему сообщения."),$q.reject(error)})},Profile.sendScores=function(respondentId,message,amount){return Api.post("profile/send-scores",{respondentId:respondentId,message:message,amount:parseInt(amount)}).catch(function(error){return"permission blocked"==error&&Dialogs.alert("Ой!","Этот пользователь запретил отправлять ему сообщения."),"not enough scores"==error&&Dialogs.alert("Ой!","У вас недостаточно очков."),$q.reject(error)})},Profile.setMessageTyping=function(respondentId){return Api.post("profile/set-message-typing",{respondentId:respondentId})},Profile.removeMessage=function(messageId,deleted){return Api.post("profile/remove-message",{messageId:messageId,deleted:deleted})},Profile.removeMessageHistory=function(userId){return Api.post("profile/remove-message-history",{userId:userId})},Profile.setMessageRead=function(messageId){return Api.post("profile/set-message-read",{messageId:messageId})},Profile.setMessageContactRead=function(userId){return Api.post("profile/set-message-read",{userId:userId})},Profile.getIndexData=function(userId){return Api.get("profile/get-index-data?userId="+userId)},Profile.setBio=function(text){return Api.post("profile/set-bio",{text:text})},Profile.getVocs=function(userId){return Api.get("profile/get-vocs?userId="+userId)},Profile.getStatsOverview=function(userId){return Api.get("profile/get-stats-overview?userId="+userId).catch(function(err){return"permission blocked"==err?{err:err}:$q.reject(err)})},Profile.getStatsDetails=function(userId,gametype){return Api.get("profile/get-stats-details?userId="+userId+"&gametype="+gametype).catch(function(err){return"permission blocked"==err?{err:err}:$q.reject(err)})},Profile.getStatsDetailsData=function(userId,gametype,fromDate,toDate,grouping){return Api.get("profile/get-stats-details-data?userId="+userId+"&gametype="+gametype+"&fromDate="+fromDate.format("yyyy-mm-dd","msk")+"&toDate="+toDate.format("yyyy-mm-dd","msk")+"&grouping="+grouping).catch(function(err){return"permission blocked"==err?{err:err}:"not pro"==err?{err:err}:$q.reject(err)})},Profile.exportStatsDetailsData=function(userId,gametype,fromDate,toDate,grouping){window.open(Api.options.apiUrl+"profile/get-stats-details-data?userId="+userId+"&gametype="+gametype+"&fromDate="+fromDate.format("yyyy-mm-dd","msk")+"&toDate="+toDate.format("yyyy-mm-dd","msk")+"&grouping="+grouping+"&export=csv")},Profile.deleteStatsResult=function(id){return Api.post("profile/delete-stats-result",{id:id})},Profile.getCarsList=function(userId){return Api.get("profile/get-cars-list?userId="+userId)},Profile.selectCar=function(id){return Api.post("profile/select-car",{id:id})},Profile.buyCar=function(id){return Api.post("profile/buy-car",{id:id})},Profile.setColor=function(color){return Api.post("profile/set-color",{color:color})},Profile.getOldAero=function(){return Api.get("profile/get-old-aero")},Profile.setCarAero=function(imageData){return Api.post("profile/set-car-aero",{imageData:imageData})},Profile.setAvatar=function(imageData){return Api.post("profile/set-avatar",{imageData:imageData})},Profile.removeAvatar=function(){return Api.post("profile/remove-avatar",{remove:1})},Profile.getTuningInfo=function(){return Api.get("profile/get-tuning-info")},Profile.setTuning=function(tuning){return Api.post("profile/set-tuning",{tuning:tuning}).catch(function(error){return"not enough bonuses"==error&&Dialogs.alert("Ой!","У вас недостаточно бонусов!"),$q.reject(error)})},Profile.getAchieves=function(userId,q,sort,skip){return Api.get("profile/get-achieves",{userId:userId,q:q,sort:sort,skip:skip})},Profile.publishAchieve=function(achieve){return Api.post("profile/publish-achieve",{achieve:achieve})},Profile.setIndexAchieve=function(num,achieveId){return Api.post("profile/set-index-achieve",{num:num,achieveId:achieveId})},Profile.changePassword=function(oldPassword,newPassword){return Api.post("profile/change-password",{oldPassword:oldPassword,newPassword:newPassword}).catch(function(error){return"incorrect old password"==error&&Dialogs.alert("Ой!","Старый пароль введен неверно."),"too small"==error&&Dialogs.alert("Ой!","Введите пароль, состоящий из 5 символов или более."),"invalid characters"==error&&Dialogs.alert("Ой!","Пароль может состоять только из латинских символов, цифр и знаков пунктуации."),$q.reject(error)})},Profile.changeEmail=function(email){return Api.post("profile/change-email",{email:email}).catch(function(error){return"invalid email"==error&&Dialogs.alert("Ой!","Введен неверный адрес электронной почты."),"email exists"==error&&Dialogs.alert("Ой!","Пользователь с таким электронным адресом уже существует."),$q.reject(error)})},Profile.setNotifyNews=function(notify){return Api.post("profile/set-notify-news",{notify:notify})},Profile.getBookParts=function(userId,vocId){return Api.get("profile/get-book-parts",{userId:userId,vocId:vocId})},Profile.getIgnoreList=function(){return Api.get("profile/get-ignore-list")},Profile.ignoreRemove=function(userId){return Api.post("profile/ignore-remove",{userId:userId})},Profile.ignoreAdd=function(userId){return Api.post("profile/ignore-add",{userId:userId})},Profile.changeLogin=function(newLogin){return Api.post("profile/change-login",{newLogin:newLogin})},Profile.outdateAchieve=function(achieveId){return Api.post("profile/outdate-achieve",{achieveId:achieveId})},Profile.downloadRecordTsf=function(userId,id){return Api.get("profile/download-record-tsf",{userId:userId,id:id})},Profile}),angular.module("lib.api.support",["lib.api.api"]).factory("Support",function(Api){function populateUsers(list,users,field){field=field||"requester";var i,usersHash={};for(i in users)usersHash[users[i].id]=users[i];for(i in list)list[i][field]=usersHash[list[i][field+"_id"]]}function transformDate(list,field){_.each(list,function(i){i[field]=new Date(i[field])})}var Support={};return Support.getOpenProblems=function(){return Api.get("zendesk/get-open-problems").then(function(response){return populateUsers(response.tickets,response.users),response})},Support.getClosedProblems=function(){return Api.get("zendesk/get-closed-problems").then(function(response){return populateUsers(response.tickets,response.users),response})},Support.searchOpenProblemsByTag=function(tag){return Api.get("zendesk/search-open-problems-by-tag?tag="+tag)},Support.searchClosedProblemsByTag=function(tag){return Api.get("zendesk/search-closed-problems-by-tag?tag="+tag)},Support.getTicket=function(id){return Api.get("zendesk/get-ticket?id="+id)},Support.getIncidentsList=function(id){return Api.get("zendesk/get-incidents-list?id="+id).then(function(response){return populateUsers(response.tickets,response.users),transformDate(response.tickets,"created_at"),response.tickets})},Support.getComments=function(id,options){return options=options||{},options.id=id,Api.get("zendesk/get-comments",options).then(function(response){return populateUsers(response.comments,response.users,"author"),transformDate(response.comments,"created_at"),response.comments})},Support.getTags=function(){return Api.get("zendesk/get-tags").then(function(response){var result=_.remove(response.tags,function(i){return"ТС"!=i.name&&"БС"!=i.name});return result.sort(function(a,b){return a.name.localeCompare(b.name)}),result})},Support.subscribe=function(id){return Api.post("zendesk/subscribe?op=subscribe&id="+id)},Support.unsubscribe=function(id){return Api.get("zendesk/subscribe?op=unsubscribe&id="+id)},Support}),function(){function toBoolean(value){if(value&&0!==value.length){var v=angular.lowercase(""+value);value=!("f"==v||"0"==v||"false"==v||"no"==v||"n"==v||"[]"==v)}else value=!1;return value}function attrDirective(attrName,dirName){return function($scope,elm,attrs){setTimeout(function(){elm.attr(attrName,$scope.$eval(attrs[dirName]))},0)}}var mod=angular.module("lib.bo",[]).directive("boText",function(){return{link:function($scope,elm,attrs){var value=$scope.$eval(attrs.boText);elm.text(void 0==value?"":value)}}}).directive("boHtml",function($sce){return{link:function($scope,elm,attrs){var value=$scope.$eval(attrs.boHtml);elm.html($sce.getTrustedHtml(value)||"")}}}).directive("boIf",function($animate){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function($scope,$element,$attr,ctrl,$transclude){var childScope,value=$scope.$eval($attr.boIf);
toBoolean(value)&&(childScope=$scope.$new(),$transclude(childScope,function(clone){clone[clone.length++]=document.createComment(" end ngIf: "+$attr.boIf+" "),$animate.enter(clone,$element.parent(),$element)}))}}}).directive("boClass",function(){return{restrict:"AC",link:function(scope,element,attr){function flattenClasses(classVal){if(angular.isArray(classVal))return classVal.join(" ");if(angular.isObject(classVal)){var classes=[];return angular.forEach(classVal,function(v,k){v&&classes.push(k)}),classes.join(" ")}return classVal}var newVal=scope.$eval(attr.boClass),newClasses=flattenClasses(newVal||"");attr.$addClass(newClasses)}}}).directive("boStyle",function(){return function($scope,elm,attrs){var newStyles=$scope.$eval(attrs.boStyle);newStyles&&elm.css(newStyles)}}).directive("boShow",function($animate){return function($scope,elm,attrs){var value=toBoolean($scope.$eval(attrs.boShow));$animate[value?"removeClass":"addClass"](elm,"ng-hide")}}).directive("boHide",function($animate){return function($scope,elm,attrs){var value=toBoolean($scope.$eval(attrs.boHide));$animate[value?"addClass":"removeClass"](elm,"ng-hide")}}).directive("boInclude",function($sce,$http,$templateCache,$compile){return{restrict:"ECA",priority:-400,terminal:!0,compile:function(tElm,tAttr){var srcExp=tAttr.boInclude||tAttr.src;return function($scope,elm){var src=$sce.parseAsResourceUrl(srcExp)();src&&$http.get(src,{cache:$templateCache}).success(function(response){elm.html(response),$compile(elm.contents())($scope)})}}}});mod.directive("boSrc",function(){return{priority:99,link:attrDirective("src","boSrc")}}),mod.directive("boHref",function(){return{priority:99,link:attrDirective("href","boHref")}})}(),angular.module("lib.dialogs",[]).factory("Dialogs",function($modal,$modal2,$injector,Me,$q){var Dialogs={};return Dialogs.notAuthorized=function(){return $modal.open({templateUrl:"/views/partials/dlg-not-authorized.html?bust=1413116880766",controller:Dialogs.Ctrl}).result},Dialogs.ask=function(title,message,waitCallback){return $modal2.open({templateUrl:"/views/partials/dlg-ask.html?bust=1413116880766",controller:function($scope,$modalInstance){$scope.title=title,$scope.message=message,$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onOK=function(result){return waitCallback?waitCallback().then(function(){$modalInstance.close(result)}):($modalInstance.close(result),$q.when())}}}).result},Dialogs.alert=function(title,message){return $modal2.open({templateUrl:"/views/partials/dlg-alert.html?bust=1413116880766",controller:function($scope,$modalInstance){$scope.title=title,$scope.message=message,$scope.onCancel=function(result){$modalInstance.dismiss(result)}}}).result},Dialogs.sendUserMessage=function(userId,withScores){return $modal2.open({autofocus:!1,templateUrl:"/views/partials/dlg-send-user-message.html?bust=1413116880766",resolve:{data:function(){return $injector.get("Profile").getSummary(userId)}},controller:function($scope,$modalInstance,data,Profile){var ctrl=$scope.Dialog=this;ctrl.messageText={text:""},$scope.data=data,ctrl.scores=withScores?"":null,$scope.onSend=function(){return ctrl.messageText.text&&(!withScores||parseInt(ctrl.scores)>0)?(withScores?Profile.sendScores(data.user.id,ctrl.messageText.text,ctrl.scores):Profile.sendMessage(data.user.id,ctrl.messageText.text)).then(function(){$modalInstance.close(),$modal.open({templateUrl:"/views/partials/dlg-message-sent.html?bust=1413116880766",controller:function($scope,$modalInstance,$location){$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onGoTo=function(){$modalInstance.dismiss(),$location.path("/"+Me.id+"/messages/"+data.user.id+"/")}}})}):void 0},$scope.onCancel=function(){$modalInstance.dismiss()}}}).result},Dialogs.friendRequest=function(userId){return Dialogs.ask("Добавить друга","Пользователь будет добавлен в список друзей только после того, как ответит на приглашение. Вы хотите отправить приглашение?").then(function(){return $injector.get("Profile").friendRequest(userId)})},Dialogs.friendRemove=function(userId){return Dialogs.ask("Удалить друга","Удалить этого пользователя из списка ваших друзей?").then(function(){return $injector.get("Profile").removeFriend(userId)})},Dialogs.ignoreUser=function(user){return Dialogs.ask("Игнорировать","<p>Добавление пользователя в черный список приведет к тому, что он не сможет отправлять вам личные сообщения, приглашать в друзья и оставлять комментарии и записи в вашем бортжурнале.</p><p>Очистить список можно в разделе &laquo;Настройки&raquo;.</p><p>Вы хотите добавить пользователя <b>"+user.login+"</b> в черный список?</p>").then(function(){return $injector.get("Profile").ignoreAdd(user.id)}).then(function(){return Dialogs.alert("Игнорировать","Пользователь добавлен в черный список.")})},Dialogs.complainUser=function(user){abuse(user.id)},Dialogs.Ctrl=function($scope,$modalInstance){$scope.onCancel=function(){$modalInstance.dismiss()},$scope.onOK=function(result){$modalInstance.close(result)}},Dialogs}),angular.module("lib.directives",[]).run(function($rootScope){$rootScope.when=function(expr,truthy,falsy){return expr?truthy:falsy}}).filter("regex",function(){return function(input,regex){for(var patt=new RegExp(regex),out=[],i=0;i<input.length;i++)patt.test(input[i])&&out.push(input[i]);return out}}).filter("replace",function(){return function(input,subject,replace){if(angular.isUndefined(input))return void 0;var out=[],regex=new RegExp(subject);if(angular.isArray(input)){for(var i=0;i<input.length;i++)out.push(input[i].replace(regex,replace));return out}return input.replace(regex,replace)}}).filter("key",function(){return function(input,key){return angular.isObject(input)||angular.isArray(input)?input[key]:null}}).filter("truncate",function(){return function(input,len){return angular.isString(input)?input.length>len?input.substr(0,len-2)+"...":input:input}}).directive("appExists",function($compile){return{restrict:"E",compile:function(){return function($scope,element,attrs){var old=element[0].innerHTML;element.html(""),$scope.$watch(attrs.on,function(value){value?(element.html(old),$compile(element.contents())($scope)):element.html("")})}}}}).directive("appAnimRepeat",function(){return{transclude:"element",priority:1e3,terminal:!0,compile:function(element,attr,linker){return function(scope,iterStartElement,attr){var lhs,rhs,valueIdent,keyIdent,expression=attr.appAnimRepeat,match=expression.match(/^\s*(.+)\s+in\s+(.*)\s*$/);if(!match)throw Error("Expected ngRepeat in form of '_item_ in _collection_' but got '"+expression+"'.");if(lhs=match[1],rhs=match[2],match=lhs.match(/^(?:([\$\w]+)|\(([\$\w]+)\s*,\s*([\$\w]+)\))$/),!match)throw Error("'item' in 'item in collection' should be identifier or (key, value) but got '"+lhs+"'.");valueIdent=match[3]||match[1],keyIdent=match[2];var lastOrder=new HashQueueMap;scope.$watch(function(scope){var index,length,childScope,key,value,array,last,collection=scope.$eval(rhs),collectionLength=size(collection,!0),nextOrder=new HashQueueMap,cursor=iterStartElement;if(angular.isArray(collection))array=collection||[];else{array=[];for(key in collection)collection.hasOwnProperty(key)&&"$"!=key.charAt(0)&&array.push(key);array.sort()}for(index=0,length=array.length;length>index;index++)key=collection===array?index:array[index],value=collection[key],last=lastOrder.shift(value),last?(childScope=last.scope,nextOrder.push(value,last),index===last.index?cursor=last.element:last.index=index):childScope=scope.$new(),childScope[valueIdent]=value,keyIdent&&(childScope[keyIdent]=key),childScope.$index=index,childScope.$first=0===index,childScope.$last=index===collectionLength-1,childScope.$middle=!(childScope.$first||childScope.$last),last||linker(childScope,function(clone){clone.hide(),cursor.after(clone),last={scope:childScope,element:cursor=clone,index:index},scope.$eval(attr.appAnimIf)?setTimeout(function(){new Effect.SlideDown(clone[0],{duration:scope.$eval(attr.appAnimDuration)}),clone.find("> *").fadeIn(1200)},0):clone.show(),nextOrder.push(value,last)});for(key in lastOrder)if(lastOrder.hasOwnProperty(key))for(array=lastOrder[key];array.length;)value=array.pop(),scope.$eval(attr.appAnimIf)?!function(elm){setTimeout(function(){var opts={duration:scope.$eval(attr.appAnimDuration)};new Effect.SlideUp(elm,opts),opts.afterFinish=function(){angular.element(elm).remove()},new Effect.Fade(elm,opts)},0)}(value.element[0]):value.element.remove(),value.scope.$destroy();lastOrder=nextOrder})}}}}).directive("appTableLayout",function(){return{transclude:!0,restrict:"E",template:"<table></table>",replace:!0,compile:function(template,tAttrs,transclude){return function($scope,element,attrs){var lhs,rhs,valueIdent,keyIdent,expression=attrs.src,match=expression.match(/^\s*(.+)\s+in\s+(.*)\s*$/);if(!match)throw Error("Expected appTableLayout in form of '_item_ in _collection_' but got '"+expression+"'.");if(lhs=match[1],rhs=match[2],match=lhs.match(/^(?:([\$\w]+)|\(([\$\w]+)\s*,\s*([\$\w]+)\))$/),!match)throw Error("'item' in 'item in collection' should be identifier or (key, value) but got '"+lhs+"'.");valueIdent=match[3]||match[1],keyIdent=match[2];var childScopes=[];$scope.$watch(function($s){return angular.toJson({maxCols:$s.$eval(attrs.appMaxCols),minRows:$s.$eval(attrs.appMinRows),items:$s.$eval(rhs)})},function(value){element.html(""),value=angular.fromJson(value);var rows=Math.ceil(value.items.length/value.maxCols);rows<value.minRows&&(rows=value.minRows);for(var cols=Math.ceil(value.items.length/rows),row=0;rows>row;row++)for(var tr=$$$("<tr></tr>").appendTo(element),col=0;cols>col;col++){var td=$$$("<td></td>").appendTo(tr),idx=row+col*rows;childScopes[idx]&&childScopes[idx].$destroy(),idx>=value.items.length||(childScopes[idx]=$scope.$new(),childScopes[idx].$index=idx,childScopes[idx][valueIdent]=value.items[idx],transclude(childScopes[idx],function(clone){clone.appendTo(td)}))}})}}}}).directive("appSlider",function($timeout){return{template:"<div class=slider><div class=handle></div></div>",replace:!0,restrict:"E",scope:{model:"="},link:function($scope,element,attrs){var slidingUpdate,min=$scope.$eval(attrs.min),max=$scope.$eval(attrs.max),step=$scope.$eval(attrs.step),opts={range:$R(min,max),sliderValue:$scope.model,alignX:2,onSlide:function(value){$scope.model=value,slidingUpdate&&$timeout.cancel(slidingUpdate),slidingUpdate=$timeout(function(){$scope.$apply()},0)},onChange:function(value){$scope.model=value,$timeout(function(){$scope.$apply()},0)}};if(step){opts.values=[];for(var i=min;max>=i;i+=step)opts.values.push(i)}var slider=new Control.Slider(element.find(".handle")[0],element[0],opts);$scope.$watch("model",function(){slider.setValue($scope.model)})}}}),HashQueueMap.prototype={push:function(key,value){var array=this[key=hashKey(key)];array?array.push(value):this[key]=[value]},shift:function(key){var array=this[key=hashKey(key)];return array?1==array.length?(delete this[key],array[0]):array.shift():void 0},peek:function(key){var array=this[hashKey(key)];return array?array[0]:void 0}};var uid=["0","0","0"];angular.module("lib.loader",[]).factory("Loader",["$q","$interval",function($q,$interval){var Loader={},pres=[];return Loader.loadingCnt=0,Loader.factory=function(loadCallback){var promise,instance={},data={};return instance.load=function(){instance.status="loading",Loader.loadingCnt++;var loadArguments=arguments;return promise=$q.all(pres).then(function(){var loadResult=loadCallback.apply(instance,loadArguments);return loadResult.then?loadResult:$q.all(loadResult)}).then(function(resolved){if(!angular.isObject(resolved)||angular.isArray(resolved))throw new Error("loadCallback resolves into non-object");return angular.extend(data,resolved),data}),promise["finally"](function(){Loader.loadingCnt--,instance.status="ready"}),promise},instance.getPromise=function(){return promise?promise:instance.load()},instance.reset=function(){promise=null},instance.status="await",instance},Loader.registerPre=function(promise){pres.push(promise)},Loader.slowDownArray=function(fieldName,startCnt,initialDelay,delayPerItem,spliceCnt){return function(result){var data=result[fieldName];return spliceCnt=spliceCnt||1,data.length&&(result[fieldName]=data.splice(0,startCnt),data.length&&setTimeout(function(){$interval(function(){for(var splice=data.splice(0,spliceCnt),i=0;i<splice.length;i++)result[fieldName].push(splice[i])},delayPerItem,Math.ceil(data.length/spliceCnt))},initialDelay)),result}},Loader.loading=function(promise){Loader.loadingCnt++,promise["finally"](function(){Loader.loadingCnt--})},Loader}]),angular.module("lib.local-storage",[]).provider("LocalStorage",function(){this.$get=function($rootScope,$parse){var LocalStorage={};return LocalStorage.get=function(key,defValue){var raw=localStorage.getItem(key);if(null!==raw){var value="undefined"==raw?void 0:JSON.parse(raw);return angular.isObject(value)&&_&&_.defaults?_.defaults(value,defValue):value}return defValue},LocalStorage.put=function(key,value){return localStorage.setItem(key,JSON.stringify(value)),value},LocalStorage.remove=function(key){localStorage.removeItem(key)},LocalStorage.removeAll=function(){localStorage.clear()},LocalStorage.sync=function(key,watchedValue,defValue){var value=LocalStorage.get(key,defValue);angular.extend(watchedValue,value),$rootScope.$watch(function(){return watchedValue},function(newValue){LocalStorage.put(key,newValue)},!0)},LocalStorage.syncExp=function(key,scope,exp,defValue){var value=LocalStorage.get(key,defValue),parsed=$parse(exp);parsed.assign(scope,value),scope.$watch(exp,function(newValue){LocalStorage.put(key,newValue)},!0)},LocalStorage.createSyncedObj=function(key,defValue){var obj={};return LocalStorage.sync(key,obj,defValue),obj},LocalStorage}}),angular.module("lib.socket",["lib.api.api"]).factory("Socket",function(LocalConf,$log,$q,Api,Me){var sock=new SockJS(LocalConf.websocketUrl,null,{protocols_whitelist:["websocket","xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile"]}),connectedDefer=$q.defer(),eventObj=$({}),Socket={connected:!1,timeCorrection:0};return sock.onopen=function(){Me?sock.send("auth "+Me.id+":"+Me.one_shot_hash):(connectedDefer.resolve(),Socket.connected=!0)},sock.onmessage=function(e){var m;if("auth ok"==e.data||"auth failed"==e.data)connectedDefer.resolve(),Socket.connected=!0;else if(m=e.data.match(/^time (\d+)$/))Socket.timeCorrection=m[1]-(new Date).getTime();else{var data=JSON.parse(e.data);data[1]&&Api.format(data[1]),Socket.fireEvent(data[0],data[1])}},sock.onclose=function(){Socket.connected=!1},Socket.subscribe=function(channel){connectedDefer.promise.then(function(){sock.send("subscribe "+channel)})},Socket.unsubscribe=function(channel){connectedDefer.promise.then(function(){sock.send("unsubscribe "+channel)})},Socket.on=function(channel,fn){Socket.subscribe(channel),eventObj.bind(channel,fn)},Socket.off=function(channel,fn){Socket.unsubscribe(channel),eventObj.unbind(channel,fn)},Socket.fireEvent=function(eventName,data){var event=$.Event(eventName);event.edata=data,eventObj.trigger(event)},Socket.bindEventToScope=function($scope,eventName,fn,options){options=options||{};var instance={};return instance.listener=function(e){options.noApply?fn(e.edata):$scope.$apply(function(){fn(e.edata)})},instance.remove=function(){instance.listener&&(Socket.off(eventName,instance.listener),instance.listener=null)},Socket.on(eventName,instance.listener),$scope.$on("$destroy",function(){instance.remove()}),instance},Socket}),angular.module("lib.ui.autoresize",[]).constant("msdElasticConfig",{append:""}).directive("appAutoresize",["$timeout","$window","msdElasticConfig",function($timeout,$window,config){return{require:"ngModel",restrict:"A, C",link:function(scope,element,attrs,ngModel){function initMirror(){mirrored=ta,taStyle=getComputedStyle(ta),angular.forEach(copyStyle,function(val){mirrorStyle+=val+":"+taStyle.getPropertyValue(val)+";"}),mirror.setAttribute("style",mirrorStyle)}function adjust(){var taHeight,mirrorHeight,width,overflow;mirrored!==ta&&initMirror(),active||(active=!0,mirror.value=ta.value+append,mirror.style.overflowY=ta.style.overflowY,taHeight=""===ta.style.height?"auto":parseInt(ta.style.height,10),width=parseInt(getComputedStyle(ta).getPropertyValue("width"),10)-boxOuter.width,mirror.style.width=width+"px",mirrorHeight=mirror.scrollHeight,mirrorHeight>maxHeight?(mirrorHeight=maxHeight,overflow="scroll"):minHeight>mirrorHeight&&(mirrorHeight=minHeight),mirrorHeight+=boxOuter.height,ta.style.overflowY=overflow||"hidden",taHeight!==mirrorHeight&&(ta.style.height=mirrorHeight+"px"),$timeout(function(){active=!1},1))}function forceAdjust(){active=!1,adjust()}var ta=element[0],$ta=element;if("TEXTAREA"===ta.nodeName&&$window.getComputedStyle){$ta.css({"word-wrap":"break-word"});var text=ta.value;ta.value="",ta.value=text;var mirrored,active,appendText=attrs.msdElastic||config.append,append="\\n"===appendText?"\n":appendText,$win=angular.element($window),mirrorStyle="position: absolute; top: -999px; right: auto; bottom: auto; left: 0 ;overflow: hidden; -webkit-box-sizing: content-box;-moz-box-sizing: content-box; box-sizing: content-box;min-height: 0 !important; height: 0 !important; padding: 0;word-wrap: break-word; border: 0;",$mirror=angular.element('<textarea tabindex="-1" style="'+mirrorStyle+'"/>').data("elastic",!0),mirror=$mirror[0],taStyle=getComputedStyle(ta),resize=taStyle.getPropertyValue("resize"),borderBox="border-box"===taStyle.getPropertyValue("box-sizing")||"border-box"===taStyle.getPropertyValue("-moz-box-sizing")||"border-box"===taStyle.getPropertyValue("-webkit-box-sizing"),boxOuter=borderBox?{width:parseInt(taStyle.getPropertyValue("border-right-width"),10)+parseInt(taStyle.getPropertyValue("padding-right"),10)+parseInt(taStyle.getPropertyValue("padding-left"),10)+parseInt(taStyle.getPropertyValue("border-left-width"),10),height:parseInt(taStyle.getPropertyValue("border-top-width"),10)+parseInt(taStyle.getPropertyValue("padding-top"),10)+parseInt(taStyle.getPropertyValue("padding-bottom"),10)+parseInt(taStyle.getPropertyValue("border-bottom-width"),10)}:{width:0,height:0},minHeightValue=parseInt(taStyle.getPropertyValue("min-height"),10),heightValue=parseInt(taStyle.getPropertyValue("height"),10),minHeight=Math.max(minHeightValue,heightValue)-boxOuter.height,maxHeight=parseInt(taStyle.getPropertyValue("max-height"),10),copyStyle=["font-family","font-size","font-weight","font-style","letter-spacing","line-height","text-transform","word-spacing","text-indent"];$ta.data("elastic")||(maxHeight=maxHeight&&maxHeight>0?maxHeight:9e4,mirror.parentNode!==document.body&&angular.element(document.body).append(mirror),$ta.css({resize:"none"===resize||"vertical"===resize?"none":"horizontal"}).data("elastic",!0),ta.oninput="onpropertychange"in ta&&"oninput"in ta?ta.onkeyup=adjust:adjust,$win.bind("resize",forceAdjust),scope.$watch(function(){return ngModel.$modelValue},function(){forceAdjust()}),scope.$on("appModelThrottled:update",forceAdjust),scope.$on("$destroy",function(){$mirror.remove(),$win.unbind("resize",forceAdjust)}))}}}}]),angular.module("lib.ui.date",[]).constant("uiDateConfig",{}).directive("uiDate",["uiDateConfig","$timeout",function(uiDateConfig){var options;return options={},angular.extend(options,uiDateConfig),{require:"?ngModel",link:function(scope,element,attrs,controller){var getOptions=function(){return angular.extend({},uiDateConfig,scope.$eval(attrs.uiDate))},initDateWidget=function(){var showing=!1,opts=getOptions();if(controller){var _onSelect=opts.onSelect||angular.noop;opts.onSelect=function(value,picker){scope.$apply(function(){showing=!0,controller.$setViewValue(element.datepicker("getDate")),_onSelect(value,picker),element.blur(),scope.$emit("appDrop.hide")})},opts.beforeShow=function(){showing=!0},opts.onClose=function(){showing=!1},element.on("blur",function(){showing||scope.$apply(function(){element.datepicker("setDate",element.datepicker("getDate")),controller.$setViewValue(element.datepicker("getDate"))})}),controller.$render=function(){var date=controller.$modelValue;if(angular.isDefined(date)&&null!==date&&!angular.isDate(date))throw new Error("ng-Model value must be a Date object - currently it is a "+typeof date+" - use ui-date-format to convert it from a string");element.datepicker("setDate",date)}}element.datepicker("destroy"),element.datepicker(opts),controller&&controller.$render()};scope.$watch(getOptions,initDateWidget,!0)}}}]).constant("uiDateFormatConfig","dd.mm.yy").directive("uiDateFormat",["uiDateFormatConfig",function(uiDateFormatConfig){var directive={require:"ngModel",link:function(scope,element,attrs,modelCtrl){var dateFormat=attrs.uiDateFormat||uiDateFormatConfig;dateFormat?(modelCtrl.$parsers.push(function(value){return angular.isString(value)?jQuery.datepicker.parseDate(dateFormat,value):angular.isDate(value)?value:null}),modelCtrl.$formatters.push(function(value){return value?jQuery.datepicker.formatDate(dateFormat,value):null})):(modelCtrl.$parsers.push(function(value){return angular.isString(value)?new Date(value):null}),modelCtrl.$formatters.push(function(value){return value?value.toISOString():null}))}};return directive}]),function(){function appDropGroupDirective(restrict){return function($timeout){return function($scope,element,attrs,ctrl){$scope.ctrl=ctrl;var className=element[0].className;"E"==restrict&&(element=element.children()),element.addClass(className).attr("tabindex","-1"),$scope.$watch(function(){return ctrl.isOpened&&(!attrs.appAutoclose||$scope.$eval(attrs.appAutoclose))},function(val){val?(element.on("blur.dropdown",function(){$timeout(function(){ctrl.isOpened=!1},10)}),element.focus()):element.off("blur.dropdown")})}}}function appDropBtnDirective($animate){return function($scope,element,attrs,ctrl){element.click(function(){$scope.$apply(function(){ctrl.isOpened=!ctrl.isOpened})}),$scope.$watch(function(){return ctrl.isOpened},function(newVal){$animate[newVal?"addClass":"removeClass"](element,"active")})}}function appDropDirective($animate){return function($scope,element,attrs,ctrl){$scope.$watch(function(){return ctrl.isOpened},function(newVal){$animate[newVal?"removeClass":"addClass"](element,"ng-hide")}),$scope.$on("appDrop.hide",function(){ctrl.isOpened=!1}),element.find("a, button").mousedown(function(event){event.preventDefault()})}}var mod=angular.module("lib.ui.drop",[]);mod.controller("ui:drop",function(){this.isOpened=!1}),mod.directive("appDropGroup",function($injector){return{restrict:"E",controller:"ui:drop",templateUrl:"/views/partials/ui/drop/group.html?bust=1413116880766",transclude:!0,scope:!0,link:$injector.invoke(appDropGroupDirective("E"))}}),mod.directive("appDropGroup",function($injector){return{restrict:"A",controller:"ui:drop",scope:!0,link:$injector.invoke(appDropGroupDirective("A"))}}),mod.directive("appDropBtn",function($injector){return{restrict:"E",require:"^appDropGroup",templateUrl:function(tElement,tAttrs){return"link"==tAttrs.appStyle?"/views/partials/ui/drop/btn-link.html?bust=1413116880766":"/views/partials/ui/drop/btn.html?bust=1413116880766"},replace:!0,transclude:!0,link:$injector.invoke(appDropBtnDirective)}}),mod.directive("appDropBtn",function($injector){return{restrict:"A",require:"^appDropGroup",link:$injector.invoke(appDropBtnDirective)}}),mod.directive("appDrop",function($injector){return{restrict:"E",require:"^appDropGroup",templateUrl:"/views/partials/ui/drop/drop.html?bust=1413116880766",replace:!0,transclude:!0,link:$injector.invoke(appDropDirective)}}),mod.directive("appDrop",function($injector){return{restrict:"A",require:"^appDropGroup",link:$injector.invoke(appDropDirective)}}),mod.directive("appDropItem",function(){return{restrict:"EA",require:"^appDropGroup",templateUrl:"/views/partials/ui/drop/item.html?bust=1413116880766",replace:!0,transclude:!0,link:function($scope,element,attrs,ctrl){element.click(function(){$scope.$apply(function(){ctrl.isOpened=!1})})}}}),mod.directive("appDropDivider",function(){return{restrict:"EA",require:"^appDropGroup",templateUrl:"/views/partials/ui/drop/divider.html?bust=1413116880766",replace:!0}}),mod.directive("appDropSelect",function($sce){return{restrict:"EA",templateUrl:"/views/partials/ui/drop/select.html?bust=1413116880766",scope:{model:"=ngModel",style:"@appStyle",labelPattern:"@appLabelPattern",optionsExp:"&appOptions"},link:function($scope){$scope._=_,$scope.$watch($scope.optionsExp,function(newVal){$scope.options=newVal},!0),$scope.onSelect=function(key){$scope.model=key},$scope.getLabel=function(){var label=_.find(_.pluck($scope.options,$scope.model));return $scope.labelPattern?$sce.trustAsHtml($scope.labelPattern.replace("{}",label)):$sce.trustAsHtml(label)}}}}),mod.directive("appDropClose",function($timeout){return{restrict:"EA",require:"^appDropGroup",link:function($scope,elm,attrs,ctrl){elm.click(function(){$timeout(function(){ctrl.isOpened=!1,$scope.$apply()},0)})}}})}(),angular.module("lib.ui.edit-preview",[]).directive("appEditPreview",function($timeout){return{restrict:"E",templateUrl:"/views/partials/ui/edit-preview.html?bust=1413116880766",scope:{writeModel:"=",markedType:"=",onKeyup:"&",setAutofocus:"="},link:function($scope,elm){$scope.isPreview=!1,$scope.animActive=!1,$scope.onChangePreview=function(isPreview){$scope.animActive=!0,$scope.isPreview=isPreview,$timeout(function(){isPreview?elm.find(".preview").focus():elm.find("textarea").focus()},230)},$scope.setAutofocus&&$timeout(function(){elm.find("textarea").focus()},10),elm.keydown(function(e){13==e.keyCode&&e.shiftKey&&($scope.$apply(function(){$scope.onChangePreview(!$scope.isPreview)}),e.preventDefault()),13==e.keyCode&&e.ctrlKey&&(e.preventDefault(),$(elm.find('input[type="hidden"]').get(0).form).submit())}),$scope.$watch("writeModel.text",function(newVal,oldVal){newVal!=oldVal&&""==newVal&&($scope.isPreview=!1)})}}}),angular.module("lib.ui.jq",[]).constant("JqCfg",{tipsy:{}}).directive("appJq",function(JqCfg){return{controller:function(){},link:function($scope,element,attrs){var match,pluginName=attrs.appJq,regexp=new RegExp("^"+pluginName+"([A-Z].*)$"),params={};if(JqCfg[pluginName]&&(JqCfg[pluginName].$default&&angular.extend(params,JqCfg[pluginName].$default),angular.forEach(element[0].className.split(" "),function(className){JqCfg[pluginName][className]&&angular.extend(params,JqCfg[pluginName][className])})),attrs[pluginName+"Options"])$.extend(params,$scope.$eval(attrs[pluginName+"Options"]));else for(var i in attrs)if(match=regexp.exec(i)){var paramName=match[1].charAt(0).toLowerCase()+match[1].slice(1);params[paramName]=$scope.$eval(attrs[i])}element[pluginName](params)}}}),angular.module("lib.ui.modal",[]).factory("$$stackedMap",function(){return{createNew:function(){var stack=[];return{add:function(key,value){stack.push({key:key,value:value})},get:function(key){for(var i=0;i<stack.length;i++)if(key==stack[i].key)return stack[i]},keys:function(){for(var keys=[],i=0;i<stack.length;i++)keys.push(stack[i].key);return keys},top:function(){return stack[stack.length-1]},remove:function(key){for(var idx=-1,i=0;i<stack.length;i++)if(key==stack[i].key){idx=i;break}return stack.splice(idx,1)[0]},removeTop:function(){return stack.splice(stack.length-1,1)[0]},length:function(){return stack.length}}}}}).directive("modalBackdrop",["$modalStack","$timeout",function($modalStack,$timeout){return{restrict:"EA",replace:!0,templateUrl:"/views/partials/modal/backdrop.html?bust=1413116880766",link:function(scope){$timeout(function(){scope.animate=!0}),scope.close=function(evt){var modal=$modalStack.getTop();modal&&modal.value.backdrop&&"static"!=modal.value.backdrop&&(evt.preventDefault(),evt.stopPropagation(),$modalStack.dismiss(modal.key,"backdrop click"))}}}}]).directive("modalWindow",["$timeout",function($timeout){return{restrict:"EA",scope:{index:"@"},replace:!0,transclude:!0,templateUrl:"/views/partials/modal/window.html?bust=1413116880766",link:function(scope,element,attrs){scope.windowClass=attrs.windowClass||"",$timeout(function(){scope.animate=!0})}}}]).factory("$modalStack",["$document","$compile","$rootScope","$$stackedMap",function($document,$compile,$rootScope,$$stackedMap){function backdropIndex(){for(var topBackdropIndex=-1,opened=openedWindows.keys(),i=0;i<opened.length;i++)openedWindows.get(opened[i]).value.backdrop&&(topBackdropIndex=i);return topBackdropIndex}function removeModalWindow(modalInstance){var modalWindow=openedWindows.get(modalInstance).value;openedWindows.remove(modalInstance),modalWindow.modalDomEl.remove(),backdropDomEl&&-1==backdropIndex()&&(backdropDomEl.remove(),backdropDomEl=void 0),modalWindow.modalScope.$destroy()}var backdropjqLiteEl,backdropDomEl,backdropScope=$rootScope.$new(!0),body=$document.find("body").eq(0),openedWindows=$$stackedMap.createNew(),$modalStack={};return $rootScope.$watch(backdropIndex,function(newBackdropIndex){backdropScope.index=newBackdropIndex}),$document.bind("keydown",function(evt){var modal;27===evt.which&&(modal=openedWindows.top(),modal&&modal.value.keyboard&&$rootScope.$apply(function(){$modalStack.dismiss(modal.key)}))}),$modalStack.open=function(modalInstance,modal){openedWindows.add(modalInstance,{deferred:modal.deferred,modalScope:modal.scope,backdrop:modal.backdrop,keyboard:modal.keyboard});var angularDomEl=angular.element("<div modal-window></div>");angularDomEl.attr("window-class",modal.windowClass),angularDomEl.attr("index",openedWindows.length()-1),angularDomEl.html(modal.content);var modalDomEl=$compile(angularDomEl)(modal.scope);openedWindows.top().value.modalDomEl=modalDomEl,body.append(modalDomEl),backdropIndex()>=0&&!backdropDomEl&&(backdropjqLiteEl=angular.element("<div modal-backdrop></div>"),backdropDomEl=$compile(backdropjqLiteEl)(backdropScope),body.append(backdropDomEl))},$modalStack.close=function(modalInstance,result){var modal=openedWindows.get(modalInstance);modal&&(modal.value.deferred.resolve(result),removeModalWindow(modalInstance))},$modalStack.dismiss=function(modalInstance,reason){var modalWindow=openedWindows.get(modalInstance).value;modalWindow&&(modalWindow.deferred.reject(reason),removeModalWindow(modalInstance))},$modalStack.getTop=function(){return openedWindows.top()},$modalStack}]).provider("$modal",function(){var $modalProvider={options:{backdrop:!0,keyboard:!0},$get:["$injector","$rootScope","$q","$http","$templateCache","$controller","$modalStack","$animate","$timeout",function($injector,$rootScope,$q,$http,$templateCache,$controller,$modalStack,$animate,$timeout){function getTemplatePromise(options){return options.template?$q.when(options.template):$http.get(options.templateUrl,{cache:$templateCache}).then(function(result){return result.data})}function getResolvePromises(resolves){var promisesArr=[];return angular.forEach(resolves,function(value){(angular.isFunction(value)||angular.isArray(value))&&promisesArr.push($q.when($injector.invoke(value)))}),promisesArr}var $modal={};return $modal.open=function(modalOptions){$animate.enabled(!1);var modalResultDeferred=$q.defer(),modalOpenedDeferred=$q.defer(),modalInstance={result:modalResultDeferred.promise,opened:modalOpenedDeferred.promise,close:function(result){$modalStack.close(modalInstance,result)},dismiss:function(reason){$modalStack.dismiss(modalInstance,reason)}};if(modalOptions=angular.extend({},$modalProvider.options,modalOptions),modalOptions.resolve=modalOptions.resolve||{},!modalOptions.template&&!modalOptions.templateUrl)throw new Error("One of template or templateUrl options is required.");var templateAndResolvePromise=$q.all([getTemplatePromise(modalOptions)].concat(getResolvePromises(modalOptions.resolve)));return templateAndResolvePromise.then(function(tplAndVars){var modalScope=(modalOptions.scope||$rootScope).$new();modalScope.$close=modalInstance.close,modalScope.$dismiss=modalInstance.dismiss;var ctrlInstance,ctrlLocals={},resolveIter=1;modalOptions.controller&&(ctrlLocals.$scope=modalScope,ctrlLocals.$modalInstance=modalInstance,angular.forEach(modalOptions.resolve,function(value,key){ctrlLocals[key]=tplAndVars[resolveIter++]
}),ctrlInstance=$controller(modalOptions.controller,ctrlLocals)),$modalStack.open(modalInstance,{scope:modalScope,deferred:modalResultDeferred,content:tplAndVars[0],backdrop:modalOptions.backdrop,keyboard:modalOptions.keyboard,windowClass:modalOptions.windowClass}),$timeout(function(){$animate.enabled(!0)},350)},function(reason){modalResultDeferred.reject(reason)}),templateAndResolvePromise.then(function(){modalOpenedDeferred.resolve(!0)},function(){modalOpenedDeferred.reject(!1)}),modalInstance},$modal}]};return $modalProvider}),angular.module("lib.ui.modal2",[]).factory("$$stackedMap",function(){return{createNew:function(){var stack=[];return{add:function(key,value){stack.push({key:key,value:value})},get:function(key){for(var i=0;i<stack.length;i++)if(key==stack[i].key)return stack[i]},keys:function(){for(var keys=[],i=0;i<stack.length;i++)keys.push(stack[i].key);return keys},top:function(){return stack[stack.length-1]},remove:function(key){for(var idx=-1,i=0;i<stack.length;i++)if(key==stack[i].key){idx=i;break}return stack.splice(idx,1)[0]},removeTop:function(){return stack.splice(stack.length-1,1)[0]},length:function(){return stack.length}}}}}).directive("modal2Backdrop",["$modal2Stack","$timeout",function($modalStack,$timeout){return{restrict:"EA",replace:!0,templateUrl:"/views/partials/modal2/backdrop.html?bust=1413116880766",transclude:!0,link:function(scope){$timeout(function(){scope.animate=!0}),scope.close=function(evt){var modal=$modalStack.getTop();modal&&modal.value.backdrop&&"static"!=modal.value.backdrop&&(evt.preventDefault(),evt.stopPropagation(),$modalStack.dismiss(modal.key,"backdrop click"))}}}}]).directive("modal2Window",["$timeout","$modal2Stack",function($timeout,$modalStack){return{restrict:"EA",scope:{index:"@"},replace:!0,transclude:!0,templateUrl:"/views/partials/modal2/window.html?bust=1413116880766",link:function(scope,element,attrs){scope.windowClass=attrs.windowClass||"",$timeout(function(){scope.animate=!0}),scope.close=function(evt){var modal=$modalStack.getTop();modal&&modal.value.backdrop&&"static"!=modal.value.backdrop&&(evt.preventDefault(),evt.stopPropagation(),$modalStack.dismiss(modal.key,"backdrop click"))}}}}]).factory("$modal2Stack",["$document","$compile","$rootScope","$$stackedMap",function($document,$compile,$rootScope,$$stackedMap){function backdropIndex(){for(var topBackdropIndex=-1,opened=openedWindows.keys(),i=0;i<opened.length;i++)openedWindows.get(opened[i]).value.backdrop&&(topBackdropIndex=i);return topBackdropIndex}function removeModalWindow(modalInstance){var modalWindow=openedWindows.get(modalInstance).value;openedWindows.remove(modalInstance),modalWindow.modalDomEl.remove(),backdropDomEl&&-1==backdropIndex()&&(backdropDomEl.remove(),backdropDomEl=void 0),modalWindow.modalScope.$destroy()}var backdropjqLiteEl,backdropDomEl,backdropScope=$rootScope.$new(!0),body=$document.find("body").eq(0),openedWindows=$$stackedMap.createNew(),$modalStack={};return $rootScope.$watch(backdropIndex,function(newBackdropIndex){backdropScope.index=newBackdropIndex}),$document.bind("keydown",function(evt){var modal;27===evt.which&&(modal=openedWindows.top(),modal&&modal.value.keyboard&&$rootScope.$apply(function(){$modalStack.dismiss(modal.key)}))}),$modalStack.open=function(modalInstance,modal){openedWindows.add(modalInstance,{deferred:modal.deferred,modalScope:modal.scope,backdrop:modal.backdrop,keyboard:modal.keyboard}),$(body).addClass("modal2-open");var angularDomEl=angular.element("<div modal2-window></div>");angularDomEl.attr("window-class",modal.windowClass),angularDomEl.attr("index",openedWindows.length()-1),angularDomEl.html(modal.content),angularDomEl.show();var modalDomEl=$compile(angularDomEl)(modal.scope);openedWindows.top().value.modalDomEl=modalDomEl,body.append(modalDomEl),modal.autofocus&&setTimeout(function(){angularDomEl.attr("tabindex","-1"),angularDomEl.focus()},200),backdropIndex()>=0&&!backdropDomEl&&(backdropjqLiteEl=angular.element("<div modal2-backdrop></div>"),backdropDomEl=$compile(backdropjqLiteEl)(backdropScope),body.append(backdropDomEl))},$modalStack.close=function(modalInstance,result){$(body).removeClass("modal2-open");var modal=openedWindows.get(modalInstance);modal&&modal.value&&(modal.value.deferred.resolve(result),removeModalWindow(modalInstance))},$modalStack.dismiss=function(modalInstance,reason){$(body).removeClass("modal2-open");var modal=openedWindows.get(modalInstance);modal&&modal.value&&(modal.value.deferred.reject(reason),removeModalWindow(modalInstance))},$modalStack.getTop=function(){return openedWindows.top()},$modalStack}]).provider("$modal2",function(){var $modalProvider={options:{backdrop:!0,keyboard:!0,autofocus:!0},$get:["$injector","$rootScope","$q","$http","$templateCache","$controller","$modal2Stack","$animate","$timeout",function($injector,$rootScope,$q,$http,$templateCache,$controller,$modalStack,$animate,$timeout){function getTemplatePromise(options){return options.template?$q.when(options.template):$http.get(options.templateUrl,{cache:$templateCache}).then(function(result){return result.data})}function getResolvePromises(resolves){var promisesArr=[];return angular.forEach(resolves,function(value){(angular.isFunction(value)||angular.isArray(value))&&promisesArr.push($q.when($injector.invoke(value)))}),promisesArr}var $modal={};return $modal.open=function(modalOptions){$animate.enabled(!1);var modalResultDeferred=$q.defer(),modalOpenedDeferred=$q.defer(),modalInstance={result:modalResultDeferred.promise,opened:modalOpenedDeferred.promise,close:function(result){$modalStack.close(modalInstance,result)},dismiss:function(reason){$modalStack.dismiss(modalInstance,reason)}};if(modalOptions=angular.extend({},$modalProvider.options,modalOptions),modalOptions.resolve=modalOptions.resolve||{},!modalOptions.template&&!modalOptions.templateUrl)throw new Error("One of template or templateUrl options is required.");var templateAndResolvePromise=$q.all([getTemplatePromise(modalOptions)].concat(getResolvePromises(modalOptions.resolve)));return templateAndResolvePromise.then(function(tplAndVars){var modalScope=(modalOptions.scope||$rootScope).$new();modalScope.$close=modalInstance.close,modalScope.$dismiss=modalInstance.dismiss;var ctrlInstance,ctrlLocals={},resolveIter=1;modalOptions.controller&&(ctrlLocals.$scope=modalScope,ctrlLocals.$modalInstance=modalInstance,angular.forEach(modalOptions.resolve,function(value,key){ctrlLocals[key]=tplAndVars[resolveIter++]}),ctrlInstance=$controller(modalOptions.controller,ctrlLocals)),$modalStack.open(modalInstance,{scope:modalScope,deferred:modalResultDeferred,content:tplAndVars[0],backdrop:modalOptions.backdrop,keyboard:modalOptions.keyboard,windowClass:modalOptions.windowClass,autofocus:modalOptions.autofocus}),$timeout(function(){$animate.enabled(!0)},350)},function(reason){modalResultDeferred.reject(reason)}),templateAndResolvePromise.then(function(){modalOpenedDeferred.resolve(!0)},function(){modalOpenedDeferred.reject(!1)}),modalInstance},$modal}]};return $modalProvider}),angular.module("lib.ui.popover",[]).directive("appPopover",function(){return{restrict:"A",controller:function(){this.isHovered=!1},link:function($scope,elm,attrs,ctrl){elm.hover(function(){$scope.$apply(function(){ctrl.isHovered=!0})},function(){$scope.$apply(function(){ctrl.isHovered=!1})})}}}).directive("appPopover",function($timeout){return{restrict:"E",require:"^appPopover",templateUrl:"/views/partials/ui/popover.html?bust=1413116880766",transclude:!0,link:function($scope,elm,attrs,ctrl){$scope.ctrl=ctrl,$scope.$watch("ctrl.isHovered",function(val){$scope.visible=!1,val&&($scope.position="bottom",$timeout(function(){var content=elm.find(".popover-content");content.length&&($scope.position=content.height()+content.offset().top+30>$(window).scrollTop()+$(window).height()?"top":"bottom",$scope.visible=!0)},10))})}}}),angular.module("lib.ui.smilies",[]).factory("Smilies",function(){var Smilies={};return Smilies.codes=[{smile:/(:-\)|:\)|:smile:)/g},{biggrin:/(:-D|:D|:biggrin:)/g},{angry:/:angry:/g},{blink:/(oO|Oo|o_O|O_o|оО|Оо|о_О|О_о|:blink:)/g},{blush:/:blush:/g},{cool:/(8\)|:cool:)/g},{dry:/:dry:/g},{excl:/:excl:/g},{happy:/(\^\^|\^_\^|:happy:)/g},{huh:/:huh:/g},{laugh:/:laugh:/g},{mellow:/:mellow:/g},{ohmy:/:ohmy:/g},{ph34r:/:ph34r:/g},{rolleyes:/:rolleyes:/g},{sad:/(:\(|:-\(|:sad:)/g},{sleep:/:sleep:/g},{tongue:/(:P|:-P|:Р|:-Р|:tongue:)/g},{unsure:/:unsure:/g},{wacko:/:wacko:/g},{wink:/(;\)|;-\)|:wink:)/g},{wub:/:wub:/g},{first:/:first:/g},{second:/:second:/g},{third:/:third:/g},{power:/:power:/g},{badcomp:/:badcomp:/g},{complaugh:/:complaugh:/g},{girlnotebook:/:girlnotebook:/g},{crazy:/:crazy:/g},{boredom:/:boredom:/g},{cry:/:cry:/g},{bye:/:bye:/g},{dance:/:dance:/g},{gamer:/:gamer:/g},{rofl:/:rofl:/g},{beer:/:beer:/g},{kidtruck:/:kidtruck:/g},{angry2:/:angry2:/g},{spiteful:/:spiteful:/g},{sorry:/:sorry:/g},{boykiss:/:boykiss:/g},{girlkiss:/(:girlkiss:|:\*|:-\*)/g},{kissed:/:kissed:/g},{yes:/:yes:/g},{no:/:no:/g},{hi:/:hi:/g},{ok:/:ok:/g}],Smilies.parse=function(val){for(var i=0;i<Smilies.codes.length;i++){var key=_.findKey(Smilies.codes[i]);val=val.replace(Smilies.codes[i][key],'<img class=smile src="/img/smilies/'+key+'.gif" alt=":'+key+':" title=":'+key+':">')}return val},Smilies}).filter("smilies",function($sce,Smilies){return function(val){return _.isObject(val)&&val.$$unwrapTrustedValue&&(val=val.$$unwrapTrustedValue()),val=Smilies.parse(val),$sce.trustAsHtml(val)}}).directive("appSmiliesInsert",function($compile,$timeout){return{controller:function($scope,$element){this.isOpened=!1,this.insert=function(code){var textarea=$element.find("textarea")[0];$timeout(function(){var text=":"+code+":";if(textarea.selectionStart||"0"==textarea.selectionStart){var startPos=textarea.selectionStart;textarea.value=textarea.value.substring(0,startPos)+text+textarea.value.substring(startPos,textarea.value.length),textarea.selectionStart+=text.length}else textarea.value+=text;$(textarea).change().focus()},0)}},link:function($scope,elm){var btn=angular.element("<button app:smilies-insert-btn></button>");$compile(btn)($scope),elm.append(btn);var dlg=angular.element("<div app:smilies-insert-dlg></div>");$compile(dlg)($scope),elm.append(dlg)}}}).directive("appSmiliesInsertBtn",function(){return{require:"^appSmiliesInsert",templateUrl:"/views/partials/ui/smilies/btn.html?bust=1413116880766",replace:!0,link:function($scope,elm,attrs,ctrl){$scope.onClick=function(event){event.preventDefault(),ctrl.isOpened=!0},$scope.onBlur=function(){ctrl.isOpened=!1}}}}).directive("appSmiliesInsertDlg",function(Smilies){return{require:"^appSmiliesInsert",templateUrl:"/views/partials/ui/smilies/dlg.html?bust=1413116880766",link:function($scope,elm,attrs,ctrl){$scope._=_,$scope.ctrl=ctrl,$scope.codes=Smilies.codes,$scope.onClickSmile=function(code){ctrl.insert(code),ctrl.isOpened=!1},$scope.onMousedownSmile=function(event){event.preventDefault()}}}}),angular.module("lib.user-cache",[]).factory("UserCache",function(Me,$parse){function cacheItem(item){return cache[item.id]||(cache[item.id]={checkVisitorPermission:function(prefName,isFriend){var pref=$parse(prefName)(this.public_prefs);return"all"==pref?!0:"friends"==pref&&(isFriend||Me&&Me.id==this.id)?!0:"none"==pref&&Me&&Me.id==this.id?!0:!1}}),_.extend(cache[item.id],item)}function cacheObjectArray(arr){if(_.isArray(arr))for(var i in arr)arr[i]=cacheItem(arr[i]);else for(var i=0;i<arr.length;i++)arr[i]=cacheItem(arr[i])}var UserCache={},cache={};return UserCache.thru=function(response){return response?(response.users&&cacheObjectArray(response.users),response.user&&(response.user=cacheItem(response.user)),response):response},UserCache.thruArray=function(arr){arr&&cacheObjectArray(arr)},UserCache}),angular.module("lib.utils",[]).factory("Datificator",function(){var Datificator={};return Datificator.transform=function(val){if(angular.isObject(val)&&val.sec){var timestamp=1e3*val.sec;return val.usec&&(timestamp+=val.usec/1e3),new Date(timestamp)}return new Date(val)},Datificator.recurse=function(obj){for(var i in obj)angular.isObject(obj[i])&&!obj[i].sec||angular.isArray(obj[i])?Datificator.recurse(obj[i]):angular.isObject(obj[i])&&obj[i].sec&&(obj[i]=Datificator.transform(obj[i]))},Datificator}).factory("Dedollarizer",function(){var Dedollarizer={};return Dedollarizer.recurse=function(obj){for(var i in obj)angular.isObject(obj[i])&&!obj[i].$id||angular.isArray(obj[i])?Dedollarizer.recurse(obj[i]):angular.isObject(obj[i])&&obj[i].$id&&(obj[i]=obj[i].$id)},Dedollarizer}),angular.module("local-conf",[]).constant("LocalConf",{websocketUrl:"http://klavogonki.ru/ws",amazonBucket:"img.klavogonki.ru"}),angular.module("ngLocale",[],["$provide",function($provide){var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:{0:"до полудня",1:"после полудня"},DAY:{0:"воскресенье",1:"понедельник",2:"вторник",3:"среда",4:"четверг",5:"пятница",6:"суббота"},MONTH:{0:"января",1:"февраля",2:"марта",3:"апреля",4:"мая",5:"июня",6:"июля",7:"августа",8:"сентября",9:"октября",10:"ноября",11:"декабря"},SHORTDAY:{0:"вс",1:"пн",2:"вт",3:"ср",4:"чт",5:"пт",6:"сб"},SHORTMONTH:{0:"янв.",1:"февр.",2:"марта",3:"апр.",4:"мая",5:"июня",6:"июля",7:"авг.",8:"сент.",9:"окт.",10:"нояб.",11:"дек."},fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"dd.MM.yyyy H:mm:ss",mediumDate:"dd.MM.yyyy",mediumTime:"H:mm:ss","short":"dd.MM.yy H:mm",shortDate:"dd.MM.yy",shortTime:"H:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"<span class='rub'>Р</span>",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:{0:{gSize:3,lgSize:3,macFrac:0,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},1:{gSize:3,lgSize:3,macFrac:0,maxFrac:2,minFrac:0,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}}},id:"ru-ru",pluralCat:function(n){return 1==n%10&&11!=n%100?PLURAL_CATEGORY.ONE:n==(0|n)&&n%10>=2&&4>=n%10&&(12>n%100||n%100>14)?PLURAL_CATEGORY.FEW:0==n%10||n==(0|n)&&n%10>=5&&9>=n%10||n==(0|n)&&n%100>=11&&14>=n%100?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.MANY},plural:function(n,one,few,many){return{one:one,few:few,many:many}[this.pluralCat(n)].replace("{}",n)}})}]),function(angular){var mod=angular.module("route-segment",[]);mod.provider("$routeSegment",["$routeProvider",function($routeProvider){function camelCase(name){return name.replace(/([\:\-\_]+(.))/g,function(_,separator,letter,offset){return offset?letter.toUpperCase():letter})}function pointer(segment,parent){if(!segment)throw new Error("Invalid pointer segment");var lastAddedName;return{segment:function(name,params){return segment[camelCase(name)]={params:params},lastAddedName=name,this},within:function(childName){var child;if(childName=childName||lastAddedName,child=segment[camelCase(childName)])void 0==child.children&&(child.children={});else{if(options.strictMode)throw new Error("Cannot get into unknown `"+childName+"` segment");child=segment[camelCase(childName)]={params:{},children:{}}}return pointer(child.children,this)},up:function(){return parent},root:function(){return rootPointer}}}var $routeSegmentProvider=this,options=$routeSegmentProvider.options={autoLoadTemplates:!0,strictMode:!1},segments=this.segments={},rootPointer=pointer(segments,null),segmentRoutes={};$routeSegmentProvider.when=function(route,name){return $routeProvider.when(route,{segment:name}),segmentRoutes[name]=route,this},angular.extend($routeSegmentProvider,rootPointer),this.$get=["$rootScope","$q","$http","$templateCache","$route","$routeParams","$injector",function($rootScope,$q,$http,$templateCache,$route,$routeParams,$injector){function isDependenciesChanged(segment){var result=!1;return segment.params.dependencies&&angular.forEach(segment.params.dependencies,function(name){angular.equals($routeSegment.$routeParams[name],$routeParams[name])||(result=!0)}),result}function updateSegment(index,segment){return $routeSegment.chain[index]&&$routeSegment.chain[index].clearWatcher&&$routeSegment.chain[index].clearWatcher(),segment?(resolvingSemaphoreChain[index]=segment.name,segment.params.untilResolved?resolve(index,segment.name,segment.params.untilResolved).then(function(result){return void 0!=result.success&&broadcast(index),resolve(index,segment.name,segment.params)}):resolve(index,segment.name,segment.params)):(resolvingSemaphoreChain[index]=null,broadcast(index),void 0)}function resolve(index,name,params){var locals=angular.extend({},params.resolve);return angular.forEach(locals,function(value,key){locals[key]=angular.isString(value)?$injector.get(value):$injector.invoke(value)}),params.template&&(locals.$template=params.template,angular.isFunction(locals.$template)&&(locals.$template=$injector.invoke(locals.$template))),options.autoLoadTemplates&&params.templateUrl&&(locals.$template=params.templateUrl,angular.isFunction(locals.$template)&&(locals.$template=$injector.invoke(locals.$template)),locals.$template=$http.get(locals.$template,{cache:$templateCache}).then(function(response){return response.data})),$q.all(locals).then(function(resolvedLocals){if(resolvingSemaphoreChain[index]!=name)return $q.reject();if($routeSegment.chain[index]={name:name,params:params,locals:resolvedLocals,reload:function(){var originalSegment=getSegmentInChain(index,$routeSegment.name.split("."));updateSegment(index,originalSegment).then(function(result){void 0!=result.success&&broadcast(index)})}},params.watcher){var getWatcherValue=function(){if(!angular.isFunction(params.watcher))throw new Error("Watcher is not a function in segment `"+name+"`");return $injector.invoke(params.watcher,{},{segment:$routeSegment.chain[index]})},lastWatcherValue=getWatcherValue();$routeSegment.chain[index].clearWatcher=$rootScope.$watch(getWatcherValue,function(value){value!=lastWatcherValue&&(lastWatcherValue=value,$routeSegment.chain[index].reload())})}return{success:index}},function(error){if(params.resolveFailed){var newResolve={error:function(){return $q.when(error)}};return resolve(index,name,angular.extend({resolve:newResolve},params.resolveFailed))}throw new Error("Resolving failed with a reason `"+error+"`, but no `resolveFailed` "+"provided for segment `"+name+"`")})}function broadcast(index){$routeSegment.$routeParams=angular.copy($routeParams),$routeSegment.name="";for(var i=0;i<$routeSegment.chain.length;i++)$routeSegment.chain[i]&&($routeSegment.name+=$routeSegment.chain[i].name+".");$routeSegment.name=$routeSegment.name.substr(0,$routeSegment.name.length-1),$rootScope.$broadcast("routeSegmentChange",{index:index,segment:$routeSegment.chain[index]||null})}function getSegmentInChain(segmentIdx,segmentNameChain){if(!segmentNameChain)return null;if(segmentIdx>=segmentNameChain.length)return null;for(var nextName,curSegment=segments,i=0;segmentIdx>=i;i++)nextName=segmentNameChain[i],void 0!=curSegment[camelCase(nextName)]&&(curSegment=curSegment[camelCase(nextName)]),segmentIdx>i&&(curSegment=curSegment.children);return{name:nextName,params:curSegment.params,children:curSegment.children}}var $routeSegment={name:"",$routeParams:angular.copy($routeParams),chain:[],startsWith:function(val){var regexp=new RegExp("^"+val);return regexp.test($routeSegment.name)},contains:function(val){for(var i=0;i<this.chain.length;i++)if(this.chain[i]&&this.chain[i].name==val)return!0;return!1},getSegmentUrl:function(segmentName,routeParams){var url,i,m;if(!segmentRoutes[segmentName])throw new Error("Can not get URL for segment with name `"+segmentName+"`");routeParams=angular.extend({},$routeParams,routeParams||{}),url=segmentRoutes[segmentName];for(i in routeParams){var regexp=new RegExp(":"+i+"[*?]?","g");url=url.replace(regexp,routeParams[i])}if(url=url.replace(/\/\:.*?\?/g,""),m=url.match(/\/\:([^\/]*)/))throw new Error("Route param `"+m[1]+"` is not specified for route `"+segmentRoutes[segmentName]+"`");return url}},resolvingSemaphoreChain={};return $rootScope.$on("$routeChangeSuccess",function(event,args){var route=args.$route||args.$$route;if(route&&route.segment){for(var segmentName=route.segment,segmentNameChain=segmentName.split("."),updates=[],lastUpdateIndex=-1,i=0;i<segmentNameChain.length;i++){var newSegment=getSegmentInChain(i,segmentNameChain);(resolvingSemaphoreChain[i]!=newSegment.name||updates.length>0||isDependenciesChanged(newSegment))&&($routeSegment.chain[i]&&$routeSegment.chain[i].name==newSegment.name&&0==updates.length&&!isDependenciesChanged(newSegment)?resolvingSemaphoreChain[i]=newSegment.name:(updates.push({index:i,newSegment:newSegment}),lastUpdateIndex=i))}var curSegmentPromise=$q.when();if(updates.length>0)for(var i=0;i<updates.length;i++)!function(i){curSegmentPromise=curSegmentPromise.then(function(){return updateSegment(updates[i].index,updates[i].newSegment)}).then(function(result){if(void 0!=result.success){broadcast(result.success);for(var j=updates[i].index+1;j<$routeSegment.chain.length;j++)$routeSegment.chain[j]&&($routeSegment.chain[j]=null,updateSegment(j,null))}})}(i);curSegmentPromise.then(function(){if($routeSegment.chain.length>segmentNameChain.length){var oldLength=$routeSegment.chain.length,shortenBy=$routeSegment.chain.length-segmentNameChain.length;$routeSegment.chain.splice(-shortenBy,shortenBy);for(var i=segmentNameChain.length;oldLength>i;i++)updateSegment(i,null),lastUpdateIndex=$routeSegment.chain.length-1}}).then(function(){var defaultChildUpdatePromise=$q.when();if(lastUpdateIndex==$routeSegment.chain.length-1)for(var curSegment=getSegmentInChain(lastUpdateIndex,$routeSegment.name.split("."));curSegment;){var children=curSegment.children,index=lastUpdateIndex+1;curSegment=null;for(var i in children)!function(i,children,index){children[i].params.default&&(defaultChildUpdatePromise=defaultChildUpdatePromise.then(function(){return updateSegment(index,{name:i,params:children[i].params}).then(function(result){result.success&&broadcast(result.success)})}),curSegment=children[i],lastUpdateIndex=index)}(i,children,index)}return defaultChildUpdatePromise})}}),$routeSegment}]}]),mod.filter("routeSegmentUrl",["$routeSegment",function($routeSegment){return function(segmentName,params){return $routeSegment.getSegmentUrl(segmentName,params)}}]),mod.filter("routeSegmentEqualsTo",["$routeSegment",function($routeSegment){return function(value){return $routeSegment.name==value}}]),mod.filter("routeSegmentStartsWith",["$routeSegment",function($routeSegment){return function(value){return $routeSegment.startsWith(value)}}]),mod.filter("routeSegmentContains",["$routeSegment",function($routeSegment){return function(value){return $routeSegment.contains(value)}}]),mod.filter("routeSegmentParam",["$routeSegment",function($routeSegment){return function(value){return $routeSegment.$routeParams[value]}}])}(angular),function(angular){angular.module("view-segment",["route-segment"]).directive("appViewSegment",["$route","$compile","$controller","$routeParams","$routeSegment","$q","$injector","$timeout",function($route,$compile,$controller,$routeParams,$routeSegment,$q,$injector,$timeout){return{restrict:"ECA",priority:500,compile:function(tElement,tAttrs){var defaultContent=tElement.html(),isDefault=!0,anchor=angular.element(document.createComment(" view-segment "));return tElement.prepend(anchor),function($scope){function clearContent(){currentElement&&(animate.leave(currentElement),currentElement=null),currentScope&&(currentScope.$destroy(),currentScope=null)}function update(segment){if(currentSegment=segment,isDefault&&(isDefault=!1,tElement.replaceWith(anchor)),!segment)return clearContent(),currentElement=tElement.clone(),currentElement.html(defaultContent),animate.enter(currentElement,null,anchor),$compile(currentElement,!1,499)($scope),void 0;var locals=angular.extend({},segment.locals),template=locals&&locals.$template;clearContent(),currentElement=tElement.clone(),currentElement.html(template?template:defaultContent),animate.enter(currentElement,null,anchor);var controller,link=$compile(currentElement,!1,499);currentScope=$scope.$new(),segment.params.controller&&(locals.$scope=currentScope,controller=$controller(segment.params.controller,locals),segment.params.controllerAs&&(currentScope[segment.params.controllerAs]=controller),currentElement.data("$ngControllerController",controller),currentElement.children().data("$ngControllerController",controller)),link(currentScope),currentScope.$emit("$viewContentLoaded"),currentScope.$eval(onloadExp)}var currentScope,currentElement,currentSegment,animate,updatePromise,onloadExp=tAttrs.onload||"",viewSegmentIndex=parseInt(tAttrs.appViewSegment);try{var $animator=$injector.get("$animator");animate=$animator($scope,tAttrs)}catch(e){}try{animate=$injector.get("$animate")}catch(e){}$routeSegment.chain[viewSegmentIndex]&&(updatePromise=$timeout(function(){update($routeSegment.chain[viewSegmentIndex])},0)),$scope.$on("routeSegmentChange",function(event,args){updatePromise&&$timeout.cancel(updatePromise),args.index==viewSegmentIndex&&currentSegment!=args.segment&&update(args.segment)})}}}}])}(angular)}(jQuery,$,$$);